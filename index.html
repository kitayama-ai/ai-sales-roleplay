<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AIå–¶æ¥­ãƒ­ãƒ¼ãƒ—ãƒ¬</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">
<script>
tailwind.config = {
  important: '#screen-results',
  corePlugins: { preflight: false },
  theme: {
    extend: {
      colors: {
        "primary": "#137fec",
        "background-light": "#f6f7f8",
      },
      fontFamily: {
        "display": ["Inter", "Noto Sans JP", "sans-serif"]
      },
      borderRadius: {"DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px"},
    },
  },
}
</script>
<style>
.material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
.filled { font-variation-settings: 'FILL' 1; }
</style>
<style>
/* === CSS CUSTOM PROPERTIES === */
:root {
  --bg: #f8f9fa;
  --surface: #ffffff;
  --surface2: #f1f3f4;
  --surface3: #e8eaed;
  --border: #dadce0;
  --border-light: #e8eaed;
  --accent: #1a73e8;
  --accent2: #7c3aed;
  --green: #1e8e3e;
  --red: #ea4335;
  --gold: #f9ab00;
  --warm: #ff6b35;
  --text: #202124;
  --text2: #5f6368;
  --text3: #80868b;
  --radius: 12px;
  --radius-lg: 16px;
  --radius-xl: 20px;
  --shadow-sm: 0 1px 3px rgba(60,64,67,.15);
  --shadow-md: 0 4px 16px rgba(60,64,67,.15);
  --shadow-lg: 0 12px 40px rgba(60,64,67,.2);

  /* Google Meet palette (light) */
  --call-bg: #f8f9fa;
  --call-surface: #ffffff;
  --call-surface2: #f1f3f4;
  --call-border: #dadce0;
  --call-text: #202124;
  --call-text2: #5f6368;
  --call-red: #ea4335;
  --call-green: #1e8e3e;
  --call-blue: #1a73e8;

  /* Dark stage (video area only) */
  --stage-bg: #202124;
  --stage-surface: #3c4043;
  --stage-text: #e8eaed;
  --stage-text2: #9aa0a6;
}

* { box-sizing: border-box; margin: 0; padding: 0 }
body {
  background: var(--call-bg);
  color: var(--call-text);
  font-family: 'Google Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans JP', sans-serif;
  min-height: 100vh;
  min-height: 100dvh;
  overflow: hidden;
}

/* === SCREEN MANAGEMENT === */
.screen { display: none; height: 100vh; height: 100dvh }
.screen.active { display: flex }

/* ============================================= */
/* === LOBBY SCREEN (Pre-join)               === */
/* ============================================= */
#screen-lobby {
  flex-direction: column;
  background: var(--bg);
  align-items: center;
  justify-content: center;
}

.lobby-header {
  position: absolute;
  top: 0; left: 0; right: 0;
  padding: 16px 24px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.lobby-logo {
  font-size: 18px;
  font-weight: 700;
  color: var(--text);
  display: flex;
  align-items: center;
  gap: 8px;
}
.lobby-logo span { opacity: .5; font-weight: 400; font-size: 14px }
.lobby-header-actions { display: flex; gap: 8px }
.lobby-header-btn {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text2);
  border-radius: 24px;
  padding: 8px 16px;
  font-size: 13px;
  cursor: pointer;
  transition: background .15s;
  font-family: inherit;
}
.lobby-header-btn:hover { background: var(--surface2) }

.lobby-container {
  display: grid;
  grid-template-columns: 1.2fr 380px;
  gap: 32px;
  max-width: 960px;
  width: 92%;
  align-items: center;
}

/* Camera preview card */
.lobby-preview {
  background: var(--stage-bg);
  border-radius: 12px;
  aspect-ratio: 16/10;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  position: relative;
  overflow: hidden;
}
.lobby-preview-bg {
  position: absolute;
  inset: 0;
  background: radial-gradient(ellipse at center, rgba(255,255,255,.03) 0%, transparent 70%);
}
.lobby-avatar {
  width: 96px;
  height: 96px;
  border-radius: 50%;
  background: linear-gradient(135deg, #5c6bc0, #7c4dff);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 40px;
  z-index: 1;
  margin-bottom: 12px;
}
.lobby-user-name {
  font-size: 16px;
  font-weight: 600;
  color: var(--stage-text);
  z-index: 1;
  min-height: 24px;
}
.lobby-mic-test {
  z-index: 1;
  margin-top: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
  color: var(--stage-text2);
}
.lobby-mic-bar {
  width: 120px;
  height: 4px;
  background: var(--stage-surface);
  border-radius: 2px;
  overflow: hidden;
}
.lobby-mic-fill {
  height: 100%;
  width: 0%;
  background: var(--call-green);
  border-radius: 2px;
  transition: width .05s;
}

/* Preview bottom buttons */
.lobby-preview-controls {
  position: absolute;
  bottom: 16px;
  display: flex;
  gap: 12px;
  z-index: 1;
}
.preview-ctrl-btn {
  width: 44px; height: 44px;
  border-radius: 50%;
  border: none;
  background: var(--stage-surface);
  color: var(--stage-text);
  font-size: 18px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background .15s;
}
.preview-ctrl-btn:hover { background: #5f6368 }
.preview-ctrl-btn.muted { background: var(--call-red); color: #fff }

/* Settings panel */
.lobby-settings {
  background: var(--surface);
  border-radius: 12px;
  padding: 24px;
  display: flex;
  flex-direction: column;
  gap: 16px;
  max-height: 75vh;
  overflow-y: auto;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border);
}
.lobby-settings::-webkit-scrollbar { width: 4px }
.lobby-settings::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px }
.lobby-settings h2 {
  font-size: 20px;
  font-weight: 700;
  color: var(--text);
  margin-bottom: 4px;
}
.lobby-settings .meeting-info {
  font-size: 13px;
  color: var(--text2);
  margin-bottom: 4px;
}

/* Form */
.config-form { display: flex; flex-direction: column; gap: 12px }
.config-form label { font-size: 12px; color: var(--text2); font-weight: 500; margin-bottom: 2px; display: block }
.config-form input, .config-form select, .config-form textarea {
  width: 100%;
  background: var(--surface);
  border: 1px solid var(--border);
  color: var(--text);
  border-radius: 8px;
  padding: 10px 12px;
  font-size: 14px;
  font-family: inherit;
  outline: none;
  transition: border-color .2s, box-shadow .2s;
  -webkit-appearance: none;
  appearance: none;
}
.config-form select {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath d='M3 5l3 3 3-3' fill='none' stroke='%235f6368' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  padding-right: 32px;
}
.config-form input:focus, .config-form select:focus, .config-form textarea:focus {
  border-color: var(--call-blue);
  box-shadow: 0 0 0 2px rgba(26,115,232,.15);
}
.config-form textarea { resize: vertical; min-height: 80px }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px }

/* Accordion in lobby */
.lobby-accordion { border-top: 1px solid var(--border); margin-top: 4px; padding-top: 4px }
.lobby-accordion summary {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 0;
  font-size: 13px;
  font-weight: 600;
  color: var(--text2);
  cursor: pointer;
  list-style: none;
  user-select: none;
}
.lobby-accordion summary::-webkit-details-marker { display: none }
.lobby-accordion summary::after {
  content: '';
  width: 7px; height: 7px;
  border-right: 2px solid var(--text3);
  border-bottom: 2px solid var(--text3);
  transform: rotate(45deg);
  transition: transform .2s ease;
}
.lobby-accordion[open] summary::after { transform: rotate(-135deg) }
.accordion-body { padding: 8px 0 4px; display: flex; flex-direction: column; gap: 10px }

/* Join button */
.btn-join {
  background: var(--call-blue);
  color: #202124;
  border: none;
  border-radius: 24px;
  padding: 14px 32px;
  font-size: 15px;
  font-weight: 700;
  cursor: pointer;
  transition: all .2s;
  font-family: inherit;
  letter-spacing: .02em;
  text-align: center;
}
.btn-join:hover { background: #aecbfa; transform: translateY(-1px) }
.btn-join:active { transform: translateY(0) }
.btn-join:disabled { opacity: .4; cursor: not-allowed; transform: none }

/* Hint box (lobby) */
.hint-box {
  background: rgba(26,115,232,.04);
  border-left: 3px solid var(--call-blue);
  border-radius: 0 8px 8px 0;
  padding: 12px 14px;
}
.hint-box .ht { font-size: 11px; color: var(--call-blue); font-weight: 700; margin-bottom: 4px }
.hint-box .hc { font-size: 12px; color: var(--text2); line-height: 1.6 }

/* ============================================= */
/* === CALL SCREEN (Google Meet style)       === */
/* ============================================= */
#screen-call {
  flex-direction: column;
  background: var(--bg);
}

.call-header {
  display: flex;
  align-items: center;
  padding: 8px 20px;
  gap: 16px;
  font-size: 14px;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  z-index: 10;
  min-height: 48px;
}
.call-title {
  font-weight: 600;
  color: var(--text);
  font-size: 15px;
}
.call-header-meta {
  display: flex;
  gap: 16px;
  margin-left: auto;
  align-items: center;
  font-size: 13px;
  color: var(--text2);
}
.call-header-timer {
  font-variant-numeric: tabular-nums;
  font-weight: 500;
}
.call-participants {
  display: flex;
  align-items: center;
  gap: 4px;
}
.call-badge {
  background: var(--surface2);
  color: var(--text2);
  border-radius: 16px;
  padding: 4px 10px;
  font-size: 12px;
  font-weight: 500;
}

/* Main call area */
.call-main {
  flex: 1;
  display: flex;
  overflow: hidden;
  position: relative;
}

.call-stage {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  background: var(--stage-bg);
  border-radius: 12px;
  margin: 8px;
  background-image: radial-gradient(circle at 1px 1px, rgba(255,255,255,.02) 1px, transparent 0);
  background-size: 40px 40px;
}

/* AI Avatar (center) */
.ai-avatar-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 20px;
}

.avatar-ring-wrapper {
  position: relative;
  width: 200px;
  height: 200px;
}

.avatar-ring {
  width: 200px;
  height: 200px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  padding: 5px;
  background: var(--stage-surface);
  transition: all .4s ease;
}

.avatar-ring.speaking {
  background: conic-gradient(from 0deg, #34a853, transparent 30%, #34a853 50%, transparent 80%, #34a853);
  animation: ring-rotate 2s linear infinite;
  filter: drop-shadow(0 0 24px rgba(52,168,83,.4));
}

.avatar-ring.listening {
  background: conic-gradient(from 0deg, #4285f4, transparent 40%, #4285f4 60%, transparent);
  animation: ring-rotate 3s linear infinite;
  filter: drop-shadow(0 0 16px rgba(66,133,244,.3));
}

.avatar-ring.thinking {
  background: conic-gradient(from 0deg, #fbbc04, transparent 30%, #fbbc04 50%, transparent 80%, #fbbc04);
  animation: ring-rotate 1.5s linear infinite;
  filter: drop-shadow(0 0 16px rgba(251,188,4,.3));
}

@keyframes ring-rotate {
  from { transform: rotate(0deg) }
  to { transform: rotate(360deg) }
}

.ai-avatar-inner {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  background: var(--stage-bg);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 72px;
  position: relative;
  overflow: hidden;
}
.ai-avatar-inner::after {
  content: '';
  position: absolute;
  inset: 0;
  background: radial-gradient(ellipse at 30% 30%, rgba(255,255,255,.06) 0%, transparent 60%);
  border-radius: 50%;
}

/* Audio level glow ring (dynamic via JS) */
.avatar-glow {
  position: absolute;
  inset: -8px;
  border-radius: 50%;
  border: 2px solid transparent;
  transition: all .1s;
  pointer-events: none;
}

.ai-name-tag {
  font-size: 16px;
  font-weight: 600;
  color: var(--stage-text);
  display: flex;
  align-items: center;
  gap: 8px;
}
.ai-name-tag .persona-label {
  font-size: 11px;
  background: var(--stage-surface);
  padding: 2px 8px;
  border-radius: 10px;
  color: var(--stage-text2);
  font-weight: 400;
}

.speaking-indicator {
  font-size: 13px;
  color: var(--stage-text2);
  height: 20px;
  opacity: 0;
  transition: opacity .3s;
}
.speaking-indicator.active { opacity: 1 }

/* User PiP (bottom-right) */
.pip-container {
  position: absolute;
  bottom: 20px;
  right: 20px;
  width: 176px;
  height: 132px;
  border-radius: 12px;
  background: var(--stage-bg);
  border: 2px solid var(--stage-surface);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 6px;
  box-shadow: 0 4px 24px rgba(0,0,0,.5);
  transition: border-color .3s, box-shadow .3s;
  z-index: 5;
}
.pip-container.user-speaking {
  border-color: #4285f4;
  box-shadow: 0 0 16px rgba(66,133,244,.3);
}
.pip-avatar {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: linear-gradient(135deg, #5c6bc0, #7c4dff);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
}
.pip-name {
  font-size: 12px;
  color: var(--stage-text2);
  font-weight: 500;
}
.pip-mic {
  position: absolute;
  bottom: 8px;
  right: 8px;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background: var(--stage-surface);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
}

/* Live captions (bottom center overlay) */
.live-captions {
  position: absolute;
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,.8);
  color: #fff;
  padding: 10px 24px;
  border-radius: 8px;
  font-size: 14px;
  max-width: 600px;
  text-align: center;
  line-height: 1.5;
  opacity: 0;
  transition: opacity .3s;
  z-index: 10;
  pointer-events: none;
}
.live-captions.visible { opacity: 1 }
.caption-sender { font-weight: 600; color: var(--call-blue); margin-right: 6px }

/* Transcript side panel */
.transcript-panel {
  width: 360px;
  background: var(--surface);
  border-left: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  transition: width .25s ease, opacity .2s;
  overflow: hidden;
}
.transcript-panel.hidden { width: 0; border-left: none; opacity: 0 }

.transcript-header {
  padding: 14px 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid var(--border);
  font-size: 14px;
  font-weight: 600;
  color: var(--text);
  flex-shrink: 0;
}
.transcript-close {
  background: none;
  border: none;
  color: var(--text3);
  font-size: 18px;
  cursor: pointer;
  padding: 4px;
  line-height: 1;
}
.transcript-close:hover { color: var(--text) }

.transcript-messages {
  flex: 1;
  overflow-y: auto;
  padding: 12px 16px;
  display: flex;
  flex-direction: column;
  gap: 14px;
}
.transcript-messages::-webkit-scrollbar { width: 3px }
.transcript-messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px }

.t-msg { font-size: 13px; line-height: 1.55 }
.t-msg .t-sender {
  font-size: 11px;
  font-weight: 700;
  margin-bottom: 3px;
  display: flex;
  align-items: center;
  gap: 6px;
}
.t-msg.t-ai .t-sender { color: #1e8e3e }
.t-msg.t-user .t-sender { color: #1a73e8 }
.t-msg.t-system .t-sender { color: #e37400 }
.t-msg .t-text { color: var(--text); word-break: break-word }
.t-msg .t-text.live { opacity: .5; font-style: italic }
.t-msg .t-time { font-size: 10px; color: var(--text3); margin-top: 3px }

/* Bottom control bar */
.call-controls {
  padding: 12px 20px 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  background: var(--surface);
  border-top: 1px solid var(--border);
  z-index: 10;
}
.call-controls-center {
  display: flex;
  gap: 14px;
  align-items: center;
}
.ctrl-btn {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  border: none;
  background: var(--surface2);
  color: var(--text);
  font-size: 18px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all .15s;
  position: relative;
  font-family: inherit;
}
.ctrl-btn:hover { background: var(--surface3) }
.ctrl-btn.active { background: #e8f0fe; color: var(--call-blue) }
.ctrl-btn.muted { background: var(--call-red); color: #fff }
.ctrl-btn-label {
  position: absolute;
  bottom: -20px;
  font-size: 10px;
  color: var(--text2);
  white-space: nowrap;
  pointer-events: none;
}

.ctrl-end-call {
  background: var(--call-red);
  color: #fff;
  width: 56px;
  border-radius: 28px;
  font-size: 20px;
}
.ctrl-end-call:hover { background: #d33b2c }

.call-timer-bar {
  position: absolute;
  left: 20px;
  font-size: 13px;
  color: var(--text2);
  font-variant-numeric: tabular-nums;
  display: flex;
  align-items: center;
  gap: 6px;
}
.call-timer-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--call-red);
  animation: pulse 2s infinite;
}
@keyframes pulse { 0%,100%{ opacity:1 } 50%{ opacity:.3 } }

/* ============================================= */
/* === RESULTS SCREEN (Meeting Summary)      === */
/* ============================================= */
#screen-results {
  flex-direction: column;
  background: #f6f7f8;
  overflow: hidden;
  display: none;
}
#screen-results.active { display: block !important; }

.results-wrapper {
  max-width: 680px;
  width: 92%;
  margin: 0 auto;
  padding: 40px 0 60px;
}

.results-header {
  text-align: center;
  margin-bottom: 32px;
}
.results-header h1 {
  font-size: 22px;
  font-weight: 700;
  color: var(--text);
  margin-bottom: 8px;
}
.results-meta {
  font-size: 13px;
  color: var(--text2);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 16px;
  flex-wrap: wrap;
}
.results-meta span {
  display: flex;
  align-items: center;
  gap: 4px;
}

/* Score hero */
.score-hero {
  text-align: center;
  padding: 36px 24px;
  background: var(--surface);
  border-radius: 16px;
  margin-bottom: 20px;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border);
}
.score-hero-value {
  font-size: 72px;
  font-weight: 900;
  letter-spacing: -0.04em;
  line-height: 1;
  background: linear-gradient(135deg, #e37400, #f9ab00);
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
}
.score-hero-label {
  font-size: 14px;
  color: var(--text2);
  margin-top: 8px;
  font-weight: 500;
}
.score-hero .streak-badge {
  background: linear-gradient(135deg, #e37400, #f9ab00);
  color: #fff;
  border-radius: 20px;
  padding: 4px 12px;
  font-size: 12px;
  font-weight: 700;
  display: inline-flex;
  align-items: center;
  gap: 4px;
  margin-top: 12px;
}
.score-hero .title-badge {
  background: #fef7e0;
  border: 1px solid #f9ab00;
  border-radius: 20px;
  padding: 4px 12px;
  font-size: 12px;
  font-weight: 600;
  color: #e37400;
  display: inline-block;
  margin-top: 8px;
}

/* Score bars */
.results-card {
  background: var(--surface);
  border-radius: 16px;
  padding: 24px;
  margin-bottom: 16px;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border);
}
.results-card h3 {
  font-size: 14px;
  font-weight: 700;
  color: var(--text);
  margin-bottom: 16px;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--border);
}

.sb-item { display: flex; align-items: center; gap: 10px; font-size: 13px; margin-bottom: 12px }
.sb-item .n { color: var(--text2); width: 80px; flex-shrink: 0; font-weight: 500 }
.sb-item .bg { flex: 1; height: 6px; background: var(--surface2); border-radius: 3px; overflow: hidden }
.sb-item .fl { height: 100%; border-radius: 3px; background: var(--call-blue); transition: width .8s ease }
.sb-item .v { color: var(--text); width: 24px; text-align: right; font-weight: 700; font-size: 14px }
.sb-item .drill-btn {
  background: none;
  border: 1px solid var(--call-blue);
  color: var(--call-blue);
  border-radius: 12px;
  padding: 2px 8px;
  font-size: 10px;
  cursor: pointer;
  flex-shrink: 0;
  font-family: inherit;
}
.sb-item .drill-btn:hover { background: rgba(26,115,232,.08) }

.evidence-line { font-size: 11px; padding-left: 90px; margin-top: -8px; margin-bottom: 8px }
.evidence-line.good { color: var(--green) }
.evidence-line.bad { color: var(--red) }
.evidence-line.neutral { color: var(--text2) }

.result-comment { font-size: 14px; line-height: 1.7; color: var(--text) }

/* Timeline */
.timeline-item {
  margin-bottom: 10px;
  padding: 10px 14px;
  background: var(--surface2);
  border-radius: 10px;
  font-size: 13px;
}
.timeline-eval { font-weight: 600; margin-right: 6px }
.timeline-comment { color: var(--text2); font-size: 12px; margin-top: 4px }

/* Drill buttons */
.drill-button {
  display: block;
  width: 100%;
  margin-bottom: 8px;
  background: #fce8e6;
  border: 1px solid rgba(234,67,53,.2);
  color: var(--red);
  border-radius: 10px;
  padding: 10px 14px;
  font-size: 13px;
  cursor: pointer;
  text-align: left;
  font-family: inherit;
  transition: background .15s;
}
.drill-button:hover { background: #f8d7d4 }

/* Results actions */
.results-actions {
  display: flex;
  gap: 12px;
  margin-top: 24px;
}
.results-actions .btn-primary {
  flex: 1;
  background: var(--call-blue);
  color: #fff;
  border: none;
  border-radius: 24px;
  padding: 14px 20px;
  font-size: 14px;
  font-weight: 700;
  cursor: pointer;
  font-family: inherit;
  transition: all .15s;
}
.results-actions .btn-primary:hover { background: #1567d3 }
.results-actions .btn-secondary {
  flex: 1;
  background: var(--surface);
  color: var(--text);
  border: 1px solid var(--border);
  border-radius: 24px;
  padding: 14px 20px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  font-family: inherit;
  transition: all .15s;
}
.results-actions .btn-secondary:hover { background: var(--surface2) }

/* ============================================= */
/* === USAGE DASHBOARD OVERLAY               === */
/* ============================================= */
.overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.3);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 100;
  backdrop-filter: blur(4px);
}
.overlay.show { display: flex }

.modal-card {
  background: var(--surface);
  border-radius: 16px;
  max-width: 700px;
  width: 92%;
  max-height: 85vh;
  overflow-y: auto;
  box-shadow: var(--shadow-lg);
  animation: modalIn .25s ease-out;
}
@keyframes modalIn { from { opacity:0; transform:scale(.95) translateY(12px) } to { opacity:1; transform:scale(1) translateY(0) } }

.modal-header {
  padding: 24px;
  text-align: center;
  border-bottom: 1px solid var(--border);
}
.modal-header h2 { font-size: 18px; font-weight: 700; color: var(--text) }
.modal-body { padding: 24px }
.modal-close {
  width: 100%;
  margin-top: 20px;
  background: var(--surface2);
  color: var(--text);
  border: none;
  padding: 12px;
  border-radius: var(--radius);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  font-family: inherit;
  transition: background .15s;
}
.modal-close:hover { background: var(--surface3) }

/* Score preview bars (lobby) */
.score-preview { display: flex; flex-direction: column; gap: 6px }
.sp-item { display: flex; align-items: center; gap: 8px; font-size: 11px }
.sp-item .n { color: var(--text2); width: 72px; flex-shrink: 0 }
.sp-item .bg { flex: 1; height: 4px; background: var(--surface2); border-radius: 2px; overflow: hidden }
.sp-item .fl { height: 100%; border-radius: 2px; background: var(--call-blue); transition: width .8s ease }
.sp-item .v { color: var(--text); width: 20px; text-align: right; font-weight: 700; font-size: 11px }

/* History (lobby) */
.history-list { max-height: 160px; overflow-y: auto }
.history-item {
  display: flex;
  justify-content: space-between;
  padding: 6px 0;
  border-bottom: 1px solid var(--border);
  font-size: 12px;
  color: var(--text2);
}
.history-item .hs { color: var(--text); font-weight: 700 }

/* Trend chart */
.trend-chart-wrap {
  height: 140px;
  background: var(--surface2);
  border-radius: 8px;
  padding: 8px;
}

/* ============================================= */
/* === RESPONSIVE                            === */
/* ============================================= */
@media (max-width: 768px) {
  .lobby-container {
    grid-template-columns: 1fr;
    gap: 16px;
    padding: 60px 0 20px;
  }
  .lobby-preview { aspect-ratio: 16/9; max-height: 220px }
  .lobby-settings { max-height: none }
  .form-row { grid-template-columns: 1fr }

  .call-stage { padding: 20px }
  .avatar-ring-wrapper, .avatar-ring { width: 140px; height: 140px }
  .ai-avatar-inner { font-size: 52px }
  .pip-container { width: 120px; height: 90px; bottom: 12px; right: 12px }
  .pip-avatar { width: 36px; height: 36px; font-size: 18px }
  .pip-name { font-size: 10px }

  .transcript-panel { position: absolute; right: 0; top: 0; bottom: 0; width: 280px; z-index: 20 }
  .transcript-panel.hidden { width: 0 }

  .live-captions { max-width: 85%; font-size: 13px }

  .call-timer-bar { position: static; margin-right: auto }
  .call-controls { flex-wrap: wrap; gap: 8px }

  .results-wrapper { padding: 24px 0 40px }
  .score-hero-value { font-size: 56px }
  .results-actions { flex-direction: column }
}

@media (max-width: 480px) {
  .lobby-header { padding: 10px 16px }
  .lobby-container { width: 96% }
  .ctrl-btn { width: 42px; height: 42px; font-size: 16px }
  .ctrl-end-call { width: 50px }
}

/* Screen transition animation */
@keyframes screenFadeIn {
  from { opacity: 0 }
  to { opacity: 1 }
}
.screen.active {
  animation: screenFadeIn .3s ease;
}
</style>
</head>
<body>

<!-- =========================================== -->
<!-- LOBBY SCREEN                                -->
<!-- =========================================== -->
<div id="screen-lobby" class="screen active">
  <div class="lobby-header">
    <div class="lobby-logo">AIå–¶æ¥­ãƒ­ãƒ¼ãƒ—ãƒ¬ <span>v2</span></div>
    <div class="lobby-header-actions">
      <button onclick="showUsageDashboard()" class="lobby-header-btn">åˆ©ç”¨çŠ¶æ³</button>
    </div>
  </div>

  <div class="lobby-container">
    <!-- Camera Preview -->
    <div class="lobby-preview">
      <div class="lobby-preview-bg"></div>
      <div class="lobby-avatar" id="lobbyAvatar">ğŸ§‘â€ğŸ’¼</div>
      <div class="lobby-user-name" id="lobbyUserName">æ‹…å½“è€…åã‚’å…¥åŠ›</div>
      <div class="lobby-mic-test">
        <span>ğŸ¤</span>
        <div class="lobby-mic-bar"><div class="lobby-mic-fill" id="lobbyMicFill"></div></div>
        <span id="lobbyMicStatus">å¾…æ©Ÿä¸­</span>
      </div>
      <div class="lobby-preview-controls">
        <button class="preview-ctrl-btn" id="lobbyMicBtn" onclick="toggleLobbyMic()" title="ãƒã‚¤ã‚¯ãƒ†ã‚¹ãƒˆ">ğŸ¤</button>
      </div>
    </div>

    <!-- Settings -->
    <div class="lobby-settings">
      <h2>ãƒ­ãƒ¼ãƒ—ãƒ¬ã«å‚åŠ </h2>
      <div class="meeting-info" id="meetingInfo">AIé¡§å®¢ã¨ã®å–¶æ¥­ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤</div>

      <div class="config-form">
        <div class="form-row">
          <div><label>æ‹…å½“è€…å</label><input type="text" id="salesName" placeholder="ä¾‹: é«˜æ©‹" oninput="updateLobbyName()"></div>
          <div><label>å•†æ</label>
            <select id="product">
              <option value="ISAI">ISAIï¼ˆAIãƒãƒ¼ã‚±ã‚¿ãƒ¼ã‚¹ã‚¯ãƒ¼ãƒ«ï¼‰</option>
              <option value="Adoafi">Adoafi</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div><label>é¡§å®¢ãƒšãƒ«ã‚½ãƒŠ</label>
            <select id="persona" onchange="onPersonaChange()">
              <option value="price">ã€Œé«˜ã„ã€ã¨è¨€ã†é¡§å®¢</option>
              <option value="compare">ã€Œä»–ã¨æ¯”ã¹ãŸã„ã€é¡§å®¢</option>
              <option value="busy">ã€Œå¿™ã—ãã¦æ™‚é–“ãŒãªã„ã€é¡§å®¢</option>
              <option value="spouse">ã€Œé…å¶è€…ã«ç›¸è«‡ã—ãŸã„ã€é¡§å®¢</option>
              <option value="doubt">ã€Œæœ¬å½“ã«åŠ¹æœã‚ã‚‹ã®ï¼Ÿã€é¡§å®¢</option>
              <option value="custom">å®Ÿå•†è«‡ãƒˆãƒ¬ãƒ¼ã‚¹ï¼ˆâ†“ãƒ­ã‚°è²¼ä»˜ï¼‰</option>
            </select>
          </div>
          <div><label>é›£æ˜“åº¦</label>
            <select id="difficulty">
              <option value="easy">æ˜“ï¼ˆä¹—ã‚Šã‚„ã™ã„é¡§å®¢ï¼‰</option>
              <option value="medium" selected>ä¸­ï¼ˆæ™®é€šã®é¡§å®¢ï¼‰</option>
              <option value="hard">é›£ï¼ˆé ‘å›ºãªé¡§å®¢ï¼‰</option>
            </select>
          </div>
        </div>

        <div id="customPersonaBox" style="display:none">
          <label>å¤±æ³¨å•†è«‡ãƒ­ã‚°ã‚’è²¼ã‚Šä»˜ã‘</label>
          <textarea id="customTranscript" placeholder="å•†è«‡ã®è­°äº‹éŒ²ã€æ–‡å­—èµ·ã“ã—ã€ã¾ãŸã¯GAS FBãƒ„ãƒ¼ãƒ«ã®ç·è©•ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„"></textarea>
        </div>
      </div>

      <div class="hint-box">
        <div class="ht">ä»Šå›ã®ç·´ç¿’ãƒã‚¤ãƒ³ãƒˆ</div>
        <div class="hc" id="hintText"></div>
      </div>

      <!-- Advanced settings -->
      <details class="lobby-accordion">
        <summary>è©³ç´°è¨­å®š</summary>
        <div class="accordion-body config-form">
          <div><label>å…‹æœã™ã¹ãå¼±ç‚¹</label>
            <select id="weakPoint" onchange="updateHint()">
              <option value="anchoring">ã‚¢ãƒ³ã‚«ãƒªãƒ³ã‚°ï¼ˆä¾¡æ ¼æç¤ºï¼‰</option>
              <option value="authority">æ¨©å¨æ€§ï¼ˆé¸ã¶å´ã‚¹ã‚¿ãƒ³ã‚¹ï¼‰</option>
              <option value="loss_aversion">æå¤±å›é¿ï¼ˆç¾çŠ¶ãƒªã‚¹ã‚¯æŒ‡æ‘˜ï¼‰</option>
              <option value="reframing">ãƒªãƒ•ãƒ¬ãƒ¼ãƒŸãƒ³ã‚°ï¼ˆã‚¹ã‚¯ãƒ¼ãƒ«â†’ç ”ä¿®ï¼‰</option>
              <option value="closing">ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ³ã‚°ï¼ˆè¨€ã„åˆ‡ã‚Šèª˜å°ï¼‰</option>
              <option value="hearing">ãƒ’ã‚¢ãƒªãƒ³ã‚°ï¼ˆèª²é¡Œã®æ·±å €ã‚Šï¼‰</option>
              <option value="rapport">ãƒ©ãƒãƒ¼ãƒ«ï¼ˆä¿¡é ¼æ§‹ç¯‰ï¼‰</option>
              <option value="objection">åè«–å‡¦ç†ï¼ˆåˆ‡ã‚Šè¿”ã—åŠ›ï¼‰</option>
              <option value="tempo">ãƒ†ãƒ³ãƒï¼ˆä¼šè©±ã®ãƒªã‚ºãƒ ï¼‰</option>
              <option value="proposal">ææ¡ˆåŠ›ï¼ˆè§£æ±ºç­–ã®å…·ä½“æ€§ï¼‰</option>
            </select>
          </div>
          <div><label>ã‚·ãƒŠãƒªã‚ª</label>
            <select id="scenario">
              <option value="full">ãƒ•ãƒ«å•†è«‡ï¼ˆè‡ªç”±ä¼šè©±ï¼‰</option>
              <option value="opening">å†’é ­5åˆ†ï¼ˆã‚¢ã‚¤ã‚¹ãƒ–ãƒ¬ã‚¤ã‚¯â†’ãƒ’ã‚¢ãƒªãƒ³ã‚°ï¼‰</option>
              <option value="price_objection">ä¾¡æ ¼æç¤ºå¾Œã®åˆ‡ã‚Šè¿”ã—</option>
              <option value="closing_3min">ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ³ã‚°æœ€å¾Œã®3åˆ†</option>
            </select>
          </div>
          <div><label>Gemini API Key</label><input type="password" id="apiKey" placeholder="AIzaSy..."></div>
          <div><label>ãƒ¢ãƒ‡ãƒ«</label>
            <select id="modelName">
              <option value="gemini-2.5-flash-native-audio-preview-12-2025">gemini-2.5-flash-native-audioï¼ˆç´„44å††/10åˆ†ï¼‰</option>
            </select>
          </div>
          <div><label><input type="checkbox" id="saveKey" style="width:auto;margin-right:6px">API Keyã‚’ä¿å­˜ã™ã‚‹</label></div>
        </div>
      </details>

      <!-- Score & History -->
      <details class="lobby-accordion">
        <summary>ã‚¹ã‚³ã‚¢ & å±¥æ­´</summary>
        <div class="accordion-body">
          <div>
            <div style="font-size:11px;font-weight:700;color:var(--call-text2);margin-bottom:6px">å‰å›ã‚¹ã‚³ã‚¢</div>
            <div class="score-preview" id="scorePreview"></div>
          </div>
          <div>
            <div style="font-size:11px;font-weight:700;color:var(--call-text2);margin-bottom:6px">ã‚¹ã‚³ã‚¢ãƒˆãƒ¬ãƒ³ãƒ‰</div>
            <div class="trend-chart-wrap"><canvas id="trendChart"></canvas></div>
          </div>
          <div>
            <div style="font-size:11px;font-weight:700;color:var(--call-text2);margin-bottom:6px">ç·´ç¿’å±¥æ­´</div>
            <div class="history-list" id="historyList"><span style="font-size:11px;color:var(--call-text2)">ã¾ã å±¥æ­´ãªã—</span></div>
          </div>
        </div>
      </details>

      <!-- GAS Integration -->
      <details class="lobby-accordion">
        <summary>GASå•†è«‡FBé€£æº</summary>
        <div class="accordion-body config-form">
          <div><label>GAS Web App URL</label><input type="text" id="gasUrl" placeholder="https://script.google.com/macros/s/..." style="font-size:12px"></div>
          <button onclick="fetchLossData()" style="background:rgba(138,180,248,.08);border:1px solid rgba(138,180,248,.2);color:var(--call-blue);padding:8px 12px;font-size:12px;width:100%;border-radius:8px;cursor:pointer;font-family:inherit">å¤±æ³¨ãƒ‡ãƒ¼ã‚¿å–å¾—</button>
          <select id="lossSelect" style="display:none;width:100%;background:var(--call-bg);border:1px solid var(--call-border);color:var(--call-text);border-radius:8px;padding:10px;font-size:12px"></select>
        </div>
      </details>

      <button class="btn-join" id="btnJoin" onclick="joinMeeting()">ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã«å‚åŠ </button>
    </div>
  </div>
</div>

<!-- =========================================== -->
<!-- CALL SCREEN                                 -->
<!-- =========================================== -->
<div id="screen-call" class="screen">
  <div class="call-header">
    <div class="call-title">AIå–¶æ¥­ãƒ­ãƒ¼ãƒ—ãƒ¬</div>
    <div class="call-header-meta">
      <span id="callHeaderTimer" class="call-header-timer">00:00</span>
      <span class="call-participants">ğŸ‘¥ <span id="callParticipants">2</span></span>
      <span class="call-badge" id="callScenarioBadge"></span>
    </div>
  </div>

  <div class="call-main">
    <div class="call-stage">
      <!-- AI Avatar (center) -->
      <div class="ai-avatar-container" id="aiAvatarContainer">
        <div class="avatar-ring-wrapper">
          <div class="avatar-glow" id="avatarGlow"></div>
          <div class="avatar-ring" id="aiAvatarRing">
            <div class="ai-avatar-inner" id="aiAvatarInner">ğŸ‘¤</div>
          </div>
        </div>
        <div class="ai-name-tag">
          <span id="aiNameDisplay">é¡§å®¢ï¼ˆAIï¼‰</span>
          <span class="persona-label" id="aiPersonaLabel"></span>
        </div>
        <div class="speaking-indicator" id="speakingIndicator">ç™ºè©±ä¸­...</div>
      </div>

      <!-- User PiP -->
      <div class="pip-container" id="pipContainer">
        <div class="pip-avatar" id="pipAvatar">ğŸ§‘â€ğŸ’¼</div>
        <div class="pip-name" id="pipName">ã‚ãªãŸ</div>
        <div class="pip-mic" id="pipMic">ğŸ¤</div>
      </div>

      <!-- Live Captions -->
      <div class="live-captions" id="liveCaptions">
        <span class="caption-sender" id="captionSender"></span>
        <span id="captionText"></span>
      </div>
    </div>

    <!-- Transcript Panel -->
    <div class="transcript-panel hidden" id="transcriptPanel">
      <div class="transcript-header">
        <span>å­—å¹•ãƒ»ä¼šè©±ãƒ­ã‚°</span>
        <button class="transcript-close" onclick="toggleTranscript()">âœ•</button>
      </div>
      <div class="transcript-messages" id="transcriptMessages"></div>
    </div>
  </div>

  <!-- Control Bar -->
  <div class="call-controls">
    <div class="call-timer-bar">
      <div class="call-timer-dot"></div>
      <span id="callBarTimer">00:00</span>
    </div>
    <div class="call-controls-center">
      <button class="ctrl-btn" id="btnMicToggle" onclick="toggleMic()" title="ãƒã‚¤ã‚¯">
        ğŸ¤
        <span class="ctrl-btn-label">ãƒã‚¤ã‚¯</span>
      </button>
      <button class="ctrl-end-call ctrl-btn" id="btnEndCall" onclick="endCall()" title="é€šè©±çµ‚äº†">
        ğŸ“
        <span class="ctrl-btn-label">é€€å‡º</span>
      </button>
      <button class="ctrl-btn" id="btnTranscript" onclick="toggleTranscript()" title="å­—å¹•">
        ğŸ’¬
        <span class="ctrl-btn-label">å­—å¹•</span>
      </button>
      <button class="ctrl-btn" id="btnCallGrade" onclick="gradeFromCall()" title="æ¡ç‚¹" disabled>
        ğŸ“Š
        <span class="ctrl-btn-label">æ¡ç‚¹</span>
      </button>
    </div>
  </div>
</div>

<!-- =========================================== -->
<!-- RESULTS SCREEN (SalesAI Review)             -->
<!-- =========================================== -->
<div id="screen-results" class="screen">
<div class="relative flex h-auto min-h-screen w-full flex-col overflow-x-hidden font-display" style="font-family:'Inter','Noto Sans JP',sans-serif">
<div class="flex h-full grow flex-col">

<!-- Results Header -->
<header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-slate-200 bg-white px-6 py-3 lg:px-10">
  <div class="flex items-center gap-8">
    <div class="flex items-center gap-3 text-primary">
      <div class="w-8 h-8 bg-primary/10 rounded-lg flex items-center justify-center">
        <span class="material-symbols-outlined text-primary" style="font-size:20px">analytics</span>
      </div>
      <h2 class="text-slate-900 text-lg font-bold leading-tight tracking-tight">SalesAI Review</h2>
    </div>
    <div class="hidden md:flex items-center gap-6">
      <a class="text-primary text-sm font-bold border-b-2 border-primary pb-1 cursor-pointer">ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ†æ</a>
    </div>
  </div>
  <div class="flex items-center gap-3">
    <button class="hidden sm:flex min-w-[84px] cursor-pointer items-center justify-center rounded-lg h-10 px-4 bg-primary text-white text-sm font-bold hover:bg-primary/90 transition-all" id="btnExportReport">
      <span class="truncate">ãƒ¬ãƒãƒ¼ãƒˆã‚’æ›¸ãå‡ºã™</span>
    </button>
    <button class="flex cursor-pointer items-center justify-center rounded-lg h-10 px-4 bg-slate-100 text-slate-700 text-sm font-semibold hover:bg-slate-200 transition-all" onclick="backToLobby()">
      <span class="material-symbols-outlined mr-1" style="font-size:18px">arrow_back</span> æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³
    </button>
  </div>
</header>

<!-- Main Content -->
<main class="flex-1 max-w-7xl mx-auto w-full p-4 lg:p-8 space-y-6 overflow-y-auto" style="max-height:calc(100vh - 57px);max-height:calc(100dvh - 57px)">

  <!-- Breadcrumb -->
  <div class="flex flex-wrap items-center gap-2 text-sm" id="resultsBreadcrumb">
    <a class="text-slate-500 hover:text-primary cursor-pointer" onclick="backToLobby()">ã‚»ãƒƒã‚·ãƒ§ãƒ³å±¥æ­´</a>
    <span class="material-symbols-outlined text-sm text-slate-400">chevron_right</span>
    <span class="text-slate-900 font-semibold" id="resultsBreadcrumbTitle">åˆ†æçµæœ</span>
  </div>

  <!-- Top Row: Session Info + Score -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- Left: Session replay area (2 cols) -->
    <div class="lg:col-span-2 space-y-4">

      <!-- Session Info Card -->
      <div class="relative bg-slate-900 rounded-xl overflow-hidden shadow-xl border border-slate-800" style="aspect-ratio:16/9;min-height:200px">
        <div class="absolute inset-0 flex flex-col items-center justify-center text-center p-6" id="resultSessionVisual">
          <div class="text-6xl mb-3" id="resultAvatarEmoji">ğŸ§‘â€ğŸ’¼</div>
          <p class="text-white/80 text-base font-semibold" id="resultPersonaName"></p>
          <p class="text-white/40 text-sm mt-1" id="resultSessionMeta2"></p>
        </div>
        <!-- Timeline bar overlay -->
        <div class="absolute inset-x-0 bottom-0 px-6 py-4 bg-gradient-to-t from-black/80 to-transparent">
          <div class="flex items-center gap-4 mb-2">
            <span class="text-white text-xs font-medium">00:00</span>
            <div class="relative flex-1 h-1.5 rounded-full bg-white/20">
              <div class="absolute left-0 top-0 h-full rounded-full bg-primary" id="resultProgressBar" style="width:100%"></div>
            </div>
            <span class="text-white text-xs font-medium" id="resultDuration">--:--</span>
          </div>
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2 text-white/70 text-xs">
              <span class="material-symbols-outlined" style="font-size:16px">schedule</span>
              <span id="resultDate"></span>
              <span class="mx-2 text-white/30">|</span>
              <span class="material-symbols-outlined" style="font-size:16px">swap_horiz</span>
              <span id="resultTurns"></span>å¾€å¾©
            </div>
            <div class="flex items-center gap-2" id="resultStreakArea"></div>
          </div>
        </div>
      </div>

      <!-- Phase Markers -->
      <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm overflow-x-auto" id="resultPhaseMarkers">
        <div class="flex gap-3 min-w-max" id="resultPhaseContainer">
          <!-- Populated by JS -->
        </div>
      </div>
    </div>

    <!-- Right: Performance Score (1 col) -->
    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex flex-col items-center justify-center text-center">
      <h3 class="text-slate-900 font-bold mb-4 w-full text-left flex items-center gap-2">
        <span class="material-symbols-outlined text-primary filled">stars</span> ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚¹ã‚³ã‚¢
      </h3>
      <!-- Circular Score -->
      <div class="relative w-48 h-48 flex items-center justify-center mb-6">
        <svg class="absolute inset-0 w-full h-full -rotate-90" viewBox="0 0 120 120">
          <circle cx="60" cy="60" r="52" fill="none" stroke="#f1f5f9" stroke-width="12"/>
          <circle cx="60" cy="60" r="52" fill="none" stroke="#137fec" stroke-width="12" stroke-linecap="round"
            stroke-dasharray="326.73" id="resultScoreArc" stroke-dashoffset="326.73"/>
        </svg>
        <div class="text-center z-10">
          <span class="text-5xl font-extrabold text-slate-900 leading-none" id="resultScore">--</span>
          <p class="text-sm font-medium text-slate-500 mt-1" id="resultScoreLabel">---</p>
        </div>
      </div>
      <!-- Sub-score grid (top 4) -->
      <div class="grid grid-cols-2 gap-3 w-full" id="resultTopScores">
        <!-- Populated by JS -->
      </div>
    </div>
  </div>

  <!-- Bottom Row: Transcript + Radar + Coaching -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- Transcript Panel -->
    <div class="bg-white rounded-xl border border-slate-200 shadow-sm flex flex-col" style="height:500px">
      <div class="p-4 border-b border-slate-100 flex justify-between items-center">
        <h3 class="font-bold flex items-center gap-2 text-sm">
          <span class="material-symbols-outlined text-primary" style="font-size:20px">notes</span> æ–‡å­—èµ·ã“ã—
        </h3>
        <span class="text-xs text-slate-400" id="resultTranscriptCount"></span>
      </div>
      <div class="flex-1 overflow-y-auto p-4 space-y-5" id="resultTranscript">
        <!-- Populated by JS -->
      </div>
    </div>

    <!-- Competency Radar -->
    <div class="bg-white rounded-xl border border-slate-200 shadow-sm flex flex-col" style="height:500px">
      <div class="p-4 border-b border-slate-100">
        <h3 class="font-bold flex items-center gap-2 text-sm">
          <span class="material-symbols-outlined text-primary" style="font-size:20px">analytics</span> ã‚³ãƒ³ãƒ”ãƒ†ãƒ³ã‚·ãƒ¼åˆ†æ
        </h3>
      </div>
      <div class="flex-1 p-4 flex flex-col justify-around">
        <!-- Radar Chart SVG -->
        <div class="relative w-full aspect-square max-w-[260px] mx-auto" id="resultRadarContainer">
          <div class="absolute inset-0 flex items-center justify-center">
            <div class="w-full h-full border border-slate-200 rounded-full"></div>
            <div class="absolute w-3/4 h-3/4 border border-slate-200 rounded-full"></div>
            <div class="absolute w-1/2 h-1/2 border border-slate-200 rounded-full"></div>
            <div class="absolute w-1/4 h-1/4 border border-slate-200 rounded-full"></div>
          </div>
          <svg class="absolute inset-0 w-full h-full" viewBox="0 0 100 100" id="resultRadarSvg">
            <polygon class="fill-primary/20 stroke-primary" stroke-width="1" points="" id="resultRadarPolygon"/>
          </svg>
          <!-- Labels positioned around the radar -->
          <div id="resultRadarLabels"></div>
        </div>
        <!-- Stats under radar -->
        <div class="space-y-2 mt-3" id="resultCompetencyStats">
          <!-- Populated by JS -->
        </div>
      </div>
    </div>

    <!-- AI Coaching Insights -->
    <div class="bg-white rounded-xl border border-slate-200 shadow-sm flex flex-col" style="height:500px">
      <div class="p-4 border-b border-slate-100">
        <h3 class="font-bold flex items-center gap-2 text-sm">
          <span class="material-symbols-outlined text-primary" style="font-size:20px">auto_awesome</span> AIã‚³ãƒ¼ãƒãƒ³ã‚°ãƒ»ã‚¤ãƒ³ã‚µã‚¤ãƒˆ
        </h3>
      </div>
      <div class="flex-1 overflow-y-auto p-4 space-y-4" id="resultCoachingInsights">
        <!-- Populated by JS -->
      </div>
      <div class="p-4 border-t border-slate-100">
        <button class="w-full py-2.5 bg-primary/10 hover:bg-primary/20 text-primary font-bold text-sm rounded-lg transition-colors" id="btnDrillFromResults" onclick="drillFromResults()">
          å¼±ç‚¹ãƒ”ãƒ³ãƒã‚¤ãƒ³ãƒˆç·´ç¿’ã‚’é–‹å§‹
        </button>
      </div>
    </div>
  </div>

  <!-- Hidden fields for backward compatibility -->
  <div style="display:none">
    <div id="resultsMeta"></div>
    <div id="streakBadgeResult"></div>
    <div id="titleBadgeResult"></div>
    <div id="resultSubScores"></div>
    <div id="resultComment"></div>
    <div id="idealSection"><div id="idealResponse"></div></div>
    <div id="timelineSection"><div id="timelineContent"></div></div>
    <div id="drillSection"><div id="drillButtons"></div></div>
  </div>

</main>
</div>
</div>
</div>

<!-- =========================================== -->
<!-- USAGE DASHBOARD OVERLAY                     -->
<!-- =========================================== -->
<div class="overlay" id="usageOverlay">
  <div class="modal-card">
    <div class="modal-header">
      <h2>æœˆåˆ¥åˆ©ç”¨çŠ¶æ³</h2>
    </div>
    <div class="modal-body">
      <div style="display:flex;gap:8px;margin-bottom:16px;justify-content:center">
        <select id="usageMonth" onchange="renderUsageDashboard()" style="background:var(--call-bg);border:1px solid var(--call-border);color:var(--call-text);border-radius:8px;padding:6px 10px;font-size:12px;font-family:inherit"></select>
        <button onclick="exportUsageCSV()" style="background:var(--call-blue);color:#202124;border:none;padding:6px 14px;font-size:12px;border-radius:8px;cursor:pointer;font-weight:600;font-family:inherit">CSVå‡ºåŠ›</button>
      </div>
      <div id="usageTable"></div>
      <button class="modal-close" onclick="document.getElementById('usageOverlay').classList.remove('show')">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<script>
// === CONFIG ===
const HINTS={
  anchoring:'ã€Œå€¤æ®µãŒé«˜ã„ã€ã¨è¨€ã‚ã‚ŒãŸç¬é–“ãŒå‹è² ã€‚è²»ç”¨ã‚’ã€ŒæŠ•è³‡ã€ã€Œæ¡ç”¨è²»æ›ç®—ã€ã€Œæœˆå‰²ã‚Šã€ã«å¤‰æ›ã€‚ã€Œè¦šæ‚Ÿã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã€ã¨ã—ã¦å®šç¾©ã™ã‚‹ã“ã¨ãŒéµã€‚',
  authority:'ã€Œé¸ã¶å´ã€ã®ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å´©ã•ãªã„ã€‚é¡§å®¢ã®è³ªå•ã«å³ç­”ã›ãšã€Œãªãœãã®è³ªå•ã‚’ã™ã‚‹ã‹ã€ã‚’è¿”ã™ã€‚',
  loss_aversion:'ã€Œ3å¹´å¾Œã®è‡ªåˆ†ã®å§¿ã‚’æƒ³åƒã—ã¦ãã ã•ã„ã€ã€ŒåŒã„å¹´ã®äººãŒã©ã“ã«ã„ã‚‹ã‹ã€ã§ç¾çŠ¶ãƒªã‚¹ã‚¯ã‚’çªãã€‚',
  reframing:'ã€Œã‚¹ã‚¯ãƒ¼ãƒ«ã€ã€Œå­¦æ ¡ã€ã‚’ã€Œç¤¾å†…ç ”ä¿®ã€ã€Œãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°å®¤ã®ç«‹ã¡ä¸Šã’ã€ã«å¤‰æ›ã€‚é¡§å®¢ãŒãã®è¨€è‘‰ã‚’ä½¿ã„å§‹ã‚ãŸã‚‰æˆåŠŸã€‚',
  closing:'ã€Œæ‰‹ç¶šãé€²ã‚ã¾ã™ã€ã¨è¨€ã„åˆ‡ã‚‹ç·´ç¿’ã€‚ã€Œã§ã¯ã€œã¨ã„ã†ã“ã¨ã§ã‚ˆã„ã§ã™ã‹ï¼Ÿã€â†’ã€Œã§ã¯æ‰‹ç¶šãã«ç§»ã‚Šã¾ã—ã‚‡ã†ã€ã¨ä¸»èªã‚’å¤‰ãˆã‚‹ã€‚',
  hearing:'ã€Œãªãœãã†æ€ã„ã¾ã™ã‹ï¼Ÿã€ã€Œä»–ã«å›°ã£ã¦ã„ã‚‹ã“ã¨ã¯ï¼Ÿã€ã§é¡§å®¢ã®æœ¬éŸ³ã‚’å¼•ãå‡ºã™ã€‚è¡¨é¢çš„ãªå›ç­”ã§çµ‚ã‚ã‚‰ã›ãªã„ã€‚',
  rapport:'æœ€åˆã®90ç§’ã§å…±æ„Ÿãƒã‚¤ãƒ³ãƒˆã‚’è¦‹ã¤ã‘ã‚‹ã€‚ç›¸æ‰‹ã®åå‰ã‚’å‘¼ã¶ã€å…±é€šç‚¹ã‚’è¦‹ã¤ã‘ã‚‹ã€ç›¸æ‰‹ã®è¨€è‘‰ã‚’ã‚ªã‚¦ãƒ è¿”ã—ã™ã‚‹ã€‚',
  objection:'åè«–ã¯è²·ã„ãŸã„ã‚µã‚¤ãƒ³ã€‚ã€Œã¨ã„ã†ã“ã¨ã¯ã€œãŒè§£æ±ºã™ã‚Œã°å‰å‘ãã§ã™ã‹ï¼Ÿã€ã¨æ¡ä»¶ä»˜ãYesã«æŒã¡è¾¼ã‚€ã€‚',
  tempo:'æ²ˆé»™ã‚’æ€–ãŒã‚‰ãªã„ã€‚è³ªå•ã—ãŸå¾Œ3ç§’å¾…ã¤ã€‚çŸ¢ç¶™ãæ—©ã«è©±ã•ãšã€ç›¸æ‰‹ã«è€ƒãˆã‚‹é–“ã‚’ä¸ãˆã‚‹ã€‚',
  proposal:'æŠ½è±¡çš„ãªãƒ¡ãƒªãƒƒãƒˆã§ã¯ãªãã€Œå¾¡ç¤¾ã®å ´åˆã€œã€ã¨å…·ä½“çš„ãªæ´»ç”¨ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’æãã€‚æ•°å­—ã§ç¤ºã™ã€‚'
};
const PERSONAS={
  price:{jp:'ã€Œé«˜ã„ã€ã¨è¨€ã†é¡§å®¢',intro:'ã¡ã‚‡ã£ã¨â€¦æ­£ç›´ã€å€¤æ®µãŒã¡ã‚‡ã£ã¨æ°—ã«ãªã£ã¦ã¦ã€‚'},
  compare:{jp:'æ¯”è¼ƒæ¤œè¨ã™ã‚‹é¡§å®¢',intro:'ä»–ã«ã‚‚ä¼¼ãŸã‚ˆã†ãªã‚¹ã‚¯ãƒ¼ãƒ«ã‚ã‚‹ã˜ã‚ƒãªã„ã§ã™ã‹ï¼Ÿãã£ã¡ã¨æ¯”ã¹ãŸãã¦ã€‚'},
  busy:{jp:'ã€Œå¿™ã—ã„ã€é¡§å®¢',intro:'èˆˆå‘³ã¯ã‚ã‚‹ã‚“ã§ã™ã‘ã©ã€æ­£ç›´ä»Šã™ã”ãå¿™ã—ãã¦ã€æ™‚é–“ãŒå–ã‚Œã‚‹ã‹ã©ã†ã‹â€¦'},
  spouse:{jp:'ã€Œé…å¶è€…ç›¸è«‡ã€é¡§å®¢',intro:'ã„ã„ã¨ã¯æ€ã†ã‚“ã§ã™ã‘ã©ã€ä¸€å¿œå¦»ã«ã‚‚ç›¸è«‡ã—ã¦ã‹ã‚‰ã˜ã‚ƒãªã„ã¨ã¡ã‚‡ã£ã¨â€¦'},
  doubt:{jp:'ã€ŒåŠ¹æœã‚ã‚‹ã®ï¼Ÿã€é¡§å®¢',intro:'AIãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ã£ã¦çµå±€ã©ã®ãã‚‰ã„å®Ÿéš›ã«ä½¿ãˆã‚‹ã‚“ã§ã™ã‹ï¼Ÿ'},
  custom:{jp:'å®Ÿå•†è«‡ãƒˆãƒ¬ãƒ¼ã‚¹é¡§å®¢',intro:'ï¼ˆãƒ­ã‚°ã‹ã‚‰è‡ªå‹•ç”Ÿæˆï¼‰'}
};
const DIFFICULTY={easy:'ã‚ãªãŸã¯æ¯”è¼ƒçš„ä¹—ã‚Šã‚„ã™ã„é¡§å®¢ã§ã™ã€‚è‰¯ã„ææ¡ˆã«ã¯ã™ãå‰ã®ã‚ã‚Šã«åå¿œã—ã¾ã™ã€‚ã—ã‹ã—æœ€ä½é™ã®è³ªå•ã¯ã—ã¾ã™ã€‚',medium:'ã‚ãªãŸã¯ãƒªã‚¢ãƒ«ãªé¡§å®¢ã§ã™ã€‚ç°¡å˜ã«ã¯ä¹—ã‚‰ãªã„ãŒã€ä¸Šæ‰‹ã„ãƒªãƒ•ãƒ¬ãƒ¼ãƒŸãƒ³ã‚°ã«ã¯åå¿œã—ã¾ã™ã€‚',hard:'ã‚ãªãŸã¯éå¸¸ã«é ‘å›ºãªé¡§å®¢ã§ã™ã€‚ä½•ã‚’è¨€ã‚ã‚Œã¦ã‚‚ç°¡å˜ã«ã¯ç´å¾—ã—ã¾ã›ã‚“ã€‚è«–ç†çš„ã«å®Œç’§ãªèª¬æ˜ã ã‘ã«å°‘ã—å¿ƒãŒå‹•ãã¾ã™ã€‚å¸¸ã«åè«–ã‚’æ¢ã—ã¾ã™ã€‚'};
const SCENARIOS={full:'è‡ªç”±ã«ä¼šè©±ã—ã¦ãã ã•ã„ã€‚',opening:'å•†è«‡ã®å†’é ­5åˆ†ã‚’æƒ³å®šã€‚è‡ªå·±ç´¹ä»‹â†’ãƒ’ã‚¢ãƒªãƒ³ã‚°â†’èª²é¡Œã®æ·±å €ã‚Šã¾ã§ã€‚ã¾ã å•†å“ææ¡ˆã¯ã—ãªã„ãƒ•ã‚§ãƒ¼ã‚ºã€‚',price_objection:'ã™ã§ã«å•†å“èª¬æ˜ã¯çµ‚ã‚ã£ã¦ã„ã‚‹ã€‚ä¾¡æ ¼ã‚’èã„ã¦ã€Œé«˜ã„ã€ã¨åå¿œã—ãŸç›´å¾Œã‹ã‚‰ä¼šè©±ã‚’å§‹ã‚ã¦ãã ã•ã„ã€‚',closing_3min:'å•†è«‡ã®çµ‚ç›¤ã€‚é¡§å®¢ã¯èˆˆå‘³ã¯ã‚ã‚‹ãŒæ±ºæ–­ã‚’è¿·ã£ã¦ã„ã‚‹çŠ¶æ…‹ã€‚ã“ã“ã‹ã‚‰3åˆ†ã§ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ³ã‚°ã¾ã§æŒã£ã¦ã„ãç·´ç¿’ã€‚'};
const SCENARIO_LABELS={full:'ãƒ•ãƒ«å•†è«‡',opening:'å†’é ­5åˆ†',price_objection:'ä¾¡æ ¼åˆ‡ã‚Šè¿”ã—',closing_3min:'CL 3åˆ†'};
const SUB_NAMES={authority:'æ¨©å¨æ€§',loss_aversion:'æå¤±å›é¿',reframing:'ãƒªãƒ•ãƒ¬ãƒ¼ãƒŸãƒ³ã‚°',anchoring:'ã‚¢ãƒ³ã‚«ãƒ¼',closing:'ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ³ã‚°',hearing:'ãƒ’ã‚¢ãƒªãƒ³ã‚°',rapport:'ãƒ©ãƒãƒ¼ãƒ«',objection:'åè«–å‡¦ç†',tempo:'ãƒ†ãƒ³ãƒ',proposal:'ææ¡ˆåŠ›'};
const ALL_SUBS=Object.keys(SUB_NAMES);

let ws=null,audioContext=null,processor=null,mediaStream=null,sessionActive=false;
let conversationLog=[],timerInterval=null,startTime=null,volumeAnimFrame=null,analyserNode=null;
let turnCount=0,playbackCtx=null,currentSource=null,silenceTimer=null;
let mediaRecorder=null,recordedChunks=[];
let liveAiBubble=null,liveAiText='';
let liveUserBubble=null,liveUserText='';
let turnHadAudio=false;
let scheduledSources=[];
let nextPlayTime=0;
let lobbyMicStream=null,lobbyAudioCtx=null,lobbyAnalyser=null;
let captionTimeout=null;
let worstWeakPoint=null;

// === SCREEN MANAGEMENT ===
function showScreen(name){
  document.querySelectorAll('.screen').forEach(s=>{
    s.classList.remove('active');
  });
  const el=document.getElementById('screen-'+name);
  if(el) el.classList.add('active');
}

// === INIT ===
updateHint();
initScoreBars();
loadApiKey();
loadHistory();

function initScoreBars(){
  const el=document.getElementById('scorePreview');
  if(!el)return;
  el.innerHTML='';
  ALL_SUBS.forEach(k=>{
    el.innerHTML+=`<div class="sp-item"><div class="n">${SUB_NAMES[k]}</div><div class="bg"><div class="fl" id="bar_${k}" style="width:50%"></div></div><div class="v" id="val_${k}">-</div></div>`;
  });
}

function updateHint(){document.getElementById('hintText').textContent=HINTS[document.getElementById('weakPoint').value]||''}
function loadApiKey(){const k=localStorage.getItem('rp_apikey');if(k){document.getElementById('apiKey').value=k;document.getElementById('saveKey').checked=true}}
function saveApiKey(){if(document.getElementById('saveKey').checked)localStorage.setItem('rp_apikey',document.getElementById('apiKey').value);else localStorage.removeItem('rp_apikey')}

function onPersonaChange(){
  document.getElementById('customPersonaBox').style.display=document.getElementById('persona').value==='custom'?'block':'none';
}

function updateLobbyName(){
  const name=document.getElementById('salesName').value.trim();
  document.getElementById('lobbyUserName').textContent=name||'æ‹…å½“è€…åã‚’å…¥åŠ›';
}

// === LOBBY MIC TEST ===
async function toggleLobbyMic(){
  const btn=document.getElementById('lobbyMicBtn');
  if(lobbyMicStream){
    lobbyMicStream.getTracks().forEach(t=>t.stop());
    lobbyMicStream=null;
    if(lobbyAudioCtx){lobbyAudioCtx.close();lobbyAudioCtx=null}
    lobbyAnalyser=null;
    btn.classList.remove('muted');
    btn.textContent='ğŸ¤';
    document.getElementById('lobbyMicFill').style.width='0%';
    document.getElementById('lobbyMicStatus').textContent='å¾…æ©Ÿä¸­';
    return;
  }
  try{
    lobbyMicStream=await navigator.mediaDevices.getUserMedia({audio:true});
    lobbyAudioCtx=new AudioContext();
    const src=lobbyAudioCtx.createMediaStreamSource(lobbyMicStream);
    lobbyAnalyser=lobbyAudioCtx.createAnalyser();
    lobbyAnalyser.fftSize=256;
    src.connect(lobbyAnalyser);
    btn.textContent='ğŸ¤';
    document.getElementById('lobbyMicStatus').textContent='ãƒ†ã‚¹ãƒˆä¸­';
    const data=new Uint8Array(lobbyAnalyser.frequencyBinCount);
    (function tick(){
      if(!lobbyAnalyser)return;
      lobbyAnalyser.getByteFrequencyData(data);
      const avg=data.reduce((a,b)=>a+b,0)/data.length;
      document.getElementById('lobbyMicFill').style.width=Math.min(100,avg*2)+'%';
      requestAnimationFrame(tick);
    })();
  }catch(e){
    document.getElementById('lobbyMicStatus').textContent='ãƒã‚¤ã‚¯ã‚¨ãƒ©ãƒ¼';
  }
}

// === STATUS ===
function setStatus(s,t){
  // Avatar ring state
  const ring=document.getElementById('aiAvatarRing');
  const indicator=document.getElementById('speakingIndicator');
  if(ring){
    ring.className='avatar-ring '+(s||'');
  }
  if(indicator){
    indicator.classList.toggle('active',s==='speaking'||s==='listening'||s==='thinking');
    if(s==='speaking') indicator.textContent='ç™ºè©±ä¸­...';
    else if(s==='listening') indicator.textContent='èã„ã¦ã„ã¾ã™...';
    else if(s==='thinking') indicator.textContent='æ¥ç¶šä¸­...';
    else indicator.textContent='';
  }
}

function updateTurnCount(){
  // no-op (header shows timer instead)
}

// === TRANSCRIPT MESSAGES ===
function addMsg(role,text){
  const container=document.getElementById('transcriptMessages');
  if(!container)return;
  const d=document.createElement('div');
  d.className='t-msg '+(role==='ai'?'t-ai':role==='system'?'t-system':'t-user');
  const t=new Date().toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  if(role==='system'){
    d.innerHTML=`<div class="t-text" style="color:var(--gold);font-size:12px">${text}</div>`;
  }else{
    const sender=role==='ai'?'é¡§å®¢ï¼ˆAIï¼‰':(document.getElementById('salesName').value||'ã‚ãªãŸ');
    d.innerHTML=`<div class="t-sender">${role==='ai'?'ğŸ‘¤':'ğŸ§‘â€ğŸ’¼'} ${sender}</div><div class="t-text">${text.replace(/\n/g,'<br>')}</div><div class="t-time">${t}</div>`;
  }
  conversationLog.push({role:role==='ai'?'é¡§å®¢':'å–¶æ¥­',text,time:t,ts:Date.now()});
  container.appendChild(d);
  container.scrollTop=container.scrollHeight;
  if(role==='user')turnCount++;

  // Show live caption
  if(role!=='system') showCaption(role,text);
}

function clearMsgs(){
  const c=document.getElementById('transcriptMessages');
  if(c)c.innerHTML='';
  conversationLog=[];turnCount=0;
  liveAiBubble=null;liveAiText='';
  liveUserBubble=null;liveUserText='';
  turnHadAudio=false;
}

// === LIVE TRANSCRIPT BUBBLES ===
function getOrCreateLiveBubble(role){
  const container=document.getElementById('transcriptMessages');
  if(!container) return null;
  if(role==='ai'){
    if(!liveAiBubble){
      const d=document.createElement('div');
      d.className='t-msg t-ai';
      const t=new Date().toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
      d.innerHTML=`<div class="t-sender">ğŸ‘¤ é¡§å®¢ï¼ˆAIï¼‰</div><div class="t-text live"></div><div class="t-time">${t}</div>`;
      container.appendChild(d);container.scrollTop=container.scrollHeight;
      liveAiBubble=d.querySelector('.t-text');
      liveAiText='';
    }
    return liveAiBubble;
  }else{
    if(!liveUserBubble){
      const d=document.createElement('div');
      d.className='t-msg t-user';
      const name=document.getElementById('salesName').value||'ã‚ãªãŸ';
      const t=new Date().toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
      d.innerHTML=`<div class="t-sender">ğŸ§‘â€ğŸ’¼ ${name}</div><div class="t-text live"></div><div class="t-time">${t}</div>`;
      container.appendChild(d);container.scrollTop=container.scrollHeight;
      liveUserBubble=d.querySelector('.t-text');
      liveUserText='';
    }
    return liveUserBubble;
  }
}

function appendTranscript(role,text){
  const bubble=getOrCreateLiveBubble(role);
  if(!bubble)return;
  if(role==='ai'){
    liveAiText+=text;
    bubble.innerHTML=liveAiText.replace(/\n/g,'<br>');
  }else{
    liveUserText+=text;
    bubble.innerHTML=liveUserText.replace(/\n/g,'<br>');
  }
  const c=document.getElementById('transcriptMessages');
  if(c)c.scrollTop=c.scrollHeight;

  // Also update live captions
  showCaption(role, role==='ai'?liveAiText:liveUserText);
}

function finalizeBubble(role){
  if(role==='ai'){
    if(liveAiBubble){
      liveAiBubble.classList.remove('live');
      if(liveAiText.trim()){
        conversationLog.push({role:'é¡§å®¢',text:liveAiText.trim(),time:new Date().toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit',second:'2-digit'}),ts:Date.now()});
      }
    }
    liveAiBubble=null;liveAiText='';
  }else if(role==='user'){
    if(liveUserBubble){
      liveUserBubble.classList.remove('live');
      if(liveUserText.trim()){
        conversationLog.push({role:'å–¶æ¥­',text:liveUserText.trim(),time:new Date().toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit',second:'2-digit'}),ts:Date.now()});
        turnCount++;
      }
    }
    liveUserBubble=null;liveUserText='';
  }
}

// === LIVE CAPTIONS ===
function showCaption(role,text){
  const el=document.getElementById('liveCaptions');
  const sender=document.getElementById('captionSender');
  const txt=document.getElementById('captionText');
  if(!el)return;
  sender.textContent=role==='ai'?'é¡§å®¢:':'ã‚ãªãŸ:';
  // Truncate to last 80 chars
  const display=text.length>80?'...'+text.slice(-80):text;
  txt.textContent=display;
  el.classList.add('visible');
  clearTimeout(captionTimeout);
  captionTimeout=setTimeout(()=>el.classList.remove('visible'),4000);
}

// === TIMER ===
function startTimer(){
  startTime=Date.now();
  timerInterval=setInterval(()=>{
    const s=Math.floor((Date.now()-startTime)/1000);
    const formatted=String(Math.floor(s/60)).padStart(2,'0')+':'+String(s%60).padStart(2,'0');
    const h=document.getElementById('callHeaderTimer');
    const b=document.getElementById('callBarTimer');
    if(h)h.textContent=formatted;
    if(b)b.textContent=formatted;
  },1000);
}

// === SILENCE HINT ===
function resetSilenceTimer(){
  clearTimeout(silenceTimer);
  silenceTimer=setTimeout(()=>{
    if(!sessionActive)return;
    const wp=document.getElementById('weakPoint').value;
    const hints={anchoring:'ğŸ’¡ ã€Œãã‚Œã¯æŠ•è³‡ã§ã™ã€ã¨è¨€ã„æ›ãˆã¦ã¿ã¾ã—ã‚‡ã†',authority:'ğŸ’¡ ã€Œãªãœãã†æ€ã„ã¾ã™ã‹ï¼Ÿã€ã¨è¿”ã—ã¦ã¿ã¾ã—ã‚‡ã†',loss_aversion:'ğŸ’¡ ã€Œ3å¹´å¾Œã®è‡ªåˆ†ã‚’æƒ³åƒã—ã¦ã¿ã¦ãã ã•ã„ã€',reframing:'ğŸ’¡ ã€Œã‚¹ã‚¯ãƒ¼ãƒ«ã§ã¯ãªãç¤¾å†…ç ”ä¿®ã§ã™ã€ã¨å®šç¾©ã—ç›´ã—ã¾ã—ã‚‡ã†',closing:'ğŸ’¡ ã€Œã§ã¯æ‰‹ç¶šãã«ç§»ã‚Šã¾ã—ã‚‡ã†ã€ã¨è¨€ã„åˆ‡ã£ã¦ã¿ã¾ã—ã‚‡ã†'};
    addMsg('system',hints[wp]||'ğŸ’¡ ä½•ã‹è©±ã—ã‹ã‘ã¦ã¿ã¾ã—ã‚‡ã†');
  },15000);
}

// === JOIN MEETING ===
function joinMeeting(){
  const apiKey=document.getElementById('apiKey').value.trim();
  if(!apiKey){alert('API Keyã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆè©³ç´°è¨­å®šå†…ï¼‰');return}

  // Stop lobby mic test if running
  if(lobbyMicStream){
    lobbyMicStream.getTracks().forEach(t=>t.stop());
    lobbyMicStream=null;
    if(lobbyAudioCtx){lobbyAudioCtx.close();lobbyAudioCtx=null}
    lobbyAnalyser=null;
  }

  // Set up call screen info
  const persona=PERSONAS[document.getElementById('persona').value];
  const scenarioKey=document.getElementById('scenario').value;
  document.getElementById('callScenarioBadge').textContent=SCENARIO_LABELS[scenarioKey]||'';
  document.getElementById('aiPersonaLabel').textContent=persona?.jp||'';
  document.getElementById('pipName').textContent=document.getElementById('salesName').value||'ã‚ãªãŸ';

  showScreen('call');
  startSession();
}

// === GEMINI LIVE API ===
async function startSession(){
  const apiKey=document.getElementById('apiKey').value.trim();
  saveApiKey();
  clearMsgs();
  document.getElementById('btnCallGrade').disabled=true;
  setStatus('thinking','æ¥ç¶šä¸­...');

  const persona=PERSONAS[document.getElementById('persona').value];
  const product=document.getElementById('product').value;
  const weakPoint=document.getElementById('weakPoint').value;
  const salesName=document.getElementById('salesName').value||'å–¶æ¥­æ‹…å½“';
  const diff=DIFFICULTY[document.getElementById('difficulty').value];
  const scn=SCENARIOS[document.getElementById('scenario').value];
  const isCustom=document.getElementById('persona').value==='custom';
  const customLog=isCustom?document.getElementById('customTranscript').value.trim():'';

  let systemPrompt;
  if(isCustom&&customLog){
    systemPrompt=`ã‚ãªãŸã¯æ—¥æœ¬äººã®é¡§å®¢å½¹ã§ã™ã€‚å¿…ãšæ—¥æœ¬èªã ã‘ã§è©±ã—ã¦ãã ã•ã„ã€‚è‹±èªã¯çµ¶å¯¾ã«ä½¿ã‚ãªã„ã§ãã ã•ã„ã€‚

ä»¥ä¸‹ã¯å®Ÿéš›ã®å•†è«‡ã§å¤±æ³¨ã—ãŸé¡§å®¢ã®ä¼šè©±ãƒ­ã‚°ã§ã™ã€‚ã“ã®é¡§å®¢ã®è©±ã—æ–¹ã€æ€è€ƒãƒ‘ã‚¿ãƒ¼ãƒ³ã€åè«–ã®ä»•æ–¹ã€å£ç™–ã‚’ãƒˆãƒ¬ãƒ¼ã‚¹ã—ã¦ã€åŒã˜ã‚¿ã‚¤ãƒ—ã®é¡§å®¢ã¨ã—ã¦æŒ¯ã‚‹èˆã£ã¦ãã ã•ã„ã€‚

ã€å®Ÿå•†è«‡ãƒ­ã‚°ã€‘
${customLog.substring(0,3000)}

ã€ãƒ«ãƒ¼ãƒ«ã€‘
- ä¸Šè¨˜ãƒ­ã‚°ã®é¡§å®¢ã®è©±ã—æ–¹ãƒ»æ€§æ ¼ãƒ»åè«–ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å†ç¾ã™ã‚‹
- å¿…ãšæ—¥æœ¬èªã®ã¿ã€‚è‹±èªç¦æ­¢ã€‚
- 1å›ã®ç™ºè¨€ã¯çŸ­ãï¼ˆ1ã€œ2æ–‡ï¼‰
- ${diff}
- ${scn}
- ãƒ¡ã‚¿çš„ãªèª¬æ˜ã¯ä¸è¦ã€‚é¡§å®¢ã¨ã—ã¦ç›´æ¥ä¼šè©±ã™ã‚‹ã€‚

ã“ã®é¡§å®¢ã«ãªã‚Šãã£ã¦ã€æœ€åˆã®ç™ºè¨€ã‚’ã—ã¦ãã ã•ã„ã€‚`;
  }else{
    systemPrompt=`ã‚ãªãŸã¯æ—¥æœ¬äººã®é¡§å®¢å½¹ã§ã™ã€‚å¿…ãšæ—¥æœ¬èªã ã‘ã§è©±ã—ã¦ãã ã•ã„ã€‚è‹±èªã¯çµ¶å¯¾ã«ä½¿ã‚ãªã„ã§ãã ã•ã„ã€‚

ã‚ãªãŸã¯ã€Œ${persona.jp}ã€ã¨ã—ã¦ã€${product}ã®å–¶æ¥­æ‹…å½“ã€Œ${salesName}ã•ã‚“ã€ã¨éŸ³å£°ã§ä¼šè©±ã™ã‚‹é¡§å®¢ã§ã™ã€‚

ã€å½¹æŸ„ã€‘
- æ—¥æœ¬äººã®30ä»£ä¼šç¤¾å“¡
- æœ€åˆã®ç™ºè¨€: ã€Œ${persona.intro}ã€
- ${diff}

ã€ãƒ«ãƒ¼ãƒ«ã€‘
- å¿…ãšæ—¥æœ¬èªã®ã¿ã§è©±ã™ã€‚è‹±èªç¦æ­¢ã€‚
- å–¶æ¥­ã®å¼±ç‚¹ï¼ˆ${weakPoint}ï¼‰ã‚’çªãåå¿œã‚’ã™ã‚‹
- 1å›ã®ç™ºè¨€ã¯çŸ­ãï¼ˆ1ã€œ2æ–‡ï¼‰
- ã€Œã‚ãƒ¼ã€ã€Œã†ã‚“ã†ã‚“ã€ã€Œãªã‚‹ã»ã©ã€ã¨è‡ªç„¶ã«ç›¸æ§Œ
- ${scn}
- ãƒ¡ã‚¿çš„ãªèª¬æ˜ã¯ä¸è¦ã€‚é¡§å®¢ã¨ã—ã¦ç›´æ¥ä¼šè©±ã™ã‚‹ã€‚

æœ€åˆã®ã‚»ãƒªãƒ•ã€Œ${persona.intro}ã€ã‚’æ—¥æœ¬èªã§è©±ã—å§‹ã‚ã¦ãã ã•ã„ã€‚`;
  }

  const MODEL=document.getElementById('modelName').value;
  const wsUrl=`wss://generativelanguage.googleapis.com/ws/google.ai.generativelanguage.v1beta.GenerativeService.BidiGenerateContent?key=${apiKey}`;

  try{
    ws=new WebSocket(wsUrl);
    addMsg('system','æ¥ç¶šä¸­... ('+MODEL+')');
    const connectTimeout=setTimeout(()=>{
      if(!sessionActive){setStatus('','æ¥ç¶šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ');showScreen('lobby');if(ws)ws.close()}
    },10000);

    ws.onopen=()=>{
      const setupPayload={
        setup:{
          model:`models/${MODEL}`,
          generation_config:{
            response_modalities:['AUDIO'],
            speech_config:{
              voice_config:{prebuilt_voice_config:{voice_name:'Puck'}},
              language_code:'ja-JP'
            }
          },
          system_instruction:{parts:[{text:systemPrompt}]}
        }
      };
      console.log('Setup payload:', JSON.stringify(setupPayload).substring(0,500));
      ws.send(JSON.stringify(setupPayload));
    };

    ws.onmessage=async(e)=>{
      const raw=typeof e.data==='string'?e.data:await e.data.text();
      console.log('WS received:', raw.substring(0,300));
      const data=JSON.parse(raw);

      if(data.setupComplete){
        clearTimeout(connectTimeout);
        setStatus('listening','ãƒ­ãƒ¼ãƒ—ãƒ¬é–‹å§‹ï¼');
        sessionActive=true;startTimer();startRecording();
        addMsg('system','æ¥ç¶šæˆåŠŸ');
        ws.send(JSON.stringify({client_content:{turns:[{role:'user',parts:[{text:'ä¼šè©±ã‚’å§‹ã‚ã¦ãã ã•ã„'}]}],turn_complete:true}}));
        await startMicrophone();
        startAvatarAnimation();
        resetSilenceTimer();
        return;
      }

      if(data.serverContent?.modelTurn?.parts){
        let hasAudio=false;
        for(const p of data.serverContent.modelTurn.parts){
          if(p.inlineData?.mimeType?.startsWith('audio/')){playAudioChunk(p.inlineData.data);hasAudio=true;}
        }
        if(hasAudio){setStatus('speaking','AIé¡§å®¢ãŒè©±ã—ã¦ã„ã¾ã™...');turnHadAudio=true;}
      }

      if(data.serverContent?.outputTranscript?.text){
        appendTranscript('ai',data.serverContent.outputTranscript.text);
      }
      if(data.serverContent?.inputTranscript?.text){
        appendTranscript('user',data.serverContent.inputTranscript.text);
        finalizeBubble('user');
        resetSilenceTimer();
      }else if(typeof data.serverContent?.inputTranscript==='string'&&data.serverContent.inputTranscript){
        appendTranscript('user',data.serverContent.inputTranscript);
        finalizeBubble('user');
        resetSilenceTimer();
      }

      if(data.serverContent?.interrupted){clearAudioQueue();setStatus('listening','å‰²ã‚Šè¾¼ã¿æ¤œçŸ¥')}

      if(data.serverContent?.turnComplete){
        if(!liveAiText.trim()&&turnHadAudio){
          conversationLog.push({role:'é¡§å®¢',text:'(éŸ³å£°ç™ºè¨€)',time:new Date().toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit',second:'2-digit'}),ts:Date.now()});
        }
        finalizeBubble('ai');
        turnHadAudio=false;
        setStatus('listening','ã‚ãªãŸã®ç•ªã§ã™');
        resetSilenceTimer();
      }

      if(data.error){
        console.error('Gemini Error:',data.error);
        setStatus('','ã‚¨ãƒ©ãƒ¼');
        addMsg('system','âŒ '+JSON.stringify(data.error));
        stopSession();
        showScreen('lobby');
      }
    };

    ws.onerror=(e)=>{console.error('WS Error',e);clearTimeout(connectTimeout);setStatus('','æ¥ç¶šã‚¨ãƒ©ãƒ¼');addMsg('system','âŒ WebSocketæ¥ç¶šã‚¨ãƒ©ãƒ¼');stopSession();showScreen('lobby')};
    ws.onclose=(e)=>{console.log('WS Close: code='+e.code+' reason='+e.reason);clearTimeout(connectTimeout);if(sessionActive){setStatus('','ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†');sessionActive=false}else{setStatus('','æ¥ç¶šå¤±æ•— (code:'+e.code+')');addMsg('system','âŒ code:'+e.code+' â€” '+e.reason);showScreen('lobby')}};
  }catch(err){alert('æ¥ç¶šå¤±æ•—: '+err.message);showScreen('lobby')}
}

// === MIC ===
async function startMicrophone(){
  try{
    mediaStream=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:true,noiseSuppression:true,autoGainControl:true}});
    audioContext=new AudioContext({sampleRate:16000});
    await audioContext.audioWorklet.addModule('data:application/javascript,'+encodeURIComponent(WORKLET_CODE));
    const src=audioContext.createMediaStreamSource(mediaStream);
    analyserNode=audioContext.createAnalyser();analyserNode.fftSize=256;
    src.connect(analyserNode);
    processor=new AudioWorkletNode(audioContext,'pcm-processor');
    src.connect(processor);
    processor.port.onmessage=(e)=>{if(!ws||ws.readyState!==1||!sessionActive)return;ws.send(JSON.stringify({realtime_input:{media_chunks:[{mime_type:'audio/pcm;rate=16000',data:ab2b64(e.data)}]}}))};
    processor.connect(audioContext.destination);
    startVolMon();
  }catch(err){addMsg('system','âš ï¸ ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã«å¤±æ•—: '+err.message)}
}
const WORKLET_CODE=`class PcmProcessor extends AudioWorkletProcessor{constructor(){super();this._b=new Int16Array(1024);this._p=0}process(i){const d=i[0]?.[0];if(!d)return true;for(let j=0;j<d.length;j++){this._b[this._p++]=Math.max(-32768,Math.min(32767,d[j]*32768));if(this._p>=this._b.length){this.port.postMessage(this._b.buffer.slice(0));this._p=0}}return true}}registerProcessor('pcm-processor',PcmProcessor);`;

function ab2b64(buf){const b=new Uint8Array(buf);let s='';for(let i=0;i<b.byteLength;i++)s+=String.fromCharCode(b[i]);return btoa(s)}

function startVolMon(){
  const pip=document.getElementById('pipContainer');
  const data=new Uint8Array(analyserNode.frequencyBinCount);
  (function tick(){
    if(!sessionActive)return;
    analyserNode.getByteFrequencyData(data);
    const avg=data.reduce((a,b)=>a+b,0)/data.length;
    // PiP speaking indicator
    if(pip) pip.classList.toggle('user-speaking',avg>15);
    volumeAnimFrame=requestAnimationFrame(tick);
  })();
}

// === AVATAR RING ANIMATION ===
function startAvatarAnimation(){
  const glow=document.getElementById('avatarGlow');
  const ring=document.getElementById('aiAvatarRing');
  if(!glow||!ring)return;
  (function animate(){
    if(!sessionActive)return;
    // If we have audio playing (speaking state), pulse the glow
    if(ring.classList.contains('speaking')&&scheduledSources.length>0){
      const intensity=Math.min(1,scheduledSources.length/3);
      glow.style.boxShadow=`0 0 ${20+intensity*30}px rgba(52,168,83,${0.15+intensity*0.3})`;
      glow.style.borderColor=`rgba(52,168,83,${0.2+intensity*0.3})`;
    }else{
      glow.style.boxShadow='none';
      glow.style.borderColor='transparent';
    }
    requestAnimationFrame(animate);
  })();
}

// === MIC TOGGLE ===
function toggleMic(){
  if(!mediaStream)return;
  const track=mediaStream.getAudioTracks()[0];
  if(!track)return;
  track.enabled=!track.enabled;
  const btn=document.getElementById('btnMicToggle');
  btn.classList.toggle('muted',!track.enabled);
  btn.textContent=track.enabled?'ğŸ¤':'ğŸ”‡';
  const pipMic=document.getElementById('pipMic');
  if(pipMic)pipMic.textContent=track.enabled?'ğŸ¤':'ğŸ”‡';
}

// === TRANSCRIPT TOGGLE ===
function toggleTranscript(){
  const panel=document.getElementById('transcriptPanel');
  panel.classList.toggle('hidden');
  document.getElementById('btnTranscript').classList.toggle('active',!panel.classList.contains('hidden'));
}

// === PLAYBACK ===
function getPlayCtx(){
  if(!playbackCtx||playbackCtx.state==='closed'){playbackCtx=new AudioContext({sampleRate:24000})}
  return playbackCtx;
}
function clearAudioQueue(){
  scheduledSources.forEach(s=>{try{s.stop()}catch(e){}});
  scheduledSources=[];nextPlayTime=0;
}
function playAudioChunk(b64){
  const raw=atob(b64);const bytes=new Uint8Array(raw.length);
  for(let i=0;i<raw.length;i++)bytes[i]=raw.charCodeAt(i);
  const pcm=new Int16Array(bytes.buffer);const f32=new Float32Array(pcm.length);
  for(let i=0;i<pcm.length;i++)f32[i]=pcm[i]/32768;
  const ctx=getPlayCtx();
  const buf=ctx.createBuffer(1,f32.length,24000);
  buf.getChannelData(0).set(f32);
  const s=ctx.createBufferSource();s.buffer=buf;s.connect(ctx.destination);
  const now=ctx.currentTime;
  if(nextPlayTime<now)nextPlayTime=now;
  s.start(nextPlayTime);nextPlayTime+=buf.duration;
  scheduledSources.push(s);
  s.onended=()=>{scheduledSources=scheduledSources.filter(x=>x!==s)};
}

// === RECORDING ===
function startRecording(){
  try{
    const dest=new AudioContext();
    const combined=dest.createMediaStreamDestination();
    mediaRecorder=new MediaRecorder(combined.stream,{mimeType:'audio/webm'});
    recordedChunks=[];
    mediaRecorder.ondataavailable=e=>{if(e.data.size>0)recordedChunks.push(e.data)};
    mediaRecorder.start(1000);
  }catch(e){console.warn('Recording not supported:',e)}
}
function stopRecording(){if(mediaRecorder&&mediaRecorder.state!=='inactive'){mediaRecorder.stop()}}

// === END CALL ===
function endCall(){
  stopSession();
  if(conversationLog.length>=2){
    // Show option to grade
    document.getElementById('btnCallGrade').disabled=false;
    setStatus('','é€šè©±çµ‚äº†ã€‚æ¡ç‚¹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„');
    // Also offer to go back
    setTimeout(()=>{
      if(document.getElementById('screen-call').classList.contains('active')){
        // Still on call screen, give them a chance to grade
      }
    },500);
  }else{
    showScreen('lobby');
  }
}

function gradeFromCall(){
  gradeSession();
}

// === STOP SESSION ===
function stopSession(){
  sessionActive=false;clearTimeout(silenceTimer);
  if(volumeAnimFrame)cancelAnimationFrame(volumeAnimFrame);
  if(processor){processor.disconnect();processor=null}
  if(audioContext){audioContext.close();audioContext=null}
  if(playbackCtx){clearAudioQueue();playbackCtx.close();playbackCtx=null}
  if(mediaStream){mediaStream.getTracks().forEach(t=>t.stop());mediaStream=null}
  if(ws){ws.close();ws=null}
  if(timerInterval){clearInterval(timerInterval);timerInterval=null}
  stopRecording();
  analyserNode=null;
}

// === GRADING ===
async function gradeSession(){
  const apiKey=document.getElementById('apiKey').value.trim();
  if(!apiKey)return;
  const gradeBtn=document.getElementById('btnCallGrade');
  if(gradeBtn){gradeBtn.disabled=true;gradeBtn.textContent='â³'}
  setStatus('thinking','æ¡ç‚¹ä¸­...');

  const logText=conversationLog.filter(m=>m.role!=='system').map(m=>`ã€${m.role}ã€‘${m.text}`).join('\n');
  const wp=document.getElementById('weakPoint').value;

  const prompt=`ã‚ãªãŸã¯ISAIå‹ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ³ã‚°å•†è«‡ã®AIã‚³ãƒ¼ãƒã§ã™ã€‚ä»¥ä¸‹ã®ãƒ­ãƒ¼ãƒ—ãƒ¬ä¼šè©±ã‚’å³å¯†ã«æ¡ç‚¹ã—ã¦ãã ã•ã„ã€‚
åŒã˜ä¼šè©±ãƒ­ã‚°ã‚’ä½•åº¦æ¡ç‚¹ã—ã¦ã‚‚åŒã˜ç‚¹æ•°ã«ãªã‚‹ã‚ˆã†ã€ä»¥ä¸‹ã®ãƒ«ãƒ–ãƒªãƒƒã‚¯ã«å¾“ã£ã¦ãã ã•ã„ã€‚

# ãƒ­ãƒ¼ãƒ—ãƒ¬ä¼šè©±ãƒ­ã‚°
${logText}

# æ¡ç‚¹ãƒ«ãƒ–ãƒªãƒƒã‚¯ï¼ˆå„10ç‚¹æº€ç‚¹ã€åˆè¨ˆ100ç‚¹ï¼‰
å„è»¸ã®æ¡ç‚¹åŸºæº–:
- 0-2ç‚¹: è©²å½“ã™ã‚‹è¡Œå‹•ãŒå…¨ããªã„ã€‚è©¦ã¿ã™ã‚‰è¦‹ã‚‰ã‚Œãªã„ã€‚
- 3-4ç‚¹: è©¦ã¿ã¯ã‚ã‚‹ãŒä¸ååˆ†ã¾ãŸã¯é€†åŠ¹æœã€‚é¡§å®¢ã«éŸ¿ã„ã¦ã„ãªã„ã€‚
- 5-6ç‚¹: åŸºæœ¬ã¯ã§ãã¦ã„ã‚‹ãŒæ·±ã¿ãŒãªã„ã€‚å°æœ¬é€šã‚Šã®åŸºæº–ç‚¹ã€‚
- 7-8ç‚¹: åŠ¹æœçš„ã«å®Ÿè¡Œã€‚é¡§å®¢ã®åå¿œã‚’å¼•ãå‡ºã›ã¦ã„ã‚‹ã€‚
- 9-10ç‚¹: å“è¶Šã€‚é¡§å®¢ã®æ„Ÿæƒ…ãŒæ˜ç¢ºã«å‹•ã„ãŸè¨¼æ‹ ã‚ã‚Šã€‚

## 10è»¸ã®è©•ä¾¡åŸºæº–
1. æ¨©å¨æ€§: ã€Œé¸ã¶å´ã€ã®ã‚¹ã‚¿ãƒ³ã‚¹ç¶­æŒã€‚
2. æå¤±å›é¿: ç¾çŠ¶ç¶­æŒã®ãƒªã‚¹ã‚¯ã‚’å…·ä½“çš„ã«æŒ‡æ‘˜ã€‚
3. ãƒªãƒ•ãƒ¬ãƒ¼ãƒŸãƒ³ã‚°: å®šç¾©å¤‰æ›´ã€‚
4. ã‚¢ãƒ³ã‚«ãƒªãƒ³ã‚°: è²»ç”¨ã‚’æŠ•è³‡ã¨å®šç¾©ã€‚
5. ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ³ã‚°: è¨€ã„åˆ‡ã‚Šèª˜å°ã€‚
6. ãƒ’ã‚¢ãƒªãƒ³ã‚°: èª²é¡Œã®æ·±å €ã‚Šã€‚
7. ãƒ©ãƒãƒ¼ãƒ«: ä¿¡é ¼é–¢ä¿‚æ§‹ç¯‰ã€‚
8. åè«–å‡¦ç†: åˆ‡ã‚Šè¿”ã—ã€‚
9. ãƒ†ãƒ³ãƒ: ä¼šè©±ãƒªã‚ºãƒ ã€‚
10. ææ¡ˆåŠ›: å…·ä½“çš„æ´»ç”¨ã‚¤ãƒ¡ãƒ¼ã‚¸ã€‚

# é‡ç‚¹ãƒã‚§ãƒƒã‚¯: å¼±ç‚¹ã€Œ${wp}ã€ã«ç‰¹ã«å³ã—ã

# å‡ºåŠ›ãƒ«ãƒ¼ãƒ«
- å„è»¸ã«evidenceï¼ˆæ ¹æ‹ ç™ºè¨€ã®å¼•ç”¨ï¼‰ã¨deductionï¼ˆæ¸›ç‚¹ç†ç”±ï¼‰ã‚’ä»˜ã‘ã‚‹
- ãƒ«ãƒ–ãƒªãƒƒã‚¯ã«å¿ å®Ÿãªå®¢è¦³çš„æ¡ç‚¹

# å‡ºåŠ›(JSON)
{
  "total":åˆè¨ˆç‚¹æ•°å€¤,
  "sub":{
    "authority":{"score":æ•°å€¤,"evidence":"æ ¹æ‹ ç™ºè¨€","deduction":"æ¸›ç‚¹ç†ç”±"},
    "loss_aversion":{"score":æ•°å€¤,"evidence":"","deduction":""},
    "reframing":{"score":æ•°å€¤,"evidence":"","deduction":""},
    "anchoring":{"score":æ•°å€¤,"evidence":"","deduction":""},
    "closing":{"score":æ•°å€¤,"evidence":"","deduction":""},
    "hearing":{"score":æ•°å€¤,"evidence":"","deduction":""},
    "rapport":{"score":æ•°å€¤,"evidence":"","deduction":""},
    "objection":{"score":æ•°å€¤,"evidence":"","deduction":""},
    "tempo":{"score":æ•°å€¤,"evidence":"","deduction":""},
    "proposal":{"score":æ•°å€¤,"evidence":"","deduction":""}
  },
  "feedback":"è¾›å£ã ãŒå»ºè¨­çš„ãªç·è©•(200å­—)",
  "best_moment":"ä¸€ç•ªè‰¯ã‹ã£ãŸç¬é–“",
  "ideal":"å¼±ç‚¹ã‚·ãƒ¼ãƒ³ã§ã®ç†æƒ³ãƒˆãƒ¼ã‚¯ä¾‹",
  "timeline":[{"time":"ç§’æ•°","event":"ä½•ãŒèµ·ããŸã‹","evaluation":"è‰¯ã„/æ‚ªã„/æ™®é€š","comment":"ä¸€è¨€"}]
}`;

  try{
    const res=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`,{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({contents:[{role:'user',parts:[{text:prompt}]}],generationConfig:{responseMimeType:'application/json',temperature:0}})
    });
    const json=await res.json();
    let raw=json.candidates?.[0]?.content?.parts?.[0]?.text||'{}';
    raw=raw.replace(/```json/g,'').replace(/```/g,'').trim();
    const result=JSON.parse(raw);
    if(result.sub){
      const norm={};
      Object.entries(result.sub).forEach(([k,v])=>{norm[k]=typeof v==='object'?v:{score:v,evidence:'',deduction:''}});
      result.sub=norm;
    }
    showResult(result);
    saveHistory(result);
    saveUsage(result);
    postToGAS(result);
  }catch(e){alert('æ¡ç‚¹ã‚¨ãƒ©ãƒ¼: '+e.message);showScreen('lobby')}

  if(gradeBtn){gradeBtn.disabled=false;gradeBtn.textContent='ğŸ“Š'}
}

function showResult(r){
  const dur=startTime?Math.floor((Date.now()-startTime)/1000):0;
  const durStr=String(Math.floor(dur/60)).padStart(2,'0')+':'+String(dur%60).padStart(2,'0');
  const persona=PERSONAS[document.getElementById('persona').value];
  const personaName=persona?.jp||'ã‚«ã‚¹ã‚¿ãƒ ';
  const dateStr=new Date().toLocaleDateString('ja-JP');

  // --- Session visual card ---
  document.getElementById('resultPersonaName').textContent=personaName;
  document.getElementById('resultSessionMeta2').textContent=`${dateStr} ãƒ» é›£æ˜“åº¦: ${document.getElementById('difficulty')?.selectedOptions[0]?.text||'ä¸­'}`;
  document.getElementById('resultDuration').textContent=durStr;
  document.getElementById('resultDate').textContent=dateStr;
  document.getElementById('resultTurns').textContent=turnCount;
  document.getElementById('resultsBreadcrumbTitle').textContent=`${personaName} - åˆ†æçµæœ`;

  // Streak badge
  updateStreak(); updateTitle(r.total);
  const h=JSON.parse(localStorage.getItem('rp_history')||'[]');
  const days=new Set(h.map(i=>i.date));
  let streak=0;let dd=new Date();
  while(days.has(dd.toLocaleDateString('ja-JP'))){streak++;dd.setDate(dd.getDate()-1)}
  document.getElementById('resultStreakArea').innerHTML=streak>=2?
    `<span class="text-xs font-bold text-orange-400 bg-orange-900/40 px-2 py-0.5 rounded-full">ğŸ”¥ ${streak}æ—¥é€£ç¶š</span>`:'';

  // --- Phase markers from timeline ---
  const phaseContainer=document.getElementById('resultPhaseContainer');
  const phaseIcons=[
    {icon:'waving_hand',color:'primary',bg:'bg-primary/10 border-primary/20',text:'text-primary'},
    {icon:'report_problem',color:'orange',bg:'bg-orange-100 border-orange-200',text:'text-orange-700'},
    {icon:'check_circle',color:'green',bg:'bg-green-100 border-green-200',text:'text-green-700'},
    {icon:'handshake',color:'blue',bg:'bg-blue-100 border-blue-200',text:'text-blue-700'}
  ];
  if(r.timeline?.length){
    phaseContainer.innerHTML=r.timeline.map((t,i)=>{
      const pi=phaseIcons[i%phaseIcons.length];
      return `<div class="flex items-center gap-2 px-3 py-1.5 rounded-lg ${pi.bg} border">
        <span class="material-symbols-outlined ${pi.text}" style="font-size:16px">${pi.icon}</span>
        <span class="text-xs font-semibold ${pi.text}">${t.event}</span>
      </div>`;
    }).join('');
  }else{
    phaseContainer.innerHTML=['å°å…¥','å±•é–‹','ææ¡ˆ','ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ³ã‚°'].map((label,i)=>{
      const pi=phaseIcons[i];
      return `<div class="flex items-center gap-2 px-3 py-1.5 rounded-lg ${pi.bg} border">
        <span class="material-symbols-outlined ${pi.text}" style="font-size:16px">${pi.icon}</span>
        <span class="text-xs font-semibold ${pi.text}">${label}</span>
      </div>`;
    }).join('');
  }

  // --- Score circle animation ---
  showScreen('results');
  const scoreEl=document.getElementById('resultScore');
  const arcEl=document.getElementById('resultScoreArc');
  const labelEl=document.getElementById('resultScoreLabel');
  scoreEl.textContent='0';
  const total=r.total||0;
  const circumference=2*Math.PI*52; // ~326.73
  const targetOffset=circumference*(1-total/100);
  labelEl.textContent=total>=80?'éå¸¸ã«è‰¯å¥½':total>=60?'è‰¯å¥½':total>=40?'æ”¹å–„ã®ä½™åœ°ã‚ã‚Š':'è¦æ”¹å–„';

  let scoreCount=0;
  const scoreStep=Math.ceil(total/40);
  const scoreAnim=setInterval(()=>{
    scoreCount=Math.min(scoreCount+scoreStep,total);
    scoreEl.textContent=scoreCount;
    arcEl.setAttribute('stroke-dashoffset',circumference*(1-scoreCount/100));
    if(scoreCount>=total)clearInterval(scoreAnim);
  },20);

  // --- Top 4 sub-scores grid ---
  const subEntries=Object.entries(r.sub||{});
  const topScoresEl=document.getElementById('resultTopScores');
  // Pick top 4 highest scores to feature
  const sortedForTop=[...subEntries].map(([k,v])=>[k,typeof v==='object'?v.score:v]).sort((a,b)=>b[1]-a[1]);
  const top4=sortedForTop.slice(0,4);
  topScoresEl.innerHTML=top4.map(([k,sc])=>
    `<div class="p-3 bg-slate-50 rounded-lg">
      <p class="text-xs text-slate-500">${SUB_NAMES[k]||k}</p>
      <p class="text-lg font-bold text-slate-900">${sc*10}%</p>
    </div>`
  ).join('');

  // --- Radar Chart ---
  const radarKeys=Object.keys(SUB_NAMES);
  const radarScores=radarKeys.map(k=>{
    const v=r.sub?.[k];
    return typeof v==='object'?v.score:(v||5);
  });
  const n=radarKeys.length;
  const cx=50,cy=50,maxR=42;
  const points=radarScores.map((sc,i)=>{
    const angle=(2*Math.PI*i/n)-Math.PI/2;
    const ratio=sc/10;
    const x=cx+maxR*ratio*Math.cos(angle);
    const y=cy+maxR*ratio*Math.sin(angle);
    return `${x.toFixed(1)},${y.toFixed(1)}`;
  }).join(' ');
  document.getElementById('resultRadarPolygon').setAttribute('points',points);

  // Radar labels
  const labelsEl=document.getElementById('resultRadarLabels');
  const labelPositions=[
    {cls:'absolute -top-5 left-1/2 -translate-x-1/2'},  // top
    {cls:'absolute top-[10%] -right-16'},
    {cls:'absolute top-[35%] -right-20'},
    {cls:'absolute bottom-[15%] -right-16'},
    {cls:'absolute bottom-0 right-[15%]'},
    {cls:'absolute bottom-0 left-[15%]'},
    {cls:'absolute bottom-[15%] -left-16'},
    {cls:'absolute top-[35%] -left-20'},
    {cls:'absolute top-[10%] -left-16'},
    {cls:'absolute -top-5 right-[20%]'},
  ];
  labelsEl.innerHTML=radarKeys.map((k,i)=>{
    const pos=labelPositions[i%labelPositions.length];
    return `<div class="${pos.cls} text-[9px] font-bold text-slate-500 whitespace-nowrap">${SUB_NAMES[k]}</div>`;
  }).join('');

  // Competency stats
  const avgScore=(radarScores.reduce((a,b)=>a+b,0)/n).toFixed(1);
  const compStats=document.getElementById('resultCompetencyStats');
  compStats.innerHTML=`
    <div class="flex justify-between items-center">
      <span class="text-sm font-medium">å¹³å‡ã‚¹ã‚³ã‚¢</span>
      <span class="text-sm font-bold">${avgScore}/10</span>
    </div>
    <div class="flex justify-between items-center">
      <span class="text-sm font-medium">ä¼šè©±å¾€å¾©æ•°</span>
      <span class="text-sm font-bold">${turnCount}å›</span>
    </div>
    <div class="flex justify-between items-center">
      <span class="text-sm font-medium">ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“</span>
      <span class="text-sm font-bold">${durStr}</span>
    </div>
  `;

  // --- Transcript ---
  const transcriptEl=document.getElementById('resultTranscript');
  const countEl=document.getElementById('resultTranscriptCount');
  const logs=conversationLog.filter(m=>m.role!=='system');
  countEl.textContent=`${logs.length}ä»¶`;
  transcriptEl.innerHTML=logs.map(m=>{
    const isAI=m.role==='é¡§å®¢';
    return `<div class="space-y-1">
      <div class="flex items-center justify-between">
        <span class="text-xs font-bold ${isAI?'text-primary':'text-slate-900'} uppercase tracking-wider">${isAI?'AI é¡§å®¢':'ã‚ãªãŸï¼ˆå–¶æ¥­ï¼‰'}</span>
        <span class="text-xs text-slate-400">${m.time||''}</span>
      </div>
      <p class="text-sm text-slate-700 leading-relaxed ${isAI?'':'bg-primary/5 p-2 rounded-lg border-l-2 border-primary'}">${m.text}</p>
    </div>`;
  }).join('');

  // --- AI Coaching Insights ---
  const insightsEl=document.getElementById('resultCoachingInsights');
  let insightsHTML='';

  // Best moment
  if(r.best_moment){
    insightsHTML+=`<div class="p-4 rounded-lg bg-primary/5 border border-primary/10 space-y-2">
      <div class="flex items-center gap-2">
        <span class="material-symbols-outlined text-primary" style="font-size:18px">lightbulb</span>
        <span class="text-sm font-bold">åŠ¹æœçš„ã ã£ãŸãƒã‚¤ãƒ³ãƒˆ</span>
      </div>
      <p class="text-xs text-slate-600 leading-relaxed">${r.best_moment}</p>
    </div>`;
  }

  // Feedback
  if(r.feedback){
    insightsHTML+=`<div class="p-4 rounded-lg bg-slate-50 border border-slate-200 space-y-2">
      <div class="flex items-center gap-2">
        <span class="material-symbols-outlined text-slate-500" style="font-size:18px">psychology</span>
        <span class="text-sm font-bold">AIã‚³ãƒ¼ãƒã‹ã‚‰ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</span>
      </div>
      <p class="text-xs text-slate-600 leading-relaxed">${r.feedback}</p>
    </div>`;
  }

  // Ideal response
  if(r.ideal){
    insightsHTML+=`<div class="p-4 rounded-lg bg-green-50 border border-green-100 space-y-2">
      <div class="flex items-center gap-2">
        <span class="material-symbols-outlined text-green-600" style="font-size:18px">check_circle</span>
        <span class="text-sm font-bold">ç†æƒ³ã®ãƒˆãƒ¼ã‚¯ä¾‹</span>
      </div>
      <p class="text-xs text-slate-600 leading-relaxed italic">${r.ideal}</p>
    </div>`;
  }

  // Worst axes improvement tips
  if(r.sub){
    const sorted=Object.entries(r.sub).map(([k,v])=>[k,typeof v==='object'?v.score:v,typeof v==='object'?v.deduction:'']).sort((a,b)=>a[1]-b[1]);
    const worst3=sorted.slice(0,3);
    worstWeakPoint=worst3[0][0];

    worst3.forEach(([k,sc,ded])=>{
      insightsHTML+=`<div class="p-4 rounded-lg bg-orange-50 border border-orange-100 space-y-2">
        <div class="flex items-center gap-2">
          <span class="material-symbols-outlined text-orange-500" style="font-size:18px">trending_up</span>
          <span class="text-sm font-bold">${SUB_NAMES[k]} ã®æ”¹å–„ (${sc}ç‚¹)</span>
        </div>
        ${ded?`<p class="text-xs text-slate-600">${ded}</p>`:''}
        <button class="text-xs font-bold text-primary flex items-center gap-1 hover:underline" onclick="drillWeakPoint('${k}')">
          ğŸ¯ ã“ã®è»¸ã‚’ç·´ç¿’ <span class="material-symbols-outlined" style="font-size:14px">arrow_forward</span>
        </button>
      </div>`;
    });
  }

  insightsEl.innerHTML=insightsHTML;

  // backward compat hidden elements
  document.getElementById('resultsMeta').innerHTML=`<span>${durStr}</span><span>${personaName}</span>`;
  document.getElementById('resultComment').innerHTML=r.feedback||'';
}

function animateScoreCounter(target,el){
  let current=0;
  const step=Math.ceil(target/30);
  const interval=setInterval(()=>{
    current=Math.min(current+step,target);
    el.textContent=current;
    if(current>=target)clearInterval(interval);
  },25);
}

function drillWeakPoint(key){
  document.getElementById('weakPoint').value=key;updateHint();
  const map={anchoring:'price_objection',closing:'closing_3min',hearing:'opening',rapport:'opening'};
  if(map[key])document.getElementById('scenario').value=map[key];
  showScreen('lobby');
}

function drillFromResults(){
  if(worstWeakPoint) drillWeakPoint(worstWeakPoint);
  else showScreen('lobby');
}

function backToLobby(){
  showScreen('lobby');
}

// === HISTORY ===
function saveHistory(r){
  const h=JSON.parse(localStorage.getItem('rp_history')||'[]');
  const subScores={};
  if(r.sub) Object.entries(r.sub).forEach(([k,v])=>subScores[k]=typeof v==='object'?v.score:v);
  h.unshift({date:new Date().toLocaleDateString('ja-JP'),score:r.total,sub:subScores,wp:document.getElementById('weakPoint').value,name:document.getElementById('salesName').value||'?'});
  if(h.length>50)h.length=50;
  localStorage.setItem('rp_history',JSON.stringify(h));
  loadHistory();
}

function loadHistory(){
  const h=JSON.parse(localStorage.getItem('rp_history')||'[]');
  const el=document.getElementById('historyList');
  if(!el)return;
  if(!h.length){el.innerHTML='<span style="font-size:11px;color:var(--call-text2)">ã¾ã å±¥æ­´ãªã—</span>';return}
  el.innerHTML=h.slice(0,10).map(i=>`<div class="history-item"><span>${i.date} ${i.name}</span><span class="hs">${i.score}ç‚¹</span></div>`).join('');
  if(h.length&&h[0].sub){
    Object.entries(h[0].sub).forEach(([k,v])=>{
      const bar=document.getElementById('bar_'+k);
      const val=document.getElementById('val_'+k);
      if(bar&&val){bar.style.width=(v/10*100)+'%';val.textContent=v}
    });
  }
  renderTrendChart();
}

// === TREND CHART ===
function renderTrendChart(){
  const h=JSON.parse(localStorage.getItem('rp_history')||'[]');
  const canvas=document.getElementById('trendChart');
  if(!canvas||!h.length)return;
  const recent=h.slice(0,10).reverse();
  const labels=recent.map((_,i)=>'#'+(i+1));
  const scores=recent.map(i=>i.score);
  if(window.trendChartInstance)window.trendChartInstance.destroy();
  window.trendChartInstance=new Chart(canvas.getContext('2d'),{
    type:'line',
    data:{labels,datasets:[{label:'ç·åˆã‚¹ã‚³ã‚¢',data:scores,borderColor:'#1a73e8',backgroundColor:'rgba(26,115,232,0.08)',fill:true,tension:0.3,pointRadius:4,pointBackgroundColor:'#1a73e8'}]},
    options:{responsive:true,maintainAspectRatio:false,scales:{y:{min:0,max:100,ticks:{color:'#5f6368',font:{size:10}},grid:{color:'rgba(0,0,0,0.06)'}},x:{ticks:{color:'#5f6368',font:{size:9}},grid:{display:false}}},plugins:{legend:{display:false}}}
  });
}

// === USAGE ===
function saveUsage(r){
  const usage=JSON.parse(localStorage.getItem('rp_usage')||'[]');
  const dur=startTime?Math.floor((Date.now()-startTime)/1000):0;
  const subScores={};
  if(r.sub) Object.entries(r.sub).forEach(([k,v])=>subScores[k]=typeof v==='object'?v.score:v);
  usage.push({name:document.getElementById('salesName').value||'æœªè¨­å®š',date:new Date().toISOString(),month:new Date().toLocaleDateString('ja-JP',{year:'numeric',month:'2-digit'}),score:r.total,sub:subScores,duration:dur,scenario:document.getElementById('scenario').value,weakPoint:document.getElementById('weakPoint').value});
  localStorage.setItem('rp_usage',JSON.stringify(usage));
}

// === GAS POST ===
async function postToGAS(result){
  const gasUrl=document.getElementById('gasUrl').value.trim();
  if(!gasUrl)return;
  try{
    const subScores={};
    if(result.sub) Object.entries(result.sub).forEach(([k,v])=>subScores[k]=typeof v==='object'?v.score:v);
    await fetch(gasUrl,{method:'POST',mode:'no-cors',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({name:document.getElementById('salesName').value||'æœªè¨­å®š',date:new Date().toISOString(),score:result.total,sub:subScores,feedback:result.feedback||'',weakPoint:document.getElementById('weakPoint').value,scenario:document.getElementById('scenario').value,duration:startTime?Math.floor((Date.now()-startTime)/1000):0})
    });
  }catch(e){console.warn('GAS POSTã‚¨ãƒ©ãƒ¼:',e)}
}

function showUsageDashboard(){
  const usage=JSON.parse(localStorage.getItem('rp_usage')||'[]');
  const months=[...new Set(usage.map(u=>u.month))].sort().reverse();
  const sel=document.getElementById('usageMonth');
  const cur=new Date().toLocaleDateString('ja-JP',{year:'numeric',month:'2-digit'});
  if(!months.length)months.push(cur);
  sel.innerHTML=months.map(m=>`<option>${m}</option>`).join('');
  renderUsageDashboard();
  document.getElementById('usageOverlay').classList.add('show');
}

function renderUsageDashboard(){
  const usage=JSON.parse(localStorage.getItem('rp_usage')||'[]');
  const month=document.getElementById('usageMonth').value;
  const filtered=usage.filter(u=>u.month===month);
  const byName={};
  filtered.forEach(u=>{
    if(!byName[u.name])byName[u.name]={count:0,totalScore:0,totalDur:0,lastDate:''};
    byName[u.name].count++;byName[u.name].totalScore+=u.score||0;byName[u.name].totalDur+=u.duration||0;byName[u.name].lastDate=u.date?.split('T')[0]||'';
  });
  let html='<table style="width:100%;border-collapse:collapse;font-size:13px">';
  html+='<tr style="border-bottom:1px solid var(--call-border)"><th style="text-align:left;padding:8px;color:var(--call-text2)">æ‹…å½“è€…</th><th style="color:var(--call-text2)">å›æ•°</th><th style="color:var(--call-text2)">å¹³å‡ç‚¹</th><th style="color:var(--call-text2)">åˆè¨ˆæ™‚é–“</th><th style="color:var(--call-text2)">æœ€çµ‚</th></tr>';
  Object.entries(byName).sort((a,b)=>b[1].count-a[1].count).forEach(([name,d])=>{
    const avg=d.count?(d.totalScore/d.count).toFixed(1):'--';
    const mins=Math.floor(d.totalDur/60);
    html+=`<tr style="border-bottom:1px solid var(--call-border)"><td style="padding:8px;font-weight:600">${name}</td><td style="text-align:center">${d.count}å›</td><td style="text-align:center;color:${avg>=70?'var(--call-green)':avg>=50?'var(--gold)':'var(--call-red)'}">${avg}</td><td style="text-align:center">${mins}åˆ†</td><td style="text-align:center;font-size:11px">${d.lastDate}</td></tr>`;
  });
  if(!Object.keys(byName).length)html+='<tr><td colspan="5" style="text-align:center;padding:24px;color:var(--call-text2)">ã¾ã ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr>';
  html+='</table>';
  document.getElementById('usageTable').innerHTML=html;
}

function exportUsageCSV(){
  const usage=JSON.parse(localStorage.getItem('rp_usage')||'[]');
  const month=document.getElementById('usageMonth').value;
  const filtered=usage.filter(u=>u.month===month);
  let csv='æ‹…å½“è€…,æ—¥æ™‚,ã‚¹ã‚³ã‚¢,æ™‚é–“(ç§’),ã‚·ãƒŠãƒªã‚ª,å¼±ç‚¹\n';
  filtered.forEach(u=>csv+=`${u.name},${u.date},${u.score},${u.duration},${u.scenario},${u.weakPoint}\n`);
  const blob=new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`roleplay_usage_${month}.csv`;a.click();
}

// === GAS INTEGRATION ===
async function fetchLossData(){
  const url=document.getElementById('gasUrl').value.trim();
  if(!url){alert('GAS Web App URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return}
  localStorage.setItem('rp_gasUrl',url);
  try{
    const res=await fetch(url);const data=await res.json();
    const sel=document.getElementById('lossSelect');
    sel.style.display='block';
    sel.innerHTML='<option value="">å¤±æ³¨å•†è«‡ã‚’é¸æŠ...</option>'+data.map((d,i)=>`<option value="${i}">${d.date} ${d.name} ${d.result} ${d.score}ç‚¹ - ${d.bad_cause||''}</option>`).join('');
    sel.onchange=()=>{
      const idx=sel.value;if(idx==='')return;
      const d=data[Number(idx)];
      document.getElementById('persona').value='custom';
      document.getElementById('customPersonaBox').style.display='block';
      document.getElementById('customTranscript').value=`ã€æ‹…å½“ã€‘${d.name}\nã€çµæœã€‘${d.result}\nã€ã‚¹ã‚³ã‚¢ã€‘${d.score}ç‚¹\nã€æœ€å¤§ã®æ¸›ç‚¹è¦å› ã€‘${d.bad_cause||''}\nã€ç·è©•ã€‘${d.summary||''}\nã€ã‚¹ã‚­ãƒ«å†…è¨³ã€‘æ¨©å¨æ€§:${d.sub?.authority||'-'} æå¤±å›é¿:${d.sub?.loss_aversion||'-'} RF:${d.sub?.reframing||'-'} ã‚¢ãƒ³ã‚«ãƒ¼:${d.sub?.anchoring||'-'} CL:${d.sub?.closing||'-'}`;
      if(d.sub){
        const worst=Object.entries(d.sub).sort((a,b)=>Number(a[1])-Number(b[1]))[0];
        if(worst&&document.getElementById('weakPoint').querySelector(`option[value="${worst[0]}"]`)){
          document.getElementById('weakPoint').value=worst[0];updateHint();
        }
      }
    };
  }catch(e){alert('GASå–å¾—ã‚¨ãƒ©ãƒ¼: '+e.message)}
}
(function(){const u=localStorage.getItem('rp_gasUrl');if(u)document.getElementById('gasUrl').value=u}());

// === STREAK ===
function updateStreak(){
  const h=JSON.parse(localStorage.getItem('rp_history')||'[]');
  if(!h.length)return;
  const days=new Set(h.map(i=>i.date));
  let streak=0;let d=new Date();
  while(days.has(d.toLocaleDateString('ja-JP'))){streak++;d.setDate(d.getDate()-1)}
  const badge=document.getElementById('streakBadgeResult');
  if(badge)badge.innerHTML=streak>=2?`<span class="streak-badge">ğŸ”¥ ${streak}æ—¥é€£ç¶š</span>`:'';
}

// === TITLE ===
function updateTitle(score){
  const h=JSON.parse(localStorage.getItem('rp_history')||'[]');
  const recent3=h.slice(0,3).map(i=>i.score);
  let title='';
  if(recent3.length>=3&&recent3.every(s=>s>=80))title='ğŸ¥‡ ã‚´ãƒ¼ãƒ«ãƒ‰ã‚¯ãƒ­ãƒ¼ã‚¶ãƒ¼';
  else if(score>=80)title='ğŸ¥ˆ ã‚·ãƒ«ãƒãƒ¼ã‚¯ãƒ­ãƒ¼ã‚¶ãƒ¼';
  else if(score>=65)title='ğŸ¥‰ ãƒ–ãƒ­ãƒ³ã‚ºã‚¯ãƒ­ãƒ¼ã‚¶ãƒ¼';
  const badge=document.getElementById('titleBadgeResult');
  if(badge)badge.innerHTML=title?`<span class="title-badge">${title}</span>`:'';
}
</script>
</body>
</html>
