<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ¯ AIå–¶æ¥­ãƒ­ãƒ¼ãƒ—ãƒ¬ | ISAIå‹</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{--bg:#0d0f14;--surface:#161920;--surface2:#1e2230;--border:#2a2f40;--accent:#4f6ef7;--accent2:#7c3aed;--green:#22c55e;--red:#ef4444;--gold:#f59e0b;--text:#e2e8f0;--text2:#94a3b8;--radius:12px}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:'Inter','Hiragino Sans',sans-serif;min-height:100vh;display:flex;flex-direction:column}
header{padding:16px 24px;display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--border);background:var(--surface)}
header .logo{font-size:20px;font-weight:800;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}
header .meta{display:flex;gap:16px;margin-left:auto;font-size:12px;color:var(--text2);align-items:center}
header .meta span{display:flex;align-items:center;gap:4px}
.badge{background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:2px 10px;font-size:11px;font-weight:600}
main{flex:1;display:grid;grid-template-columns:300px 1fr;overflow:hidden}
@media(max-width:768px){main{grid-template-columns:1fr}.sidebar{position:fixed;left:-320px;top:60px;bottom:0;width:300px;z-index:50;transition:left .3s}.sidebar.open{left:0}.mobile-toggle{display:block!important}}
.mobile-toggle{display:none;position:fixed;top:70px;left:8px;z-index:51;background:var(--accent);color:#fff;border:none;border-radius:50%;width:36px;height:36px;font-size:16px;cursor:pointer}
.sidebar{background:var(--surface);border-right:1px solid var(--border);padding:16px;display:flex;flex-direction:column;gap:14px;overflow-y:auto}
.sh{font-size:11px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.08em}
.config-form{display:flex;flex-direction:column;gap:10px}
.config-form label{font-size:11px;color:var(--text2);margin-bottom:2px;display:block}
.config-form input,.config-form select{width:100%;background:var(--surface2);border:1px solid var(--border);color:var(--text);border-radius:8px;padding:8px 10px;font-size:12px;outline:none}
.config-form input:focus,.config-form select:focus{border-color:var(--accent)}
.score-preview{display:flex;flex-direction:column;gap:6px}
.sb-item{display:flex;align-items:center;gap:6px;font-size:11px}
.sb-item .n{color:var(--text2);width:75px;flex-shrink:0}
.sb-item .bg{flex:1;height:5px;background:var(--border);border-radius:3px;overflow:hidden}
.sb-item .fl{height:100%;border-radius:3px;background:var(--accent);transition:width .8s}
.sb-item .v{color:var(--text);width:24px;text-align:right;font-weight:600}
.hint-box{background:rgba(79,110,247,.08);border:1px solid rgba(79,110,247,.25);border-radius:var(--radius);padding:12px}
.hint-box .ht{font-size:10px;color:var(--accent);font-weight:700;margin-bottom:6px}
.hint-box .hc{font-size:12px;color:var(--text2);line-height:1.5}
.chat-area{display:flex;flex-direction:column;height:100%;overflow:hidden}
.messages{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:12px}
.msg{display:flex;gap:10px;max-width:80%}
.msg.ai{align-self:flex-start}
.msg.user{align-self:flex-end;flex-direction:row-reverse}
.msg-av{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
.msg.ai .msg-av{background:rgba(124,58,237,.2);border:1px solid rgba(124,58,237,.4)}
.msg.user .msg-av{background:rgba(79,110,247,.2);border:1px solid rgba(79,110,247,.4)}
.msg-bb{padding:10px 14px;border-radius:14px;font-size:13px;line-height:1.6}
.msg.ai .msg-bb{background:var(--surface2);border:1px solid var(--border);border-bottom-left-radius:4px}
.msg.user .msg-bb{background:rgba(79,110,247,.15);border:1px solid rgba(79,110,247,.25);border-bottom-right-radius:4px}
.msg-bb.live{border-style:dashed;opacity:.85}
.msg-t{font-size:10px;color:var(--text2);margin-top:3px}
.msg.system{align-self:center;max-width:90%}
.msg.system .msg-bb{background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.2);color:var(--gold);font-size:12px;text-align:center}
.controls{padding:14px 20px;border-top:1px solid var(--border);background:var(--surface);display:flex;flex-direction:column;gap:10px}
.status-bar{display:flex;align-items:center;gap:8px}
.status-dot{width:8px;height:8px;border-radius:50%;background:var(--border);transition:all .3s;flex-shrink:0}
.status-dot.listening{background:var(--green);box-shadow:0 0 6px var(--green);animation:pulse 1.5s infinite}
.status-dot.speaking{background:var(--accent2);box-shadow:0 0 6px var(--accent2);animation:pulse 1s infinite}
.status-dot.thinking{background:var(--gold);box-shadow:0 0 6px var(--gold);animation:pulse .8s infinite}
.status-text{font-size:12px;color:var(--text2)}
.vol-bar{flex:1;height:3px;background:var(--border);border-radius:2px;overflow:hidden}
.vol-fill{height:100%;background:var(--green);border-radius:2px;width:0%;transition:width .05s}
canvas.waveform{width:100%;height:36px;border-radius:6px;background:var(--surface2)}
.btn-row{display:flex;gap:10px}
.btn{padding:10px 18px;border-radius:30px;border:none;font-size:13px;font-weight:700;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:6px}
.btn-start{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;flex:1;justify-content:center;font-size:14px;padding:14px}
.btn-start:hover{opacity:.85;transform:translateY(-1px);box-shadow:0 6px 20px rgba(79,110,247,.3)}
.btn-start:disabled{opacity:.4;cursor:not-allowed;transform:none;box-shadow:none}
.btn-stop{background:rgba(239,68,68,.15);border:1px solid rgba(239,68,68,.3);color:#fca5a5;padding:10px 16px}
.btn-stop:hover{background:rgba(239,68,68,.25)}
.btn-grade{background:rgba(245,158,11,.15);border:1px solid rgba(245,158,11,.3);color:#fcd34d}
.btn-grade:hover{background:rgba(245,158,11,.25)}
.btn-grade:disabled,.btn-stop:disabled{opacity:.35;cursor:not-allowed}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:100;backdrop-filter:blur(4px)}
.overlay.show{display:flex}
.result-card{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:28px;max-width:580px;width:92%;max-height:85vh;overflow-y:auto}
.result-score{font-size:52px;font-weight:900;text-align:center;background:linear-gradient(135deg,var(--gold),#f97316);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}
.result-label{text-align:center;font-size:12px;color:var(--text2);margin-top:2px}
.result-section{margin-top:16px}
.result-section h3{font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:.08em;margin-bottom:8px}
.result-comment{font-size:13px;line-height:1.7;color:var(--text)}
.btn-close{width:100%;margin-top:20px;background:var(--accent);color:#fff;border:none;padding:12px;border-radius:30px;font-size:14px;font-weight:700;cursor:pointer}
.btn-close:hover{opacity:.85}
.history-list{max-height:200px;overflow-y:auto}
.history-item{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);font-size:11px;color:var(--text2)}
.history-item .hs{color:var(--text);font-weight:600}
.streak-badge{background:linear-gradient(135deg,#f97316,var(--gold));color:#000;border-radius:20px;padding:3px 10px;font-size:11px;font-weight:800;display:inline-flex;align-items:center;gap:4px}
.title-badge{background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:3px 10px;font-size:11px;font-weight:600;color:var(--gold)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
</style>
</head>
<body>

<button class="mobile-toggle" onclick="document.querySelector('.sidebar').classList.toggle('open')">â˜°</button>

<header>
<span class="logo">ğŸ¯ AIå–¶æ¥­ãƒ­ãƒ¼ãƒ—ãƒ¬</span>
<span style="font-size:12px;color:var(--text2);margin-left:6px">Powered by Gemini Live</span>
<div class="meta">
  <span id="turnCount">ğŸ”„ 0å¾€å¾©</span>
  <span id="sessionTimer">â± 00:00</span>
  <span id="streakBadge"></span>
  <span id="titleBadge"></span>
  <button onclick="showUsageDashboard()" style="background:var(--surface2);border:1px solid var(--border);color:var(--text2);border-radius:20px;padding:2px 10px;font-size:11px;cursor:pointer">ğŸ“Š åˆ©ç”¨çŠ¶æ³</button>
</div>
</header>

<main>
<aside class="sidebar">
  <div class="sh">ãƒ­ãƒ¼ãƒ—ãƒ¬è¨­å®š</div>
  <div class="config-form">
    <div><label>æ‹…å½“è€…å</label><input type="text" id="salesName" placeholder="ä¾‹: é«˜æ©‹"></div>
    <div><label>å…‹æœã™ã¹ãå¼±ç‚¹</label>
      <select id="weakPoint">
        <option value="anchoring">ã‚¢ãƒ³ã‚«ãƒªãƒ³ã‚°ï¼ˆä¾¡æ ¼æç¤ºï¼‰</option>
        <option value="authority">æ¨©å¨æ€§ï¼ˆé¸ã¶å´ã‚¹ã‚¿ãƒ³ã‚¹ï¼‰</option>
        <option value="loss_aversion">æå¤±å›é¿ï¼ˆç¾çŠ¶ãƒªã‚¹ã‚¯æŒ‡æ‘˜ï¼‰</option>
        <option value="reframing">ãƒªãƒ•ãƒ¬ãƒ¼ãƒŸãƒ³ã‚°ï¼ˆã‚¹ã‚¯ãƒ¼ãƒ«â†’ç ”ä¿®ï¼‰</option>
        <option value="closing">ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ³ã‚°ï¼ˆè¨€ã„åˆ‡ã‚Šèª˜å°ï¼‰</option>
        <option value="hearing">ãƒ’ã‚¢ãƒªãƒ³ã‚°ï¼ˆèª²é¡Œã®æ·±å €ã‚Šï¼‰</option>
        <option value="rapport">ãƒ©ãƒãƒ¼ãƒ«ï¼ˆä¿¡é ¼æ§‹ç¯‰ï¼‰</option>
        <option value="objection">åè«–å‡¦ç†ï¼ˆåˆ‡ã‚Šè¿”ã—åŠ›ï¼‰</option>
        <option value="tempo">ãƒ†ãƒ³ãƒï¼ˆä¼šè©±ã®ãƒªã‚ºãƒ ï¼‰</option>
        <option value="proposal">ææ¡ˆåŠ›ï¼ˆè§£æ±ºç­–ã®å…·ä½“æ€§ï¼‰</option>
      </select></div>
    <div><label>å•†æ</label>
      <select id="product">
        <option value="ISAI">ISAIï¼ˆAIãƒãƒ¼ã‚±ã‚¿ãƒ¼ã‚¹ã‚¯ãƒ¼ãƒ«ï¼‰</option>
        <option value="Adoafi">Adoafi</option>
      </select></div>
    <div><label>é¡§å®¢ãƒšãƒ«ã‚½ãƒŠ</label>
      <select id="persona">
        <option value="price">ã€Œé«˜ã„ã€ã¨è¨€ã†é¡§å®¢</option>
        <option value="compare">ã€Œä»–ã¨æ¯”ã¹ãŸã„ã€é¡§å®¢</option>
        <option value="busy">ã€Œå¿™ã—ãã¦æ™‚é–“ãŒãªã„ã€é¡§å®¢</option>
        <option value="spouse">ã€Œé…å¶è€…ã«ç›¸è«‡ã—ãŸã„ã€é¡§å®¢</option>
        <option value="doubt">ã€Œæœ¬å½“ã«åŠ¹æœã‚ã‚‹ã®ï¼Ÿã€é¡§å®¢</option>
        <option value="custom">ğŸ” å®Ÿå•†è«‡ãƒˆãƒ¬ãƒ¼ã‚¹ï¼ˆâ†“ãƒ­ã‚°è²¼ä»˜ï¼‰</option>
      </select></div>
    <div id="customPersonaBox" style="display:none">
      <label>ğŸ“‹ å¤±æ³¨å•†è«‡ãƒ­ã‚°ã‚’è²¼ã‚Šä»˜ã‘</label>
      <textarea id="customTranscript" rows="6" placeholder="å•†è«‡ã®è­°äº‹éŒ²ã€æ–‡å­—èµ·ã“ã—ã€ã¾ãŸã¯GAS FBãƒ„ãƒ¼ãƒ«ã®ç·è©•ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚AIãŒã“ã®é¡§å®¢ã®è©±ã—æ–¹ãƒ»æ€è€ƒãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å†ç¾ã—ã¾ã™ã€‚" style="width:100%;background:var(--surface2);border:1px solid var(--border);color:var(--text);border-radius:8px;padding:8px;font-size:11px;resize:vertical"></textarea>
    </div>
    <div><label>é›£æ˜“åº¦</label>
      <select id="difficulty">
        <option value="easy">ğŸŸ¢ æ˜“ï¼ˆä¹—ã‚Šã‚„ã™ã„é¡§å®¢ï¼‰</option>
        <option value="medium" selected>ğŸŸ¡ ä¸­ï¼ˆæ™®é€šã®é¡§å®¢ï¼‰</option>
        <option value="hard">ğŸ”´ é›£ï¼ˆé ‘å›ºãªé¡§å®¢ï¼‰</option>
      </select></div>
    <div><label>ã‚·ãƒŠãƒªã‚ª</label>
      <select id="scenario">
        <option value="full">ãƒ•ãƒ«å•†è«‡ï¼ˆè‡ªç”±ä¼šè©±ï¼‰</option>
        <option value="opening">å†’é ­5åˆ†ï¼ˆã‚¢ã‚¤ã‚¹ãƒ–ãƒ¬ã‚¤ã‚¯â†’ãƒ’ã‚¢ãƒªãƒ³ã‚°ï¼‰</option>
        <option value="price_objection">ä¾¡æ ¼æç¤ºå¾Œã®åˆ‡ã‚Šè¿”ã—</option>
        <option value="closing_3min">ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ³ã‚°æœ€å¾Œã®3åˆ†</option>
      </select></div>
    <div><label>Gemini API Key</label><input type="password" id="apiKey" placeholder="AIzaSy..."></div>
    <div><label>ãƒ¢ãƒ‡ãƒ«</label>
      <select id="modelName">
        <option value="gemini-2.0-flash-exp">gemini-2.0-flash-expï¼ˆæ¨™æº–ãƒ»å®‰ä¾¡ï¼‰</option>
        <option value="gemini-2.0-flash">gemini-2.0-flash</option>
        <option value="gemini-2.5-flash-native-audio-preview-12-2025">gemini-2.5-flash-native-audioï¼ˆé«˜å“è³ªãƒ»ç¤¾é•·ãƒ‡ãƒ¢ç”¨ï¼‰</option>
      </select></div>
    <div><label><input type="checkbox" id="saveKey" style="width:auto;margin-right:6px">API Keyã‚’ä¿å­˜ã™ã‚‹</label></div>
  </div>

  <div>
    <div class="sh" style="margin-bottom:8px">ã‚¹ã‚³ã‚¢æ¨ç§»(10è»¸)</div>
    <div class="score-preview" id="scorePreview"></div>
  </div>

  <div>
    <div class="sh" style="margin-bottom:8px">ğŸ“ˆ ã‚¹ã‚³ã‚¢ãƒˆãƒ¬ãƒ³ãƒ‰</div>
    <div style="height:160px;background:var(--surface2);border-radius:var(--radius);padding:8px"><canvas id="trendChart"></canvas></div>
  </div>

  <div class="hint-box"><div class="ht">ğŸ“ ã“ã®ãƒ­ãƒ¼ãƒ—ãƒ¬ã®ç›®æ¨™</div><div class="hc" id="hintText"></div></div>

  <div>
    <div class="sh" style="margin-bottom:8px">GASå•†è«‡FBé€£æº</div>
    <div class="config-form">
      <div><label>GAS Web App URL</label><input type="text" id="gasUrl" placeholder="https://script.google.com/macros/s/..." style="font-size:10px"></div>
      <button onclick="fetchLossData()" class="btn" style="background:rgba(79,110,247,.15);border:1px solid rgba(79,110,247,.25);color:var(--accent);padding:6px 12px;font-size:11px;width:100%">ğŸ“‹ å¤±æ³¨ãƒ‡ãƒ¼ã‚¿å–å¾—</button>
      <select id="lossSelect" style="display:none;width:100%;background:var(--surface2);border:1px solid var(--border);color:var(--text);border-radius:8px;padding:8px;font-size:11px"></select>
    </div>
  </div>

  <div>
    <div class="sh" style="margin-bottom:8px">ç·´ç¿’å±¥æ­´</div>
    <div class="history-list" id="historyList"><span style="font-size:11px;color:var(--text2)">ã¾ã å±¥æ­´ãªã—</span></div>
  </div>
</aside>

<div class="chat-area">
  <div class="messages" id="messages">
    <div style="text-align:center;color:var(--text2);font-size:12px;margin-top:40px">è¨­å®šã‚’ç¢ºèªã—ã¦ã€Œãƒ­ãƒ¼ãƒ—ãƒ¬é–‹å§‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>
  </div>
  <div class="controls">
    <div class="status-bar">
      <div class="status-dot" id="statusDot"></div>
      <span class="status-text" id="statusText">å¾…æ©Ÿä¸­</span>
      <div class="vol-bar"><div class="vol-fill" id="volFill"></div></div>
    </div>
    <canvas class="waveform" id="waveCanvas"></canvas>
    <div class="btn-row">
      <button class="btn btn-start" id="btnStart" onclick="startSession()">ğŸ™ï¸ ãƒ­ãƒ¼ãƒ—ãƒ¬é–‹å§‹</button>
      <button class="btn btn-stop" id="btnStop" onclick="stopSession()" disabled>â¹ çµ‚äº†</button>
      <button class="btn btn-grade" id="btnGrade" onclick="gradeSession()" disabled>ğŸ“Š æ¡ç‚¹</button>
    </div>
  </div>
</div>
</main>

<div class="overlay" id="overlay">
<div class="result-card">
  <div class="result-score" id="resultScore">--</div>
  <div class="result-label">ãƒ­ãƒ¼ãƒ—ãƒ¬æ¡ç‚¹ï¼ˆ100ç‚¹æº€ç‚¹ï¼‰</div>
  <div class="result-section"><h3>ğŸ“Š 10è»¸ã‚¹ã‚³ã‚¢</h3><div id="resultSubScores"></div></div>
  <div class="result-section"><h3>ğŸ’¬ AIã‚³ãƒ¼ãƒã‹ã‚‰ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</h3><div class="result-comment" id="resultComment"></div></div>
  <div class="result-section" id="idealSection" style="display:none"><h3>âœ¨ ç†æƒ³ã®ãƒˆãƒ¼ã‚¯ä¾‹</h3><div class="result-comment" id="idealResponse"></div></div>
  <div class="result-section" id="timelineSection" style="display:none"><h3>ğŸ• ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³æŒ¯ã‚Šè¿”ã‚Š</h3><div class="result-comment" id="timelineContent"></div></div>
  <div class="result-section" id="drillSection" style="display:none"><h3>ğŸ¯ å¼±ç‚¹ãƒ”ãƒ³ãƒã‚¤ãƒ³ãƒˆç·´ç¿’</h3><div id="drillButtons"></div></div>
  <button class="btn-close" onclick="closeResult()">é–‰ã˜ã‚‹</button>
</div>
</div>

<div class="overlay" id="usageOverlay">
<div class="result-card" style="max-width:700px">
  <h2 style="text-align:center;margin-bottom:16px">ğŸ“Š æœˆåˆ¥åˆ©ç”¨çŠ¶æ³</h2>
  <div style="display:flex;gap:8px;margin-bottom:12px;justify-content:center">
    <select id="usageMonth" onchange="renderUsageDashboard()" style="background:var(--surface2);border:1px solid var(--border);color:var(--text);border-radius:8px;padding:6px 10px;font-size:12px"></select>
    <button onclick="exportUsageCSV()" style="background:var(--accent);color:#fff;border:none;border-radius:8px;padding:6px 12px;font-size:11px;cursor:pointer">ğŸ“¥ CSV</button>
  </div>
  <div id="usageTable"></div>
  <button class="btn-close" onclick="document.getElementById('usageOverlay').classList.remove('show')">é–‰ã˜ã‚‹</button>
</div>
</div>

<script>
// === CONFIG ===
const HINTS={
  anchoring:'ã€Œå€¤æ®µãŒé«˜ã„ã€ã¨è¨€ã‚ã‚ŒãŸç¬é–“ãŒå‹è² ã€‚è²»ç”¨ã‚’ã€ŒæŠ•è³‡ã€ã€Œæ¡ç”¨è²»æ›ç®—ã€ã€Œæœˆå‰²ã‚Šã€ã«å¤‰æ›ã€‚ã€Œè¦šæ‚Ÿã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã€ã¨ã—ã¦å®šç¾©ã™ã‚‹ã“ã¨ãŒéµã€‚',
  authority:'ã€Œé¸ã¶å´ã€ã®ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å´©ã•ãªã„ã€‚é¡§å®¢ã®è³ªå•ã«å³ç­”ã›ãšã€Œãªãœãã®è³ªå•ã‚’ã™ã‚‹ã‹ã€ã‚’è¿”ã™ã€‚',
  loss_aversion:'ã€Œ3å¹´å¾Œã®è‡ªåˆ†ã®å§¿ã‚’æƒ³åƒã—ã¦ãã ã•ã„ã€ã€ŒåŒã„å¹´ã®äººãŒã©ã“ã«ã„ã‚‹ã‹ã€ã§ç¾çŠ¶ãƒªã‚¹ã‚¯ã‚’çªãã€‚',
  reframing:'ã€Œã‚¹ã‚¯ãƒ¼ãƒ«ã€ã€Œå­¦æ ¡ã€ã‚’ã€Œç¤¾å†…ç ”ä¿®ã€ã€Œãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°å®¤ã®ç«‹ã¡ä¸Šã’ã€ã«å¤‰æ›ã€‚é¡§å®¢ãŒãã®è¨€è‘‰ã‚’ä½¿ã„å§‹ã‚ãŸã‚‰æˆåŠŸã€‚',
  closing:'ã€Œæ‰‹ç¶šãé€²ã‚ã¾ã™ã€ã¨è¨€ã„åˆ‡ã‚‹ç·´ç¿’ã€‚ã€Œã§ã¯ã€œã¨ã„ã†ã“ã¨ã§ã‚ˆã„ã§ã™ã‹ï¼Ÿã€â†’ã€Œã§ã¯æ‰‹ç¶šãã«ç§»ã‚Šã¾ã—ã‚‡ã†ã€ã¨ä¸»èªã‚’å¤‰ãˆã‚‹ã€‚',
  hearing:'ã€Œãªãœãã†æ€ã„ã¾ã™ã‹ï¼Ÿã€ã€Œä»–ã«å›°ã£ã¦ã„ã‚‹ã“ã¨ã¯ï¼Ÿã€ã§é¡§å®¢ã®æœ¬éŸ³ã‚’å¼•ãå‡ºã™ã€‚è¡¨é¢çš„ãªå›ç­”ã§çµ‚ã‚ã‚‰ã›ãªã„ã€‚',
  rapport:'æœ€åˆã®90ç§’ã§å…±æ„Ÿãƒã‚¤ãƒ³ãƒˆã‚’è¦‹ã¤ã‘ã‚‹ã€‚ç›¸æ‰‹ã®åå‰ã‚’å‘¼ã¶ã€å…±é€šç‚¹ã‚’è¦‹ã¤ã‘ã‚‹ã€ç›¸æ‰‹ã®è¨€è‘‰ã‚’ã‚ªã‚¦ãƒ è¿”ã—ã™ã‚‹ã€‚',
  objection:'åè«–ã¯è²·ã„ãŸã„ã‚µã‚¤ãƒ³ã€‚ã€Œã¨ã„ã†ã“ã¨ã¯ã€œãŒè§£æ±ºã™ã‚Œã°å‰å‘ãã§ã™ã‹ï¼Ÿã€ã¨æ¡ä»¶ä»˜ãYesã«æŒã¡è¾¼ã‚€ã€‚',
  tempo:'æ²ˆé»™ã‚’æ€–ãŒã‚‰ãªã„ã€‚è³ªå•ã—ãŸå¾Œ3ç§’å¾…ã¤ã€‚çŸ¢ç¶™ãæ—©ã«è©±ã•ãšã€ç›¸æ‰‹ã«è€ƒãˆã‚‹é–“ã‚’ä¸ãˆã‚‹ã€‚',
  proposal:'æŠ½è±¡çš„ãªãƒ¡ãƒªãƒƒãƒˆã§ã¯ãªãã€Œå¾¡ç¤¾ã®å ´åˆã€œã€ã¨å…·ä½“çš„ãªæ´»ç”¨ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’æãã€‚æ•°å­—ã§ç¤ºã™ã€‚'
};
const PERSONAS={
  price:{jp:'ã€Œé«˜ã„ã€ã¨è¨€ã†é¡§å®¢',intro:'ã¡ã‚‡ã£ã¨â€¦æ­£ç›´ã€å€¤æ®µãŒã¡ã‚‡ã£ã¨æ°—ã«ãªã£ã¦ã¦ã€‚'},
  compare:{jp:'æ¯”è¼ƒæ¤œè¨ã™ã‚‹é¡§å®¢',intro:'ä»–ã«ã‚‚ä¼¼ãŸã‚ˆã†ãªã‚¹ã‚¯ãƒ¼ãƒ«ã‚ã‚‹ã˜ã‚ƒãªã„ã§ã™ã‹ï¼Ÿãã£ã¡ã¨æ¯”ã¹ãŸãã¦ã€‚'},
  busy:{jp:'ã€Œå¿™ã—ã„ã€é¡§å®¢',intro:'èˆˆå‘³ã¯ã‚ã‚‹ã‚“ã§ã™ã‘ã©ã€æ­£ç›´ä»Šã™ã”ãå¿™ã—ãã¦ã€æ™‚é–“ãŒå–ã‚Œã‚‹ã‹ã©ã†ã‹â€¦'},
  spouse:{jp:'ã€Œé…å¶è€…ç›¸è«‡ã€é¡§å®¢',intro:'ã„ã„ã¨ã¯æ€ã†ã‚“ã§ã™ã‘ã©ã€ä¸€å¿œå¦»ã«ã‚‚ç›¸è«‡ã—ã¦ã‹ã‚‰ã˜ã‚ƒãªã„ã¨ã¡ã‚‡ã£ã¨â€¦'},
  doubt:{jp:'ã€ŒåŠ¹æœã‚ã‚‹ã®ï¼Ÿã€é¡§å®¢',intro:'AIãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ã£ã¦çµå±€ã©ã®ãã‚‰ã„å®Ÿéš›ã«ä½¿ãˆã‚‹ã‚“ã§ã™ã‹ï¼Ÿ'},
  custom:{jp:'å®Ÿå•†è«‡ãƒˆãƒ¬ãƒ¼ã‚¹é¡§å®¢',intro:'ï¼ˆãƒ­ã‚°ã‹ã‚‰è‡ªå‹•ç”Ÿæˆï¼‰'}
};
const DIFFICULTY={easy:'ã‚ãªãŸã¯æ¯”è¼ƒçš„ä¹—ã‚Šã‚„ã™ã„é¡§å®¢ã§ã™ã€‚è‰¯ã„ææ¡ˆã«ã¯ã™ãå‰ã®ã‚ã‚Šã«åå¿œã—ã¾ã™ã€‚ã—ã‹ã—æœ€ä½é™ã®è³ªå•ã¯ã—ã¾ã™ã€‚',medium:'ã‚ãªãŸã¯ãƒªã‚¢ãƒ«ãªé¡§å®¢ã§ã™ã€‚ç°¡å˜ã«ã¯ä¹—ã‚‰ãªã„ãŒã€ä¸Šæ‰‹ã„ãƒªãƒ•ãƒ¬ãƒ¼ãƒŸãƒ³ã‚°ã«ã¯åå¿œã—ã¾ã™ã€‚',hard:'ã‚ãªãŸã¯éå¸¸ã«é ‘å›ºãªé¡§å®¢ã§ã™ã€‚ä½•ã‚’è¨€ã‚ã‚Œã¦ã‚‚ç°¡å˜ã«ã¯ç´å¾—ã—ã¾ã›ã‚“ã€‚è«–ç†çš„ã«å®Œç’§ãªèª¬æ˜ã ã‘ã«å°‘ã—å¿ƒãŒå‹•ãã¾ã™ã€‚å¸¸ã«åè«–ã‚’æ¢ã—ã¾ã™ã€‚'};
const SCENARIOS={full:'è‡ªç”±ã«ä¼šè©±ã—ã¦ãã ã•ã„ã€‚',opening:'å•†è«‡ã®å†’é ­5åˆ†ã‚’æƒ³å®šã€‚è‡ªå·±ç´¹ä»‹â†’ãƒ’ã‚¢ãƒªãƒ³ã‚°â†’èª²é¡Œã®æ·±å €ã‚Šã¾ã§ã€‚ã¾ã å•†å“ææ¡ˆã¯ã—ãªã„ãƒ•ã‚§ãƒ¼ã‚ºã€‚',price_objection:'ã™ã§ã«å•†å“èª¬æ˜ã¯çµ‚ã‚ã£ã¦ã„ã‚‹ã€‚ä¾¡æ ¼ã‚’èã„ã¦ã€Œé«˜ã„ã€ã¨åå¿œã—ãŸç›´å¾Œã‹ã‚‰ä¼šè©±ã‚’å§‹ã‚ã¦ãã ã•ã„ã€‚',closing_3min:'å•†è«‡ã®çµ‚ç›¤ã€‚é¡§å®¢ã¯èˆˆå‘³ã¯ã‚ã‚‹ãŒæ±ºæ–­ã‚’è¿·ã£ã¦ã„ã‚‹çŠ¶æ…‹ã€‚ã“ã“ã‹ã‚‰3åˆ†ã§ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ³ã‚°ã¾ã§æŒã£ã¦ã„ãç·´ç¿’ã€‚'};
const SUB_NAMES={authority:'æ¨©å¨æ€§',loss_aversion:'æå¤±å›é¿',reframing:'ãƒªãƒ•ãƒ¬ãƒ¼ãƒŸãƒ³ã‚°',anchoring:'ã‚¢ãƒ³ã‚«ãƒ¼',closing:'ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ³ã‚°',hearing:'ãƒ’ã‚¢ãƒªãƒ³ã‚°',rapport:'ãƒ©ãƒãƒ¼ãƒ«',objection:'åè«–å‡¦ç†',tempo:'ãƒ†ãƒ³ãƒ',proposal:'ææ¡ˆåŠ›'};
const ALL_SUBS = Object.keys(SUB_NAMES);

let ws=null,audioContext=null,processor=null,mediaStream=null,sessionActive=false;
let conversationLog=[],timerInterval=null,startTime=null,volumeAnimFrame=null,analyserNode=null;
let turnCount=0,playbackCtx=null,currentSource=null,silenceTimer=null;
let mediaRecorder=null,recordedChunks=[];
let waveCtx=null,waveData=null;

// Live transcript bubble state
let liveAiBubble=null,liveAiText='';
let liveUserBubble=null,liveUserText='';
let turnHadAudio=false;

// Immediate audio scheduling state
let scheduledSources=[];
let nextPlayTime=0;

// === INIT ===
document.getElementById('weakPoint').addEventListener('change',updateHint);
document.getElementById('persona').addEventListener('change',()=>{
  document.getElementById('customPersonaBox').style.display = document.getElementById('persona').value==='custom'?'block':'none';
});
updateHint();
initScoreBars();
loadApiKey();
loadHistory();
updateStreak();

function initScoreBars(){
  const el=document.getElementById('scorePreview');el.innerHTML='';
  ALL_SUBS.forEach(k=>{
    el.innerHTML+=`<div class="sb-item"><div class="n">${SUB_NAMES[k]}</div><div class="bg"><div class="fl" id="bar_${k}" style="width:50%"></div></div><div class="v" id="val_${k}">-</div></div>`;
  });
}

function updateHint(){document.getElementById('hintText').textContent=HINTS[document.getElementById('weakPoint').value]||''}
function loadApiKey(){const k=localStorage.getItem('rp_apikey');if(k){document.getElementById('apiKey').value=k;document.getElementById('saveKey').checked=true}}
function saveApiKey(){if(document.getElementById('saveKey').checked)localStorage.setItem('rp_apikey',document.getElementById('apiKey').value);else localStorage.removeItem('rp_apikey')}

// === STATUS ===
function setStatus(s,t){document.getElementById('statusDot').className='status-dot '+(s||'');document.getElementById('statusText').textContent=t}
function updateTurnCount(){document.getElementById('turnCount').textContent='ğŸ”„ '+turnCount+'å¾€å¾©'}

// === MESSAGES ===
function addMsg(role,text){
  const d=document.createElement('div');
  d.className='msg '+(role==='ai'?'ai':role==='system'?'system':'user');
  const t=new Date().toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  if(role==='system'){d.innerHTML=`<div class="msg-bb">${text}</div>`}
  else{d.innerHTML=`<div class="msg-av">${role==='ai'?'ğŸ‘¤':'ğŸ§‘â€ğŸ’¼'}</div><div><div class="msg-bb">${text.replace(/\n/g,'<br>')}</div><div class="msg-t">${role==='ai'?'é¡§å®¢(AI)':'å–¶æ¥­'} Â· ${t}</div></div>`}
  conversationLog.push({role:role==='ai'?'é¡§å®¢':'å–¶æ¥­',text,time:t,ts:Date.now()});
  const m=document.getElementById('messages');m.appendChild(d);m.scrollTop=m.scrollHeight;
  if(role==='user')turnCount++;
  updateTurnCount();
}
function clearMsgs(){
  document.getElementById('messages').innerHTML='';
  conversationLog=[];turnCount=0;updateTurnCount();
  liveAiBubble=null;liveAiText='';
  liveUserBubble=null;liveUserText='';
  turnHadAudio=false;
}

// === LIVE TRANSCRIPT BUBBLES (LINE-style) ===
function getOrCreateLiveBubble(role){
  if(role==='ai'){
    if(!liveAiBubble){
      const d=document.createElement('div');
      d.className='msg ai';
      const t=new Date().toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
      d.innerHTML=`<div class="msg-av">ğŸ‘¤</div><div><div class="msg-bb live"></div><div class="msg-t">é¡§å®¢(AI) Â· ${t}</div></div>`;
      const m=document.getElementById('messages');m.appendChild(d);m.scrollTop=m.scrollHeight;
      liveAiBubble=d.querySelector('.msg-bb');
      liveAiText='';
    }
    return liveAiBubble;
  }else{
    if(!liveUserBubble){
      const d=document.createElement('div');
      d.className='msg user';
      const t=new Date().toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
      d.innerHTML=`<div class="msg-av">ğŸ§‘â€ğŸ’¼</div><div><div class="msg-bb live"></div><div class="msg-t">å–¶æ¥­ Â· ${t}</div></div>`;
      const m=document.getElementById('messages');m.appendChild(d);m.scrollTop=m.scrollHeight;
      liveUserBubble=d.querySelector('.msg-bb');
      liveUserText='';
    }
    return liveUserBubble;
  }
}

function appendTranscript(role,text){
  const bubble=getOrCreateLiveBubble(role);
  if(role==='ai'){
    liveAiText+=text;
    bubble.innerHTML=liveAiText.replace(/\n/g,'<br>');
  }else{
    liveUserText+=text;
    bubble.innerHTML=liveUserText.replace(/\n/g,'<br>');
  }
  document.getElementById('messages').scrollTop=document.getElementById('messages').scrollHeight;
}

function finalizeBubble(role){
  if(role==='ai'){
    if(liveAiBubble){
      liveAiBubble.classList.remove('live');
      if(liveAiText.trim()){
        conversationLog.push({role:'é¡§å®¢',text:liveAiText.trim(),time:new Date().toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit',second:'2-digit'}),ts:Date.now()});
      }
    }
    liveAiBubble=null;liveAiText='';
  }else if(role==='user'){
    if(liveUserBubble){
      liveUserBubble.classList.remove('live');
      if(liveUserText.trim()){
        conversationLog.push({role:'å–¶æ¥­',text:liveUserText.trim(),time:new Date().toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit',second:'2-digit'}),ts:Date.now()});
        turnCount++;updateTurnCount();
      }
    }
    liveUserBubble=null;liveUserText='';
  }
}

// === TIMER ===
function startTimer(){startTime=Date.now();timerInterval=setInterval(()=>{const s=Math.floor((Date.now()-startTime)/1000);document.getElementById('sessionTimer').textContent='â± '+String(Math.floor(s/60)).padStart(2,'0')+':'+String(s%60).padStart(2,'0')},1000)}

// === WAVEFORM ===
function initWave(){const c=document.getElementById('waveCanvas');waveCtx=c.getContext('2d');c.width=c.offsetWidth*2;c.height=72;waveData=new Uint8Array(128)}
function drawWave(){if(!sessionActive||!waveCtx)return;if(analyserNode){analyserNode.getByteTimeDomainData(waveData)}
const w=waveCtx.canvas.width,h=waveCtx.canvas.height;waveCtx.fillStyle='#1e2230';waveCtx.fillRect(0,0,w,h);
waveCtx.lineWidth=2;waveCtx.strokeStyle='#4f6ef7';waveCtx.beginPath();
const sl=w/waveData.length;let x=0;
for(let i=0;i<waveData.length;i++){const v=waveData[i]/128;const y=v*h/2;if(i===0)waveCtx.moveTo(x,y);else waveCtx.lineTo(x,y);x+=sl}
waveCtx.stroke();requestAnimationFrame(drawWave)}

// === SILENCE HINT ===
function resetSilenceTimer(){
  clearTimeout(silenceTimer);
  silenceTimer=setTimeout(()=>{
    if(!sessionActive)return;
    const wp=document.getElementById('weakPoint').value;
    const hints={anchoring:'ğŸ’¡ ã€Œãã‚Œã¯æŠ•è³‡ã§ã™ã€ã¨è¨€ã„æ›ãˆã¦ã¿ã¾ã—ã‚‡ã†',authority:'ğŸ’¡ ã€Œãªãœãã†æ€ã„ã¾ã™ã‹ï¼Ÿã€ã¨è¿”ã—ã¦ã¿ã¾ã—ã‚‡ã†',loss_aversion:'ğŸ’¡ ã€Œ3å¹´å¾Œã®è‡ªåˆ†ã‚’æƒ³åƒã—ã¦ã¿ã¦ãã ã•ã„ã€',reframing:'ğŸ’¡ ã€Œã‚¹ã‚¯ãƒ¼ãƒ«ã§ã¯ãªãç¤¾å†…ç ”ä¿®ã§ã™ã€ã¨å®šç¾©ã—ç›´ã—ã¾ã—ã‚‡ã†',closing:'ğŸ’¡ ã€Œã§ã¯æ‰‹ç¶šãã«ç§»ã‚Šã¾ã—ã‚‡ã†ã€ã¨è¨€ã„åˆ‡ã£ã¦ã¿ã¾ã—ã‚‡ã†'};
    addMsg('system',hints[wp]||'ğŸ’¡ ä½•ã‹è©±ã—ã‹ã‘ã¦ã¿ã¾ã—ã‚‡ã†');
  },15000);
}

// === GEMINI LIVE API ===
async function startSession(){
  const apiKey=document.getElementById('apiKey').value.trim();
  if(!apiKey){alert('API Keyã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return}
  saveApiKey();
  clearMsgs();initWave();
  document.getElementById('btnStart').disabled=true;
  document.getElementById('btnStop').disabled=false;
  document.getElementById('btnGrade').disabled=true;
  setStatus('thinking','æ¥ç¶šä¸­...');

  const persona=PERSONAS[document.getElementById('persona').value];
  const product=document.getElementById('product').value;
  const weakPoint=document.getElementById('weakPoint').value;
  const salesName=document.getElementById('salesName').value||'å–¶æ¥­æ‹…å½“';
  const diff=DIFFICULTY[document.getElementById('difficulty').value];
  const scn=SCENARIOS[document.getElementById('scenario').value];
  const isCustom = document.getElementById('persona').value==='custom';
  const customLog = isCustom ? document.getElementById('customTranscript').value.trim() : '';

  let systemPrompt;
  if(isCustom && customLog){
    systemPrompt=`ã‚ãªãŸã¯æ—¥æœ¬äººã®é¡§å®¢å½¹ã§ã™ã€‚å¿…ãšæ—¥æœ¬èªã ã‘ã§è©±ã—ã¦ãã ã•ã„ã€‚è‹±èªã¯çµ¶å¯¾ã«ä½¿ã‚ãªã„ã§ãã ã•ã„ã€‚

ä»¥ä¸‹ã¯å®Ÿéš›ã®å•†è«‡ã§å¤±æ³¨ã—ãŸé¡§å®¢ã®ä¼šè©±ãƒ­ã‚°ã§ã™ã€‚ã“ã®é¡§å®¢ã®è©±ã—æ–¹ã€æ€è€ƒãƒ‘ã‚¿ãƒ¼ãƒ³ã€åè«–ã®ä»•æ–¹ã€å£ç™–ã‚’ãƒˆãƒ¬ãƒ¼ã‚¹ã—ã¦ã€åŒã˜ã‚¿ã‚¤ãƒ—ã®é¡§å®¢ã¨ã—ã¦æŒ¯ã‚‹èˆã£ã¦ãã ã•ã„ã€‚

ã€å®Ÿå•†è«‡ãƒ­ã‚°ã€‘
${customLog.substring(0,3000)}

ã€ãƒ«ãƒ¼ãƒ«ã€‘
- ä¸Šè¨˜ãƒ­ã‚°ã®é¡§å®¢ã®è©±ã—æ–¹ãƒ»æ€§æ ¼ãƒ»åè«–ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å†ç¾ã™ã‚‹
- å¿…ãšæ—¥æœ¬èªã®ã¿ã€‚è‹±èªç¦æ­¢ã€‚
- 1å›ã®ç™ºè¨€ã¯çŸ­ãï¼ˆ1ã€œ2æ–‡ï¼‰
- ${diff}
- ${scn}
- ãƒ¡ã‚¿çš„ãªèª¬æ˜ã¯ä¸è¦ã€‚é¡§å®¢ã¨ã—ã¦ç›´æ¥ä¼šè©±ã™ã‚‹ã€‚

ã“ã®é¡§å®¢ã«ãªã‚Šãã£ã¦ã€æœ€åˆã®ç™ºè¨€ã‚’ã—ã¦ãã ã•ã„ã€‚`;
  } else {
    systemPrompt=`ã‚ãªãŸã¯æ—¥æœ¬äººã®é¡§å®¢å½¹ã§ã™ã€‚å¿…ãšæ—¥æœ¬èªã ã‘ã§è©±ã—ã¦ãã ã•ã„ã€‚è‹±èªã¯çµ¶å¯¾ã«ä½¿ã‚ãªã„ã§ãã ã•ã„ã€‚

ã‚ãªãŸã¯ã€Œ${persona.jp}ã€ã¨ã—ã¦ã€${product}ã®å–¶æ¥­æ‹…å½“ã€Œ${salesName}ã•ã‚“ã€ã¨éŸ³å£°ã§ä¼šè©±ã™ã‚‹é¡§å®¢ã§ã™ã€‚

ã€å½¹æŸ„ã€‘
- æ—¥æœ¬äººã®30ä»£ä¼šç¤¾å“¡
- æœ€åˆã®ç™ºè¨€: ã€Œ${persona.intro}ã€
- ${diff}

ã€ãƒ«ãƒ¼ãƒ«ã€‘
- å¿…ãšæ—¥æœ¬èªã®ã¿ã§è©±ã™ã€‚è‹±èªç¦æ­¢ã€‚
- å–¶æ¥­ã®å¼±ç‚¹ï¼ˆ${weakPoint}ï¼‰ã‚’çªãåå¿œã‚’ã™ã‚‹
- 1å›ã®ç™ºè¨€ã¯çŸ­ãï¼ˆ1ã€œ2æ–‡ï¼‰
- ã€Œã‚ãƒ¼ã€ã€Œã†ã‚“ã†ã‚“ã€ã€Œãªã‚‹ã»ã©ã€ã¨è‡ªç„¶ã«ç›¸æ§Œ
- ${scn}
- ãƒ¡ã‚¿çš„ãªèª¬æ˜ã¯ä¸è¦ã€‚é¡§å®¢ã¨ã—ã¦ç›´æ¥ä¼šè©±ã™ã‚‹ã€‚

æœ€åˆã®ã‚»ãƒªãƒ•ã€Œ${persona.intro}ã€ã‚’æ—¥æœ¬èªã§è©±ã—å§‹ã‚ã¦ãã ã•ã„ã€‚`;
  }

  const MODEL=document.getElementById('modelName').value;
  const wsUrl=`wss://generativelanguage.googleapis.com/ws/google.ai.generativelanguage.v1beta.GenerativeService.BidiGenerateContent?key=${apiKey}`;

  try{
    ws=new WebSocket(wsUrl);
    addMsg('system','ğŸ”Œ æ¥ç¶šä¸­... (ãƒ¢ãƒ‡ãƒ«: '+MODEL+')');
    const connectTimeout=setTimeout(()=>{
      if(!sessionActive){setStatus('','æ¥ç¶šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã€‚åˆ¥ã®ãƒ¢ãƒ‡ãƒ«ã‚’è©¦ã—ã¦ãã ã•ã„');resetUI();if(ws)ws.close()}
    },10000);

    ws.onopen=()=>{
      // CRITICAL: Do NOT add output_audio_transcription, input_audio_transcription, or realtime_input_config here
      const setupPayload = {
        setup:{
          model:`models/${MODEL}`,
          generation_config:{
            response_modalities:['AUDIO'],
            speech_config:{
              voice_config:{
                prebuilt_voice_config:{voice_name:'Puck'}
              },
              language_code:'ja-JP'
            }
          },
          system_instruction:{
            parts:[{text:systemPrompt}]
          }
        }
      };
      console.log('Setup:', JSON.stringify(setupPayload).substring(0,400));
      ws.send(JSON.stringify(setupPayload));
    };

    ws.onmessage=async(e)=>{
      const raw = typeof e.data==='string'?e.data:await e.data.text();
      const data=JSON.parse(raw);

      if(data.setupComplete){
        clearTimeout(connectTimeout);
        setStatus('listening','ãƒ­ãƒ¼ãƒ—ãƒ¬é–‹å§‹ï¼é¡§å®¢ãŒè©±ã—ã‹ã‘ã¾ã™...');
        sessionActive=true;startTimer();startRecording();
        addMsg('system','âœ… æ¥ç¶šæˆåŠŸ ('+MODEL+')');
        ws.send(JSON.stringify({client_content:{turns:[{role:'user',parts:[{text:'ä¼šè©±ã‚’å§‹ã‚ã¦ãã ã•ã„'}]}],turn_complete:true}}));
        await startMicrophone();
        drawWave();resetSilenceTimer();
        return;
      }

      if(data.serverContent?.modelTurn?.parts){
        let hasAudio = false;
        for(const p of data.serverContent.modelTurn.parts){
          if(p.inlineData?.mimeType?.startsWith('audio/')){playAudioChunk(p.inlineData.data);hasAudio=true;}
          // Skip p.text â€” native audio model outputs internal reasoning in English, not dialogue
        }
        if(hasAudio){setStatus('speaking','AIé¡§å®¢ãŒè©±ã—ã¦ã„ã¾ã™...');turnHadAudio=true;}
      }

      // Live transcript: AI speech as text (streamed in chunks)
      if(data.serverContent?.outputTranscript?.text){
        appendTranscript('ai',data.serverContent.outputTranscript.text);
      }
      // Live transcript: User speech as text
      if(data.serverContent?.inputTranscript?.text){
        appendTranscript('user',data.serverContent.inputTranscript.text);
        finalizeBubble('user');
        resetSilenceTimer();
      }else if(typeof data.serverContent?.inputTranscript === 'string' && data.serverContent.inputTranscript){
        appendTranscript('user',data.serverContent.inputTranscript);
        finalizeBubble('user');
        resetSilenceTimer();
      }

      if(data.serverContent?.interrupted){clearAudioQueue();setStatus('listening','å‰²ã‚Šè¾¼ã¿æ¤œçŸ¥ â€” ç¶šã‘ã¦ã©ã†ã')}

      if(data.serverContent?.turnComplete){
        // Finalize AI bubble; if no transcript received but audio played, log marker for grading
        if(!liveAiText.trim() && turnHadAudio){
          conversationLog.push({role:'é¡§å®¢',text:'(éŸ³å£°ç™ºè¨€)',time:new Date().toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit',second:'2-digit'}),ts:Date.now()});
        }
        finalizeBubble('ai');
        turnHadAudio=false;
        setStatus('listening','ã‚ãªãŸã®ç•ªã§ã™');
        resetSilenceTimer();
      }

      if(data.error){
        console.error('Gemini Error:',data.error);
        setStatus('','ã‚¨ãƒ©ãƒ¼: '+(data.error.message||JSON.stringify(data.error)));
        addMsg('system','âŒ '+JSON.stringify(data.error));
        resetUI();
      }
    };

    ws.onerror=(e)=>{console.error('WS Error',e);clearTimeout(connectTimeout);setStatus('','æ¥ç¶šã‚¨ãƒ©ãƒ¼ã€‚åˆ¥ã®ãƒ¢ãƒ‡ãƒ«ã‚’é¸ã‚“ã§å†è©¦è¡Œã—ã¦ãã ã•ã„');addMsg('system','âŒ WebSocketæ¥ç¶šã‚¨ãƒ©ãƒ¼ã€‚ãƒ¢ãƒ‡ãƒ«ã‚’å¤‰æ›´ã—ã¦ã¿ã¦ãã ã•ã„');resetUI()};
    ws.onclose=(e)=>{clearTimeout(connectTimeout);if(sessionActive){setStatus('','ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†');sessionActive=false}else if(document.getElementById('btnStart').disabled){setStatus('','æ¥ç¶šå¤±æ•— (code:'+e.code+'). ãƒ¢ãƒ‡ãƒ«ã‚’å¤‰æ›´ã—ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„');addMsg('system','âŒ code:'+e.code+' â€” åˆ¥ã®ãƒ¢ãƒ‡ãƒ«ã‚’è©¦ã™ã‹ã€API Keyã‚’ç¢ºèªã—ã¦ãã ã•ã„');resetUI()}};
  }catch(err){alert('æ¥ç¶šå¤±æ•—: '+err.message);resetUI()}
}

function resetUI(){document.getElementById('btnStart').disabled=false;document.getElementById('btnStop').disabled=true;document.getElementById('btnGrade').disabled=conversationLog.length<2?true:false}

// === MIC ===
async function startMicrophone(){
  try{
    mediaStream=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:true,noiseSuppression:true,autoGainControl:true}});
    audioContext=new AudioContext({sampleRate:16000});
    await audioContext.audioWorklet.addModule('data:application/javascript,'+encodeURIComponent(WORKLET_CODE));
    const src=audioContext.createMediaStreamSource(mediaStream);
    analyserNode=audioContext.createAnalyser();analyserNode.fftSize=256;
    src.connect(analyserNode);
    processor=new AudioWorkletNode(audioContext,'pcm-processor');
    src.connect(processor);
    processor.port.onmessage=(e)=>{if(!ws||ws.readyState!==1||!sessionActive)return;ws.send(JSON.stringify({realtime_input:{media_chunks:[{mime_type:'audio/pcm;rate=16000',data:ab2b64(e.data)}]}}))};
    processor.connect(audioContext.destination);
    startVolMon();
  }catch(err){addMsg('system','âš ï¸ ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã«å¤±æ•—: '+err.message)}
}
const WORKLET_CODE=`class PcmProcessor extends AudioWorkletProcessor{constructor(){super();this._b=new Int16Array(1024);this._p=0}process(i){const d=i[0]?.[0];if(!d)return true;for(let j=0;j<d.length;j++){this._b[this._p++]=Math.max(-32768,Math.min(32767,d[j]*32768));if(this._p>=this._b.length){this.port.postMessage(this._b.buffer.slice(0));this._p=0}}return true}}registerProcessor('pcm-processor',PcmProcessor);`;

function ab2b64(buf){const b=new Uint8Array(buf);let s='';for(let i=0;i<b.byteLength;i++)s+=String.fromCharCode(b[i]);return btoa(s)}
function startVolMon(){const vf=document.getElementById('volFill');const d=new Uint8Array(analyserNode.frequencyBinCount);(function tick(){if(!sessionActive)return;analyserNode.getByteFrequencyData(d);vf.style.width=Math.min(100,d.reduce((a,b)=>a+b,0)/d.length*2)+'%';volumeAnimFrame=requestAnimationFrame(tick)})()}

// === PLAYBACK (Immediate Scheduling â€” zero batch delay) ===
function getPlayCtx(){
  if(!playbackCtx || playbackCtx.state==='closed'){
    playbackCtx = new AudioContext({sampleRate:24000});
  }
  return playbackCtx;
}

function clearAudioQueue(){
  scheduledSources.forEach(s=>{try{s.stop()}catch(e){}});
  scheduledSources=[];
  nextPlayTime=0;
}

function playAudioChunk(b64){
  const raw=atob(b64);const bytes=new Uint8Array(raw.length);
  for(let i=0;i<raw.length;i++)bytes[i]=raw.charCodeAt(i);
  const pcm=new Int16Array(bytes.buffer);const f32=new Float32Array(pcm.length);
  for(let i=0;i<pcm.length;i++)f32[i]=pcm[i]/32768;

  const ctx=getPlayCtx();
  const buf=ctx.createBuffer(1,f32.length,24000);
  buf.getChannelData(0).set(f32);

  const s=ctx.createBufferSource();
  s.buffer=buf;
  s.connect(ctx.destination);

  // Schedule immediately with no batching delay
  const now=ctx.currentTime;
  if(nextPlayTime<now) nextPlayTime=now;
  s.start(nextPlayTime);
  nextPlayTime+=buf.duration;

  scheduledSources.push(s);
  s.onended=()=>{scheduledSources=scheduledSources.filter(x=>x!==s)};
}

// === RECORDING ===
function startRecording(){
  try{
    const dest=new AudioContext();const osc=dest.createOscillator();
    const combined=dest.createMediaStreamDestination();
    mediaRecorder=new MediaRecorder(combined.stream,{mimeType:'audio/webm'});
    recordedChunks=[];
    mediaRecorder.ondataavailable=e=>{if(e.data.size>0)recordedChunks.push(e.data)};
    mediaRecorder.start(1000);
  }catch(e){console.warn('Recording not supported:',e)}
}
function stopRecording(){if(mediaRecorder&&mediaRecorder.state!=='inactive'){mediaRecorder.stop()}}

// === STOP ===
function stopSession(){
  sessionActive=false;clearTimeout(silenceTimer);
  if(volumeAnimFrame)cancelAnimationFrame(volumeAnimFrame);
  if(processor){processor.disconnect();processor=null}
  if(audioContext){audioContext.close();audioContext=null}
  if(playbackCtx){clearAudioQueue();playbackCtx.close();playbackCtx=null}
  if(mediaStream){mediaStream.getTracks().forEach(t=>t.stop());mediaStream=null}
  if(ws){ws.close();ws=null}
  if(timerInterval){clearInterval(timerInterval);timerInterval=null}
  stopRecording();
  document.getElementById('volFill').style.width='0%';
  document.getElementById('btnStart').disabled=false;
  document.getElementById('btnStop').disabled=true;
  document.getElementById('btnGrade').disabled=conversationLog.length<2;
  setStatus('',conversationLog.length>=2?'çµ‚äº†ã€‚ã€Œæ¡ç‚¹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„':'çµ‚äº†');
}

// === GRADING (STRICT) ===
async function gradeSession(){
  const apiKey=document.getElementById('apiKey').value.trim();
  if(!apiKey)return;
  document.getElementById('btnGrade').disabled=true;
  document.getElementById('btnGrade').textContent='â³ æ¡ç‚¹ä¸­...';
  const logText=conversationLog.filter(m=>m.role!=='system').map(m=>`ã€${m.role}ã€‘${m.text}`).join('\n');
  const wp=document.getElementById('weakPoint').value;

  const prompt=`ã‚ãªãŸã¯ISAIå‹ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ³ã‚°å•†è«‡ã®AIã‚³ãƒ¼ãƒã§ã™ã€‚ä»¥ä¸‹ã®ãƒ­ãƒ¼ãƒ—ãƒ¬ä¼šè©±ã‚’å³å¯†ã«æ¡ç‚¹ã—ã¦ãã ã•ã„ã€‚
åŒã˜ä¼šè©±ãƒ­ã‚°ã‚’ä½•åº¦æ¡ç‚¹ã—ã¦ã‚‚åŒã˜ç‚¹æ•°ã«ãªã‚‹ã‚ˆã†ã€ä»¥ä¸‹ã®ãƒ«ãƒ–ãƒªãƒƒã‚¯ã«å¾“ã£ã¦ãã ã•ã„ã€‚

# ãƒ­ãƒ¼ãƒ—ãƒ¬ä¼šè©±ãƒ­ã‚°
${logText}

# æ¡ç‚¹ãƒ«ãƒ–ãƒªãƒƒã‚¯ï¼ˆå„10ç‚¹æº€ç‚¹ã€åˆè¨ˆ100ç‚¹ï¼‰
å„è»¸ã®æ¡ç‚¹åŸºæº–:
- 0-2ç‚¹: è©²å½“ã™ã‚‹è¡Œå‹•ãŒå…¨ããªã„ã€‚è©¦ã¿ã™ã‚‰è¦‹ã‚‰ã‚Œãªã„ã€‚
- 3-4ç‚¹: è©¦ã¿ã¯ã‚ã‚‹ãŒä¸ååˆ†ã¾ãŸã¯é€†åŠ¹æœã€‚é¡§å®¢ã«éŸ¿ã„ã¦ã„ãªã„ã€‚
- 5-6ç‚¹: åŸºæœ¬ã¯ã§ãã¦ã„ã‚‹ãŒæ·±ã¿ãŒãªã„ã€‚å°æœ¬é€šã‚Šã®åŸºæº–ç‚¹ã€‚
- 7-8ç‚¹: åŠ¹æœçš„ã«å®Ÿè¡Œã€‚é¡§å®¢ã®åå¿œã‚’å¼•ãå‡ºã›ã¦ã„ã‚‹ã€‚
- 9-10ç‚¹: å“è¶Šã€‚é¡§å®¢ã®æ„Ÿæƒ…ãŒæ˜ç¢ºã«å‹•ã„ãŸè¨¼æ‹ ã‚ã‚Šã€‚

## 10è»¸ã®è©•ä¾¡åŸºæº–
1. æ¨©å¨æ€§: ã€Œé¸ã¶å´ã€ã®ã‚¹ã‚¿ãƒ³ã‚¹ç¶­æŒã€‚ç›¸æ‰‹ã‹ã‚‰ã®æ•¬æ„ã‚’å¾—ã¦ã„ã‚‹ã‹ã€‚
2. æå¤±å›é¿: ç¾çŠ¶ç¶­æŒã®ãƒªã‚¹ã‚¯ã‚’å…·ä½“çš„ã«æŒ‡æ‘˜ã€‚ç›¸æ‰‹ãŒç„¦ã‚Šã‚„å±æ©Ÿæ„Ÿã‚’æ„Ÿã˜ãŸã‹ã€‚
3. ãƒªãƒ•ãƒ¬ãƒ¼ãƒŸãƒ³ã‚°: ã€Œã‚¹ã‚¯ãƒ¼ãƒ«ã€ã‚’ã€Œç¤¾å†…ç ”ä¿®ã€ç­‰ã«å®šç¾©å¤‰æ›´ã€‚é¡§å®¢ãŒæ–°ã—ã„å®šç¾©ã‚’å—å…¥ã‚ŒãŸã‹ã€‚
4. ã‚¢ãƒ³ã‚«ãƒªãƒ³ã‚°: è²»ç”¨ã‚’ã€Œè¦šæ‚Ÿã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã€ã€ŒæŠ•è³‡ã€ã¨å®šç¾©ã—å®‰ãæ„Ÿã˜ã•ã›ãŸã‹ã€‚
5. ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ³ã‚°: ã€Œæ‰‹ç¶šãé€²ã‚ã¾ã™ã€ã¨è¨€ã„åˆ‡ã‚Šã€ç›¸æ‰‹ã‚’èª˜å°ã§ããŸã‹ã€‚
6. ãƒ’ã‚¢ãƒªãƒ³ã‚°: é¡§å®¢ã®èª²é¡Œãƒ»ãƒ‹ãƒ¼ã‚ºã‚’çš„ç¢ºã«å¼•ãå‡ºã›ãŸã‹ã€‚æ·±å €ã‚Šè³ªå•ãŒã§ããŸã‹ã€‚
7. ãƒ©ãƒãƒ¼ãƒ«: ä¿¡é ¼é–¢ä¿‚æ§‹ç¯‰ã€‚å…±æ„Ÿãƒ»ã‚ªã‚¦ãƒ è¿”ã—ãƒ»åå‰å‘¼ã³ãŒã‚ã£ãŸã‹ã€‚
8. åè«–å‡¦ç†: åè«–ã‚’å—ã‘æ­¢ã‚ã€æ¡ä»¶ä»˜ãYesã«æŒã¡è¾¼ã‚ãŸã‹ã€‚
9. ãƒ†ãƒ³ãƒ: æ²ˆé»™ã®æ´»ç”¨ã€çŸ¢ç¶™ãæ—©ã«ãªã‚‰ãšé–“ã‚’å–ã‚ŒãŸã‹ã€‚
10. ææ¡ˆåŠ›: æŠ½è±¡è«–ã§ãªãå…·ä½“çš„ãªæ´»ç”¨ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’æã‘ãŸã‹ã€‚

# é‡ç‚¹ãƒã‚§ãƒƒã‚¯: å¼±ç‚¹ã€Œ${wp}ã€ã«ç‰¹ã«å³ã—ã

# å‡ºåŠ›ãƒ«ãƒ¼ãƒ«
- å„è»¸ã«ã¯å¿…ãševidenceï¼ˆæ ¹æ‹ ã¨ãªã‚‹ç™ºè¨€ã®å¼•ç”¨ï¼‰ã¨deductionï¼ˆæ¸›ç‚¹ç†ç”±ï¼‰ã‚’ä»˜ã‘ã‚‹
- åŒã˜ãƒ­ã‚°ãªã‚‰ä½•åº¦æ¡ç‚¹ã—ã¦ã‚‚åŒã˜ç‚¹æ•°ã«ãªã‚‹ã‚ˆã†ã€ãƒ«ãƒ–ãƒªãƒƒã‚¯ã«å¿ å®Ÿãªå®¢è¦³çš„æ¡ç‚¹ã‚’ã™ã‚‹

# å‡ºåŠ›(JSON)
{
  "total":åˆè¨ˆç‚¹æ•°å€¤,
  "sub":{
    "authority":{"score":æ•°å€¤,"evidence":"æ ¹æ‹ ç™ºè¨€","deduction":"æ¸›ç‚¹ç†ç”±"},
    "loss_aversion":{"score":æ•°å€¤,"evidence":"","deduction":""},
    "reframing":{"score":æ•°å€¤,"evidence":"","deduction":""},
    "anchoring":{"score":æ•°å€¤,"evidence":"","deduction":""},
    "closing":{"score":æ•°å€¤,"evidence":"","deduction":""},
    "hearing":{"score":æ•°å€¤,"evidence":"","deduction":""},
    "rapport":{"score":æ•°å€¤,"evidence":"","deduction":""},
    "objection":{"score":æ•°å€¤,"evidence":"","deduction":""},
    "tempo":{"score":æ•°å€¤,"evidence":"","deduction":""},
    "proposal":{"score":æ•°å€¤,"evidence":"","deduction":""}
  },
  "feedback":"è¾›å£ã ãŒå»ºè¨­çš„ãªç·è©•(200å­—)",
  "best_moment":"ä¸€ç•ªè‰¯ã‹ã£ãŸç¬é–“",
  "ideal":"å¼±ç‚¹ã‚·ãƒ¼ãƒ³ã§ã®ç†æƒ³ãƒˆãƒ¼ã‚¯ä¾‹",
  "timeline":[{"time":"ç§’æ•°","event":"ä½•ãŒèµ·ããŸã‹","evaluation":"è‰¯ã„/æ‚ªã„/æ™®é€š","comment":"ä¸€è¨€"}]
}`;

  try{
    const res=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`,{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({contents:[{role:'user',parts:[{text:prompt}]}],generationConfig:{responseMimeType:'application/json',temperature:0}})
    });
    const json=await res.json();
    let raw=json.candidates?.[0]?.content?.parts?.[0]?.text||'{}';
    raw=raw.replace(/```json/g,'').replace(/```/g,'').trim();
    const result=JSON.parse(raw);
    // Normalize sub scores
    if(result.sub){
      const norm={};
      Object.entries(result.sub).forEach(([k,v])=>{
        norm[k]=typeof v==='object'?v:{score:v,evidence:'',deduction:''};
      });
      result.sub=norm;
    }
    showResult(result);
    saveHistory(result);
    saveUsage(result);
    postToGAS(result);
  }catch(e){alert('æ¡ç‚¹ã‚¨ãƒ©ãƒ¼: '+e.message)}
  document.getElementById('btnGrade').disabled=false;
  document.getElementById('btnGrade').textContent='ğŸ“Š æ¡ç‚¹';
}

function showResult(r){
  document.getElementById('resultScore').textContent=r.total+'ç‚¹';
  const sub=Object.entries(r.sub||{}).map(([k,v])=>{
    const sc=typeof v==='object'?v.score:v;
    const ev=typeof v==='object'?v.evidence:'';
    const ded=typeof v==='object'?v.deduction:'';
    return `<div style="margin-bottom:10px">
      <div class="sb-item"><div class="n">${SUB_NAMES[k]||k}</div><div class="bg"><div class="fl" style="width:${(sc/10)*100}%;background:${sc<5?'var(--red)':sc<7?'var(--gold)':'var(--green)'}"></div></div><div class="v">${sc}</div>
      <button onclick="drillWeakPoint('${k}')" style="background:none;border:1px solid var(--accent);color:var(--accent);border-radius:12px;padding:1px 8px;font-size:10px;cursor:pointer;margin-left:4px" title="ã“ã®å¼±ç‚¹ã§ç·´ç¿’">ğŸ¯</button></div>
      ${ev?`<div style="font-size:10px;color:var(--green);padding-left:80px;margin-top:2px">âœ… ${ev}</div>`:''}
      ${ded?`<div style="font-size:10px;color:var(--red);padding-left:80px">âŒ ${ded}</div>`:''}
    </div>`;
  }).join('');
  document.getElementById('resultSubScores').innerHTML=sub;
  document.getElementById('resultComment').innerHTML=`<p>${r.feedback||''}</p>`+(r.best_moment?`<p style="margin-top:10px;color:var(--green)">âœ… ${r.best_moment}</p>`:'');
  if(r.ideal){document.getElementById('idealSection').style.display='block';document.getElementById('idealResponse').textContent=r.ideal}
  if(r.timeline?.length){
    document.getElementById('timelineSection').style.display='block';
    document.getElementById('timelineContent').innerHTML=r.timeline.map(t=>`<div style="margin-bottom:8px;padding:8px;background:var(--surface2);border-radius:8px;font-size:12px"><span style="color:${t.evaluation==='è‰¯ã„'?'var(--green)':t.evaluation==='æ‚ªã„'?'var(--red)':'var(--text2)'}">${t.evaluation==='è‰¯ã„'?'âœ…':t.evaluation==='æ‚ªã„'?'âŒ':'â–'}</span> <b>${t.event}</b><br><span style="color:var(--text2)">${t.comment}</span></div>`).join('');
  }
  // Drill: worst 3
  if(r.sub){
    const sorted=Object.entries(r.sub).map(([k,v])=>[k,typeof v==='object'?v.score:v]).sort((a,b)=>a[1]-b[1]);
    const worst3=sorted.slice(0,3);
    document.getElementById('drillSection').style.display='block';
    document.getElementById('drillButtons').innerHTML=worst3.map(([k,sc])=>
      `<button onclick="drillWeakPoint('${k}')" style="display:block;width:100%;margin-bottom:6px;background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);color:#fca5a5;border-radius:8px;padding:8px;font-size:12px;cursor:pointer;text-align:left">ğŸ¯ ${SUB_NAMES[k]} (${sc}ç‚¹) ã§ãƒ”ãƒ³ãƒã‚¤ãƒ³ãƒˆç·´ç¿’</button>`
    ).join('');
    document.getElementById('weakPoint').value=worst3[0][0];updateHint();
  }
  document.getElementById('overlay').classList.add('show');
  updateTitle(r.total);
}

function drillWeakPoint(key){
  closeResult();
  document.getElementById('weakPoint').value=key;updateHint();
  const map={anchoring:'price_objection',closing:'closing_3min',hearing:'opening',rapport:'opening'};
  if(map[key])document.getElementById('scenario').value=map[key];
  document.querySelector('.chat-area').scrollIntoView({behavior:'smooth'});
  const btn=document.getElementById('btnStart');
  btn.style.animation='pulse 0.5s 3';setTimeout(()=>btn.style.animation='',2000);
}

function closeResult(){
  document.getElementById('overlay').classList.remove('show');
  ['idealSection','timelineSection','drillSection'].forEach(id=>document.getElementById(id).style.display='none');
}

// === HISTORY ===
function saveHistory(r){
  const h=JSON.parse(localStorage.getItem('rp_history')||'[]');
  const subScores={};
  if(r.sub) Object.entries(r.sub).forEach(([k,v])=>subScores[k]=typeof v==='object'?v.score:v);
  h.unshift({date:new Date().toLocaleDateString('ja-JP'),score:r.total,sub:subScores,wp:document.getElementById('weakPoint').value,name:document.getElementById('salesName').value||'?'});
  if(h.length>50)h.length=50;
  localStorage.setItem('rp_history',JSON.stringify(h));
  loadHistory();updateStreak();
}
function loadHistory(){
  const h=JSON.parse(localStorage.getItem('rp_history')||'[]');
  const el=document.getElementById('historyList');
  if(!h.length){el.innerHTML='<span style="font-size:11px;color:var(--text2)">ã¾ã å±¥æ­´ãªã—</span>';return}
  el.innerHTML=h.slice(0,10).map(i=>`<div class="history-item"><span>${i.date} ${i.name}</span><span class="hs">${i.score}ç‚¹</span></div>`).join('');
  if(h.length&&h[0].sub){
    Object.entries(h[0].sub).forEach(([k,v])=>{
      const bar=document.getElementById('bar_'+k);
      const val=document.getElementById('val_'+k);
      if(bar&&val){bar.style.width=(v/10*100)+'%';val.textContent=v;}
    });
  }
  renderTrendChart();
}

// === SCORE TREND CHART (Chart.js) ===
function renderTrendChart(){
  const h=JSON.parse(localStorage.getItem('rp_history')||'[]');
  const canvas=document.getElementById('trendChart');
  if(!canvas||!h.length)return;
  const recent=h.slice(0,10).reverse();
  const labels=recent.map((_,i)=>'#'+(i+1));
  const scores=recent.map(i=>i.score);

  if(window.trendChartInstance) window.trendChartInstance.destroy();

  window.trendChartInstance=new Chart(canvas.getContext('2d'),{
    type:'line',
    data:{
      labels,
      datasets:[{
        label:'ç·åˆã‚¹ã‚³ã‚¢',
        data:scores,
        borderColor:'#4f6ef7',
        backgroundColor:'rgba(79,110,247,0.1)',
        fill:true,
        tension:0.3,
        pointRadius:4,
        pointBackgroundColor:'#4f6ef7'
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      scales:{
        y:{min:0,max:100,ticks:{color:'#94a3b8',font:{size:10}},grid:{color:'rgba(42,47,64,0.5)'}},
        x:{ticks:{color:'#94a3b8',font:{size:9}},grid:{display:false}}
      },
      plugins:{legend:{display:false}}
    }
  });
}

// === USAGE TRACKING ===
function saveUsage(r){
  const usage=JSON.parse(localStorage.getItem('rp_usage')||'[]');
  const dur=startTime?Math.floor((Date.now()-startTime)/1000):0;
  const subScores={};
  if(r.sub) Object.entries(r.sub).forEach(([k,v])=>subScores[k]=typeof v==='object'?v.score:v);
  usage.push({
    name:document.getElementById('salesName').value||'æœªè¨­å®š',
    date:new Date().toISOString(),
    month:new Date().toLocaleDateString('ja-JP',{year:'numeric',month:'2-digit'}),
    score:r.total, sub:subScores,
    duration:dur,
    scenario:document.getElementById('scenario').value,
    weakPoint:document.getElementById('weakPoint').value
  });
  localStorage.setItem('rp_usage',JSON.stringify(usage));
}

// === GAS POST (æ¡ç‚¹çµæœã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«é€ä¿¡) ===
async function postToGAS(result){
  const gasUrl=document.getElementById('gasUrl').value.trim();
  if(!gasUrl)return;
  try{
    const subScores={};
    if(result.sub) Object.entries(result.sub).forEach(([k,v])=>subScores[k]=typeof v==='object'?v.score:v);
    await fetch(gasUrl,{
      method:'POST',
      mode:'no-cors',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        name:document.getElementById('salesName').value||'æœªè¨­å®š',
        date:new Date().toISOString(),
        score:result.total,
        sub:subScores,
        feedback:result.feedback||'',
        weakPoint:document.getElementById('weakPoint').value,
        scenario:document.getElementById('scenario').value,
        duration:startTime?Math.floor((Date.now()-startTime)/1000):0
      })
    });
    console.log('GAS POSTå®Œäº†');
  }catch(e){console.warn('GAS POSTã‚¨ãƒ©ãƒ¼:',e)}
}

function showUsageDashboard(){
  const usage=JSON.parse(localStorage.getItem('rp_usage')||'[]');
  const months=[...new Set(usage.map(u=>u.month))].sort().reverse();
  const sel=document.getElementById('usageMonth');
  const cur=new Date().toLocaleDateString('ja-JP',{year:'numeric',month:'2-digit'});
  if(!months.length)months.push(cur);
  sel.innerHTML=months.map(m=>`<option>${m}</option>`).join('');
  renderUsageDashboard();
  document.getElementById('usageOverlay').classList.add('show');
}

function renderUsageDashboard(){
  const usage=JSON.parse(localStorage.getItem('rp_usage')||'[]');
  const month=document.getElementById('usageMonth').value;
  const filtered=usage.filter(u=>u.month===month);
  const byName={};
  filtered.forEach(u=>{
    if(!byName[u.name])byName[u.name]={count:0,totalScore:0,totalDur:0,lastDate:''};
    byName[u.name].count++;
    byName[u.name].totalScore+=u.score||0;
    byName[u.name].totalDur+=u.duration||0;
    byName[u.name].lastDate=u.date?.split('T')[0]||'';
  });
  let html='<table style="width:100%;border-collapse:collapse;font-size:12px">';
  html+='<tr style="border-bottom:1px solid var(--border)"><th style="text-align:left;padding:6px">æ‹…å½“è€…</th><th>å›æ•°</th><th>å¹³å‡ç‚¹</th><th>åˆè¨ˆæ™‚é–“</th><th>æœ€çµ‚</th></tr>';
  Object.entries(byName).sort((a,b)=>b[1].count-a[1].count).forEach(([name,d])=>{
    const avg=d.count?(d.totalScore/d.count).toFixed(1):'--';
    const mins=Math.floor(d.totalDur/60);
    html+=`<tr style="border-bottom:1px solid var(--border)"><td style="padding:6px;font-weight:600">${name}</td><td style="text-align:center">${d.count}å›</td><td style="text-align:center;color:${avg>=70?'var(--green)':avg>=50?'var(--gold)':'var(--red)'}">${avg}</td><td style="text-align:center">${mins}åˆ†</td><td style="text-align:center;font-size:10px">${d.lastDate}</td></tr>`;
  });
  if(!Object.keys(byName).length)html+='<tr><td colspan="5" style="text-align:center;padding:20px;color:var(--text2)">ã¾ã ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr>';
  html+='</table>';
  document.getElementById('usageTable').innerHTML=html;
}

function exportUsageCSV(){
  const usage=JSON.parse(localStorage.getItem('rp_usage')||'[]');
  const month=document.getElementById('usageMonth').value;
  const filtered=usage.filter(u=>u.month===month);
  let csv='æ‹…å½“è€…,æ—¥æ™‚,ã‚¹ã‚³ã‚¢,æ™‚é–“(ç§’),ã‚·ãƒŠãƒªã‚ª,å¼±ç‚¹\n';
  filtered.forEach(u=>csv+=`${u.name},${u.date},${u.score},${u.duration},${u.scenario},${u.weakPoint}\n`);
  const blob=new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`roleplay_usage_${month}.csv`;a.click();
}

// === GAS INTEGRATION (å¤±æ³¨ãƒ‡ãƒ¼ã‚¿å–å¾—) ===
async function fetchLossData(){
  const url=document.getElementById('gasUrl').value.trim();
  if(!url){alert('GAS Web App URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return}
  localStorage.setItem('rp_gasUrl',url);
  try{
    const res=await fetch(url);
    const data=await res.json();
    const sel=document.getElementById('lossSelect');
    sel.style.display='block';
    sel.innerHTML='<option value="">å¤±æ³¨å•†è«‡ã‚’é¸æŠ...</option>'+
      data.map((d,i)=>`<option value="${i}">${d.date} ${d.name} ${d.result} ${d.score}ç‚¹ - ${d.bad_cause||''}</option>`).join('');
    sel.onchange=()=>{
      const idx=sel.value;if(idx==='')return;
      const d=data[Number(idx)];
      document.getElementById('persona').value='custom';
      document.getElementById('customPersonaBox').style.display='block';
      document.getElementById('customTranscript').value=`ã€æ‹…å½“ã€‘${d.name}\nã€çµæœã€‘${d.result}\nã€ã‚¹ã‚³ã‚¢ã€‘${d.score}ç‚¹\nã€æœ€å¤§ã®æ¸›ç‚¹è¦å› ã€‘${d.bad_cause||''}\nã€ç·è©•ã€‘${d.summary||''}\nã€ã‚¹ã‚­ãƒ«å†…è¨³ã€‘æ¨©å¨æ€§:${d.sub?.authority||'-'} æå¤±å›é¿:${d.sub?.loss_aversion||'-'} RF:${d.sub?.reframing||'-'} ã‚¢ãƒ³ã‚«ãƒ¼:${d.sub?.anchoring||'-'} CL:${d.sub?.closing||'-'}`;
      if(d.sub){
        const worst=Object.entries(d.sub).sort((a,b)=>Number(a[1])-Number(b[1]))[0];
        if(worst&&document.getElementById('weakPoint').querySelector(`option[value="${worst[0]}"]`)){
          document.getElementById('weakPoint').value=worst[0];updateHint();
        }
      }
    };
  }catch(e){alert('GASå–å¾—ã‚¨ãƒ©ãƒ¼: '+e.message)}
}
(function(){const u=localStorage.getItem('rp_gasUrl');if(u)document.getElementById('gasUrl').value=u}());

// === STREAK ===
function updateStreak(){
  const h=JSON.parse(localStorage.getItem('rp_history')||'[]');
  if(!h.length){document.getElementById('streakBadge').innerHTML='';return}
  const days=new Set(h.map(i=>i.date));
  let streak=0;let d=new Date();
  while(days.has(d.toLocaleDateString('ja-JP'))){streak++;d.setDate(d.getDate()-1)}
  document.getElementById('streakBadge').innerHTML=streak>=2?`<span class="streak-badge">ğŸ”¥ ${streak}æ—¥é€£ç¶š</span>`:'';
}

// === TITLE ===
function updateTitle(score){
  const h=JSON.parse(localStorage.getItem('rp_history')||'[]');
  const recent3=h.slice(0,3).map(i=>i.score);
  let title='';
  if(recent3.length>=3&&recent3.every(s=>s>=80))title='ğŸ¥‡ ã‚´ãƒ¼ãƒ«ãƒ‰ã‚¯ãƒ­ãƒ¼ã‚¶ãƒ¼';
  else if(score>=80)title='ğŸ¥ˆ ã‚·ãƒ«ãƒãƒ¼ã‚¯ãƒ­ãƒ¼ã‚¶ãƒ¼';
  else if(score>=65)title='ğŸ¥‰ ãƒ–ãƒ­ãƒ³ã‚ºã‚¯ãƒ­ãƒ¼ã‚¶ãƒ¼';
  document.getElementById('titleBadge').innerHTML=title?`<span class="title-badge">${title}</span>`:'';
}
</script>
</body>
</html>
