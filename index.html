<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Sales Roleplay | ISAI</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<style>
:root{--bg:#0d0f14;--surface:#161920;--surface2:#1e2230;--border:#2a2f40;--accent:#4f6ef7;--accent2:#7c3aed;--green:#22c55e;--red:#ef4444;--gold:#f59e0b;--text:#e2e8f0;--text2:#94a3b8;--radius:12px}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:'Inter','Hiragino Sans',sans-serif;min-height:100vh;display:flex;flex-direction:column}
header{padding:16px 24px;display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--border);background:var(--surface)}
header .logo{font-size:20px;font-weight:800;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}
header .meta{display:flex;gap:16px;margin-left:auto;font-size:12px;color:var(--text2);align-items:center;flex-wrap:wrap}
header .meta span{display:flex;align-items:center;gap:4px}
.badge{background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:2px 10px;font-size:11px;font-weight:600}
main{flex:1;display:grid;grid-template-columns:300px 1fr;overflow:hidden}
@media(max-width:768px){main{grid-template-columns:1fr}.sidebar{position:fixed;left:-320px;top:60px;bottom:0;width:300px;z-index:50;transition:left .3s}.sidebar.open{left:0}.mobile-toggle{display:block!important}}
.mobile-toggle{display:none;position:fixed;top:70px;left:8px;z-index:51;background:var(--accent);color:#fff;border:none;border-radius:50%;width:36px;height:36px;font-size:16px;cursor:pointer}
.sidebar{background:var(--surface);border-right:1px solid var(--border);padding:16px;display:flex;flex-direction:column;gap:14px;overflow-y:auto}
.sh{font-size:11px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.08em}
.config-form{display:flex;flex-direction:column;gap:10px}
.config-form label{font-size:11px;color:var(--text2);margin-bottom:2px;display:block}
.config-form input,.config-form select{width:100%;background:var(--surface2);border:1px solid var(--border);color:var(--text);border-radius:8px;padding:8px 10px;font-size:12px;outline:none}
.config-form input:focus,.config-form select:focus{border-color:var(--accent)}
.score-preview{display:flex;flex-direction:column;gap:6px}
.sb-item{display:flex;align-items:center;gap:6px;font-size:11px}
.sb-item .n{color:var(--text2);width:75px;flex-shrink:0}
.sb-item .bg{flex:1;height:5px;background:var(--border);border-radius:3px;overflow:hidden}
.sb-item .fl{height:100%;border-radius:3px;background:var(--accent);transition:width .8s}
.sb-item .v{color:var(--text);width:24px;text-align:right;font-weight:600}
.hint-box{background:rgba(79,110,247,.08);border:1px solid rgba(79,110,247,.25);border-radius:var(--radius);padding:12px}
.hint-box .ht{font-size:10px;color:var(--accent);font-weight:700;margin-bottom:6px}
.hint-box .hc{font-size:12px;color:var(--text2);line-height:1.5}
.chat-area{display:flex;flex-direction:column;height:100%;overflow:hidden}
.messages{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:12px}
.msg{display:flex;gap:10px;max-width:80%;animation:msgIn .25s ease-out}
.msg.ai{align-self:flex-start}
.msg.user{align-self:flex-end;flex-direction:row-reverse}
.msg-av{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
.msg.ai .msg-av{background:rgba(124,58,237,.2);border:1px solid rgba(124,58,237,.4)}
.msg.user .msg-av{background:rgba(79,110,247,.2);border:1px solid rgba(79,110,247,.4)}
.msg-bb{padding:10px 14px;border-radius:14px;font-size:13px;line-height:1.6}
.msg.ai .msg-bb{background:var(--surface2);border:1px solid var(--border);border-bottom-left-radius:4px}
.msg.user .msg-bb{background:rgba(79,110,247,.15);border:1px solid rgba(79,110,247,.25);border-bottom-right-radius:4px}
.msg-t{font-size:10px;color:var(--text2);margin-top:3px}
.msg.system{align-self:center;max-width:90%}
.msg.system .msg-bb{background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.2);color:var(--gold);font-size:12px;text-align:center}
.msg.live .msg-bb{border-color:var(--accent);box-shadow:0 0 8px rgba(79,110,247,.15)}
@keyframes msgIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.controls{padding:14px 20px;border-top:1px solid var(--border);background:var(--surface);display:flex;flex-direction:column;gap:10px}
.status-bar{display:flex;align-items:center;gap:8px}
.status-dot{width:8px;height:8px;border-radius:50%;background:var(--border);transition:all .3s;flex-shrink:0}
.status-dot.listening{background:var(--green);box-shadow:0 0 6px var(--green);animation:pulse 1.5s infinite}
.status-dot.speaking{background:var(--accent2);box-shadow:0 0 6px var(--accent2);animation:pulse 1s infinite}
.status-dot.thinking{background:var(--gold);box-shadow:0 0 6px var(--gold);animation:pulse .8s infinite}
.status-text{font-size:12px;color:var(--text2)}
.vol-bar{flex:1;height:3px;background:var(--border);border-radius:2px;overflow:hidden}
.vol-fill{height:100%;background:var(--green);border-radius:2px;width:0%;transition:width .05s}
canvas.waveform{width:100%;height:36px;border-radius:6px;background:var(--surface2)}
.btn-row{display:flex;gap:10px}
.btn{padding:10px 18px;border-radius:30px;border:none;font-size:13px;font-weight:700;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:6px}
.btn-start{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;flex:1;justify-content:center;font-size:14px;padding:14px}
.btn-start:hover{opacity:.85;transform:translateY(-1px);box-shadow:0 6px 20px rgba(79,110,247,.3)}
.btn-start:disabled{opacity:.4;cursor:not-allowed;transform:none;box-shadow:none}
.btn-stop{background:rgba(239,68,68,.15);border:1px solid rgba(239,68,68,.3);color:#fca5a5;padding:10px 16px}
.btn-stop:hover{background:rgba(239,68,68,.25)}
.btn-grade{background:rgba(245,158,11,.15);border:1px solid rgba(245,158,11,.3);color:#fcd34d}
.btn-grade:hover{background:rgba(245,158,11,.25)}
.btn-grade:disabled,.btn-stop:disabled{opacity:.35;cursor:not-allowed}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:100;backdrop-filter:blur(4px)}
.overlay.show{display:flex}
.result-card{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:28px;max-width:580px;width:92%;max-height:85vh;overflow-y:auto}
.result-score{font-size:52px;font-weight:900;text-align:center;background:linear-gradient(135deg,var(--gold),#f97316);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}
.result-label{text-align:center;font-size:12px;color:var(--text2);margin-top:2px}
.result-section{margin-top:16px}
.result-section h3{font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:.08em;margin-bottom:8px}
.result-comment{font-size:13px;line-height:1.7;color:var(--text)}
.btn-close{width:100%;margin-top:20px;background:var(--accent);color:#fff;border:none;padding:12px;border-radius:30px;font-size:14px;font-weight:700;cursor:pointer}
.btn-close:hover{opacity:.85}
.history-list{max-height:200px;overflow-y:auto}
.history-item{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);font-size:11px;color:var(--text2)}
.history-item .hs{color:var(--text);font-weight:600}
.streak-badge{background:linear-gradient(135deg,#f97316,var(--gold));color:#000;border-radius:20px;padding:3px 10px;font-size:11px;font-weight:800;display:inline-flex;align-items:center;gap:4px}
.title-badge{background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:3px 10px;font-size:11px;font-weight:600;color:var(--gold)}
.chart-wrap{position:relative;height:220px;margin-top:8px}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
</style>
</head>
<body>

<button class="mobile-toggle" onclick="document.querySelector('.sidebar').classList.toggle('open')">&#9776;</button>

<header>
<span class="logo">AI Sales Roleplay</span>
<span style="font-size:12px;color:var(--text2);margin-left:6px">Powered by Gemini Live</span>
<div class="meta">
  <span id="turnCount">&#128260; 0&#24448;&#24489;</span>
  <span id="sessionTimer">&#9201; 00:00</span>
  <span id="streakBadge"></span>
  <span id="titleBadge"></span>
  <button onclick="showUsageDashboard()" style="background:var(--surface2);border:1px solid var(--border);color:var(--text2);border-radius:20px;padding:2px 10px;font-size:11px;cursor:pointer">&#128202; &#21033;&#29992;&#29366;&#27841;</button>
</div>
</header>

<main>
<aside class="sidebar">
  <div class="sh">&#12525;&#12540;&#12503;&#12524;&#35373;&#23450;</div>
  <div class="config-form">
    <div><label>&#25285;&#24403;&#32773;&#21517;</label><input type="text" id="salesName" placeholder="&#20363;: &#39640;&#27211;"></div>
    <div><label>&#20811;&#26381;&#12377;&#12409;&#12365;&#24369;&#28857;</label>
      <select id="weakPoint">
        <option value="anchoring">&#12450;&#12531;&#12459;&#12522;&#12531;&#12464;&#65288;&#20385;&#26684;&#25552;&#31034;&#65289;</option>
        <option value="authority">&#27177;&#23041;&#24615;&#65288;&#36984;&#12406;&#20596;&#12473;&#12479;&#12531;&#12473;&#65289;</option>
        <option value="loss_aversion">&#25613;&#22833;&#22238;&#36991;&#65288;&#29694;&#29366;&#12522;&#12473;&#12463;&#25351;&#25688;&#65289;</option>
        <option value="reframing">&#12522;&#12501;&#12524;&#12540;&#12511;&#12531;&#12464;&#65288;&#12473;&#12463;&#12540;&#12523;&#8594;&#30740;&#20462;&#65289;</option>
        <option value="closing">&#12463;&#12525;&#12540;&#12472;&#12531;&#12464;&#65288;&#35328;&#12356;&#20999;&#12426;&#35480;&#23566;&#65289;</option>
        <option value="hearing">&#12498;&#12450;&#12522;&#12531;&#12464;&#65288;&#35506;&#38988;&#12398;&#28145;&#22528;&#12426;&#65289;</option>
        <option value="rapport">&#12521;&#12509;&#12540;&#12523;&#65288;&#20449;&#38972;&#27083;&#31689;&#65289;</option>
        <option value="objection">&#21453;&#35542;&#20966;&#29702;&#65288;&#20999;&#12426;&#36820;&#12375;&#21147;&#65289;</option>
        <option value="tempo">&#12486;&#12531;&#12509;&#65288;&#20250;&#35441;&#12398;&#12522;&#12474;&#12512;&#65289;</option>
        <option value="proposal">&#25552;&#26696;&#21147;&#65288;&#35299;&#27770;&#31574;&#12398;&#20855;&#20307;&#24615;&#65289;</option>
      </select></div>
    <div><label>&#21830;&#26448;</label>
      <select id="product">
        <option value="ISAI">ISAI&#65288;AI&#12510;&#12540;&#12465;&#12479;&#12540;&#12473;&#12463;&#12540;&#12523;&#65289;</option>
        <option value="Adoafi">Adoafi</option>
      </select></div>
    <div><label>&#39015;&#23458;&#12506;&#12523;&#12477;&#12490;</label>
      <select id="persona">
        <option value="price">&#12300;&#39640;&#12356;&#12301;&#12392;&#35328;&#12358;&#39015;&#23458;</option>
        <option value="compare">&#12300;&#20182;&#12392;&#27604;&#12409;&#12383;&#12356;&#12301;&#39015;&#23458;</option>
        <option value="busy">&#12300;&#24537;&#12375;&#12367;&#12390;&#26178;&#38291;&#12364;&#12394;&#12356;&#12301;&#39015;&#23458;</option>
        <option value="spouse">&#12300;&#37197;&#20598;&#32773;&#12395;&#30456;&#35527;&#12375;&#12383;&#12356;&#12301;&#39015;&#23458;</option>
        <option value="doubt">&#12300;&#26412;&#24403;&#12395;&#21177;&#26524;&#12354;&#12427;&#12398;&#65311;&#12301;&#39015;&#23458;</option>
        <option value="custom">&#128257; &#23455;&#21830;&#35527;&#12488;&#12524;&#12540;&#12473;&#65288;&#8595;&#12525;&#12464;&#36028;&#20184;&#65289;</option>
      </select></div>
    <div id="customPersonaBox" style="display:none">
      <label>&#128203; &#22833;&#27880;&#21830;&#35527;&#12525;&#12464;&#12434;&#36028;&#12426;&#20184;&#12369;</label>
      <textarea id="customTranscript" rows="6" placeholder="&#21830;&#35527;&#12398;&#35696;&#20107;&#37682;&#12289;&#25991;&#23383;&#36215;&#12371;&#12375;&#12289;&#12414;&#12383;&#12399;GAS FB&#12484;&#12540;&#12523;&#12398;&#32207;&#35413;&#12434;&#36028;&#12426;&#20184;&#12369;&#12390;&#12367;&#12384;&#12373;&#12356;&#12290;AI&#12364;&#12371;&#12398;&#39015;&#23458;&#12398;&#35441;&#12375;&#26041;&#12539;&#24605;&#32771;&#12497;&#12479;&#12540;&#12531;&#12434;&#20877;&#29694;&#12375;&#12414;&#12377;&#12290;" style="width:100%;background:var(--surface2);border:1px solid var(--border);color:var(--text);border-radius:8px;padding:8px;font-size:11px;resize:vertical"></textarea>
    </div>
    <div><label>&#38627;&#26131;&#24230;</label>
      <select id="difficulty">
        <option value="easy">&#127793; &#26131;&#65288;&#20055;&#12426;&#12420;&#12377;&#12356;&#39015;&#23458;&#65289;</option>
        <option value="medium" selected>&#127793; &#20013;&#65288;&#26222;&#36890;&#12398;&#39015;&#23458;&#65289;</option>
        <option value="hard">&#128308; &#38627;&#65288;&#38929;&#22266;&#12394;&#39015;&#23458;&#65289;</option>
      </select></div>
    <div><label>&#12471;&#12490;&#12522;&#12458;</label>
      <select id="scenario">
        <option value="full">&#12501;&#12523;&#21830;&#35527;&#65288;&#33258;&#30001;&#20250;&#35441;&#65289;</option>
        <option value="opening">&#20882;&#38957;5&#20998;&#65288;&#12450;&#12452;&#12473;&#12502;&#12524;&#12452;&#12463;&#8594;&#12498;&#12450;&#12522;&#12531;&#12464;&#65289;</option>
        <option value="price_objection">&#20385;&#26684;&#25552;&#31034;&#24460;&#12398;&#20999;&#12426;&#36820;&#12375;</option>
        <option value="closing_3min">&#12463;&#12525;&#12540;&#12472;&#12531;&#12464;&#26368;&#24460;&#12398;3&#20998;</option>
      </select></div>
    <div><label>Gemini API Key</label><input type="password" id="apiKey" placeholder="AIzaSy..."></div>
    <div><label>&#12514;&#12487;&#12523;</label>
      <select id="modelName">
        <option value="gemini-2.5-flash-native-audio-preview-12-2025">gemini-2.5-flash-native-audio (&#25512;&#22888;)</option>
        <option value="gemini-2.0-flash-exp">gemini-2.0-flash-exp</option>
        <option value="gemini-2.0-flash-live-001">gemini-2.0-flash-live-001</option>
      </select></div>
    <div><label><input type="checkbox" id="saveKey" style="width:auto;margin-right:6px">API Key&#12434;&#20445;&#23384;&#12377;&#12427;</label></div>
  </div>

  <div>
    <div class="sh" style="margin-bottom:8px">&#12473;&#12467;&#12450;&#25512;&#31227;(10&#36600;)</div>
    <div class="score-preview" id="scorePreview"></div>
  </div>

  <div class="hint-box"><div class="ht">&#127891; &#12371;&#12398;&#12525;&#12540;&#12503;&#12524;&#12398;&#30446;&#27161;</div><div class="hc" id="hintText"></div></div>

  <div>
    <div class="sh" style="margin-bottom:8px">GAS&#21830;&#35527;FB&#36899;&#25658;</div>
    <div class="config-form">
      <div><label>GAS Web App URL</label><input type="text" id="gasUrl" placeholder="https://script.google.com/macros/s/..." style="font-size:10px"></div>
      <button onclick="fetchLossData()" class="btn" style="background:rgba(79,110,247,.15);border:1px solid rgba(79,110,247,.25);color:var(--accent);padding:6px 12px;font-size:11px;width:100%">&#128203; &#22833;&#27880;&#12487;&#12540;&#12479;&#21462;&#24471;</button>
      <select id="lossSelect" style="display:none;width:100%;background:var(--surface2);border:1px solid var(--border);color:var(--text);border-radius:8px;padding:8px;font-size:11px"></select>
    </div>
  </div>

  <div>
    <div class="sh" style="margin-bottom:8px">&#32244;&#32722;&#23653;&#27508;</div>
    <div class="history-list" id="historyList"><span style="font-size:11px;color:var(--text2)">&#12414;&#12384;&#23653;&#27508;&#12394;&#12375;</span></div>
  </div>
</aside>

<div class="chat-area">
  <div class="messages" id="messages">
    <div style="text-align:center;color:var(--text2);font-size:12px;margin-top:40px">&#35373;&#23450;&#12434;&#30906;&#35469;&#12375;&#12390;&#12300;&#12525;&#12540;&#12503;&#12524;&#38283;&#22987;&#12301;&#12434;&#25276;&#12375;&#12390;&#12367;&#12384;&#12373;&#12356;</div>
  </div>
  <div class="controls">
    <div class="status-bar">
      <div class="status-dot" id="statusDot"></div>
      <span class="status-text" id="statusText">&#24453;&#27231;&#20013;</span>
      <div class="vol-bar"><div class="vol-fill" id="volFill"></div></div>
    </div>
    <canvas class="waveform" id="waveCanvas"></canvas>
    <div class="btn-row">
      <button class="btn btn-start" id="btnStart" onclick="startSession()">&#127908; &#12525;&#12540;&#12503;&#12524;&#38283;&#22987;</button>
      <button class="btn btn-stop" id="btnStop" onclick="stopSession()" disabled>&#9209; &#32066;&#20102;</button>
      <button class="btn btn-grade" id="btnGrade" onclick="gradeSession()" disabled>&#128202; &#25505;&#28857;</button>
    </div>
  </div>
</div>
</main>

<!-- Result overlay -->
<div class="overlay" id="overlay">
<div class="result-card">
  <div class="result-score" id="resultScore">--</div>
  <div class="result-label">&#12525;&#12540;&#12503;&#12524;&#25505;&#28857;&#65288;100&#28857;&#28288;&#28857;&#65289;</div>
  <div class="result-section"><h3>&#128202; 10&#36600;&#12473;&#12467;&#12450;</h3><div id="resultSubScores"></div></div>
  <div class="result-section"><h3>&#128172; AI&#12467;&#12540;&#12481;&#12363;&#12425;&#12398;&#12501;&#12451;&#12540;&#12489;&#12496;&#12483;&#12463;</h3><div class="result-comment" id="resultComment"></div></div>
  <div class="result-section" id="idealSection" style="display:none"><h3>&#10024; &#29702;&#24819;&#12398;&#12488;&#12540;&#12463;&#20363;</h3><div class="result-comment" id="idealResponse"></div></div>
  <div class="result-section" id="timelineSection" style="display:none"><h3>&#128336; &#12479;&#12452;&#12512;&#12521;&#12452;&#12531;&#25391;&#12426;&#36820;&#12426;</h3><div class="result-comment" id="timelineContent"></div></div>
  <div class="result-section" id="drillSection" style="display:none"><h3>&#127919; &#24369;&#28857;&#12500;&#12531;&#12509;&#12452;&#12531;&#12488;&#32244;&#32722;</h3><div id="drillButtons"></div></div>
  <button class="btn-close" onclick="closeResult()">&#38281;&#12376;&#12427;</button>
</div>
</div>

<!-- Usage dashboard overlay -->
<div class="overlay" id="usageOverlay">
<div class="result-card" style="max-width:750px">
  <h2 style="text-align:center;margin-bottom:16px">&#128202; &#26376;&#21029;&#21033;&#29992;&#29366;&#27841;</h2>
  <div style="display:flex;gap:8px;margin-bottom:12px;justify-content:center">
    <select id="usageMonth" onchange="renderUsageDashboard()" style="background:var(--surface2);border:1px solid var(--border);color:var(--text);border-radius:8px;padding:6px 10px;font-size:12px"></select>
    <button onclick="exportUsageCSV()" style="background:var(--accent);color:#fff;border:none;border-radius:8px;padding:6px 12px;font-size:11px;cursor:pointer">&#128229; CSV</button>
  </div>
  <div id="usageTable"></div>
  <div class="chart-wrap"><canvas id="scoreChart"></canvas></div>
  <button class="btn-close" onclick="document.getElementById('usageOverlay').classList.remove('show')">&#38281;&#12376;&#12427;</button>
</div>
</div>

<script>
// =========================================================
// CONFIG
// =========================================================
const HINTS={
  anchoring:'\u300c\u5024\u6bb5\u304c\u9ad8\u3044\u300d\u3068\u8a00\u308f\u308c\u305f\u77ac\u9593\u304c\u52dd\u8ca0\u3002\u8cbb\u7528\u3092\u300c\u6295\u8cc7\u300d\u300c\u63a1\u7528\u8cbb\u63db\u7b97\u300d\u300c\u6708\u5272\u308a\u300d\u306b\u5909\u63db\u3002\u300c\u899a\u609f\u306e\u30d5\u30a3\u30eb\u30bf\u30fc\u300d\u3068\u3057\u3066\u5b9a\u7fa9\u3059\u308b\u3053\u3068\u304c\u9375\u3002',
  authority:'\u300c\u9078\u3076\u5074\u300d\u306e\u30b9\u30bf\u30f3\u30b9\u3092\u5d29\u3055\u306a\u3044\u3002\u9867\u5ba2\u306e\u8cea\u554f\u306b\u5373\u7b54\u305b\u305a\u300c\u306a\u305c\u305d\u306e\u8cea\u554f\u3092\u3059\u308b\u304b\u300d\u3092\u8fd4\u3059\u3002',
  loss_aversion:'\u300c3\u5e74\u5f8c\u306e\u81ea\u5206\u306e\u59ff\u3092\u60f3\u50cf\u3057\u3066\u304f\u3060\u3055\u3044\u300d\u300c\u540c\u3044\u5e74\u306e\u4eba\u304c\u3069\u3053\u306b\u3044\u308b\u304b\u300d\u3067\u73fe\u72b6\u30ea\u30b9\u30af\u3092\u7a81\u304f\u3002',
  reframing:'\u300c\u30b9\u30af\u30fc\u30eb\u300d\u300c\u5b66\u6821\u300d\u3092\u300c\u793e\u5185\u7814\u4fee\u300d\u300c\u30de\u30fc\u30b1\u30c6\u30a3\u30f3\u30b0\u5ba4\u306e\u7acb\u3061\u4e0a\u3052\u300d\u306b\u5909\u63db\u3002\u9867\u5ba2\u304c\u305d\u306e\u8a00\u8449\u3092\u4f7f\u3044\u59cb\u3081\u305f\u3089\u6210\u529f\u3002',
  closing:'\u300c\u624b\u7d9a\u304d\u9032\u3081\u307e\u3059\u300d\u3068\u8a00\u3044\u5207\u308b\u7df4\u7fd2\u3002\u300c\u3067\u306f\u301c\u3068\u3044\u3046\u3053\u3068\u3067\u3088\u3044\u3067\u3059\u304b\uff1f\u300d\u2192\u300c\u3067\u306f\u624b\u7d9a\u304d\u306b\u79fb\u308a\u307e\u3057\u3087\u3046\u300d\u3068\u4e3b\u8a9e\u3092\u5909\u3048\u308b\u3002',
  hearing:'\u300c\u306a\u305c\u305d\u3046\u601d\u3044\u307e\u3059\u304b\uff1f\u300d\u300c\u4ed6\u306b\u56f0\u3063\u3066\u3044\u308b\u3053\u3068\u306f\uff1f\u300d\u3067\u9867\u5ba2\u306e\u672c\u97f3\u3092\u5f15\u304d\u51fa\u3059\u3002\u8868\u9762\u7684\u306a\u56de\u7b54\u3067\u7d42\u308f\u3089\u305b\u306a\u3044\u3002',
  rapport:'\u6700\u521d\u306e90\u79d2\u3067\u5171\u611f\u30dd\u30a4\u30f3\u30c8\u3092\u898b\u3064\u3051\u308b\u3002\u76f8\u624b\u306e\u540d\u524d\u3092\u547c\u3076\u3001\u5171\u901a\u70b9\u3092\u898b\u3064\u3051\u308b\u3001\u76f8\u624b\u306e\u8a00\u8449\u3092\u30aa\u30a6\u30e0\u8fd4\u3057\u3059\u308b\u3002',
  objection:'\u53cd\u8ad6\u306f\u8cb7\u3044\u305f\u3044\u30b5\u30a4\u30f3\u3002\u300c\u3068\u3044\u3046\u3053\u3068\u306f\u301c\u304c\u89e3\u6c7a\u3059\u308c\u3070\u524d\u5411\u304d\u3067\u3059\u304b\uff1f\u300d\u3068\u6761\u4ef6\u4ed8\u304dYes\u306b\u6301\u3061\u8fbc\u3080\u3002',
  tempo:'\u6c88\u9ed9\u3092\u6016\u304c\u3089\u306a\u3044\u3002\u8cea\u554f\u3057\u305f\u5f8c3\u79d2\u5f85\u3064\u3002\u77e2\u7d99\u304e\u65e9\u306b\u8a71\u3055\u305a\u3001\u76f8\u624b\u306b\u8003\u3048\u308b\u9593\u3092\u4e0e\u3048\u308b\u3002',
  proposal:'\u62bd\u8c61\u7684\u306a\u30e1\u30ea\u30c3\u30c8\u3067\u306f\u306a\u304f\u300c\u5fa1\u793e\u306e\u5834\u5408\u301c\u300d\u3068\u5177\u4f53\u7684\u306a\u6d3b\u7528\u30a4\u30e1\u30fc\u30b8\u3092\u63cf\u304f\u3002\u6570\u5b57\u3067\u793a\u3059\u3002'
};
const PERSONAS={
  price:{jp:'\u300c\u9ad8\u3044\u300d\u3068\u8a00\u3046\u9867\u5ba2',intro:'\u3061\u3087\u3063\u3068\u2026\u6b63\u76f4\u3001\u5024\u6bb5\u304c\u3061\u3087\u3063\u3068\u6c17\u306b\u306a\u3063\u3066\u3066\u3002'},
  compare:{jp:'\u6bd4\u8f03\u691c\u8a0e\u3059\u308b\u9867\u5ba2',intro:'\u4ed6\u306b\u3082\u4f3c\u305f\u3088\u3046\u306a\u30b9\u30af\u30fc\u30eb\u3042\u308b\u3058\u3083\u306a\u3044\u3067\u3059\u304b\uff1f\u305d\u3063\u3061\u3068\u6bd4\u3079\u305f\u304f\u3066\u3002'},
  busy:{jp:'\u300c\u5fd9\u3057\u3044\u300d\u9867\u5ba2',intro:'\u8208\u5473\u306f\u3042\u308b\u3093\u3067\u3059\u3051\u3069\u3001\u6b63\u76f4\u4eca\u3059\u3054\u304f\u5fd9\u3057\u304f\u3066\u3001\u6642\u9593\u304c\u53d6\u308c\u308b\u304b\u3069\u3046\u304b\u2026'},
  spouse:{jp:'\u300c\u914d\u5076\u8005\u76f8\u8ac7\u300d\u9867\u5ba2',intro:'\u3044\u3044\u3068\u306f\u601d\u3046\u3093\u3067\u3059\u3051\u3069\u3001\u4e00\u5fdc\u59bb\u306b\u3082\u76f8\u8ac7\u3057\u3066\u304b\u3089\u3058\u3083\u306a\u3044\u3068\u3061\u3087\u3063\u3068\u2026'},
  doubt:{jp:'\u300c\u52b9\u679c\u3042\u308b\u306e\uff1f\u300d\u9867\u5ba2',intro:'AI\u30de\u30fc\u30b1\u30c6\u30a3\u30f3\u30b0\u3063\u3066\u7d50\u5c40\u3069\u306e\u304f\u3089\u3044\u5b9f\u969b\u306b\u4f7f\u3048\u308b\u3093\u3067\u3059\u304b\uff1f'},
  custom:{jp:'\u5b9f\u5546\u8ac7\u30c8\u30ec\u30fc\u30b9\u9867\u5ba2',intro:'\uff08\u30ed\u30b0\u304b\u3089\u81ea\u52d5\u751f\u6210\uff09'}
};
const DIFFICULTY={easy:'\u3042\u306a\u305f\u306f\u6bd4\u8f03\u7684\u4e57\u308a\u3084\u3059\u3044\u9867\u5ba2\u3067\u3059\u3002\u826f\u3044\u63d0\u6848\u306b\u306f\u3059\u3050\u524d\u306e\u3081\u308a\u306b\u53cd\u5fdc\u3057\u307e\u3059\u3002\u3057\u304b\u3057\u6700\u4f4e\u9650\u306e\u8cea\u554f\u306f\u3057\u307e\u3059\u3002',medium:'\u3042\u306a\u305f\u306f\u30ea\u30a2\u30eb\u306a\u9867\u5ba2\u3067\u3059\u3002\u7c21\u5358\u306b\u306f\u4e57\u3089\u306a\u3044\u304c\u3001\u4e0a\u624b\u3044\u30ea\u30d5\u30ec\u30fc\u30df\u30f3\u30b0\u306b\u306f\u53cd\u5fdc\u3057\u307e\u3059\u3002',hard:'\u3042\u306a\u305f\u306f\u975e\u5e38\u306b\u9811\u56fa\u306a\u9867\u5ba2\u3067\u3059\u3002\u4f55\u3092\u8a00\u308f\u308c\u3066\u3082\u7c21\u5358\u306b\u306f\u7d0d\u5f97\u3057\u307e\u305b\u3093\u3002\u8ad6\u7406\u7684\u306b\u5b8c\u74a7\u306a\u8aac\u660e\u3060\u3051\u306b\u5c11\u3057\u5fc3\u304c\u52d5\u304d\u307e\u3059\u3002\u5e38\u306b\u53cd\u8ad6\u3092\u63a2\u3057\u307e\u3059\u3002'};
const SCENARIOS={full:'\u81ea\u7531\u306b\u4f1a\u8a71\u3057\u3066\u304f\u3060\u3055\u3044\u3002',opening:'\u5546\u8ac7\u306e\u5192\u982d5\u5206\u3092\u60f3\u5b9a\u3002\u81ea\u5df1\u7d39\u4ecb\u2192\u30d2\u30a2\u30ea\u30f3\u30b0\u2192\u8ab2\u984c\u306e\u6df1\u5800\u308a\u307e\u3067\u3002\u307e\u3060\u5546\u54c1\u63d0\u6848\u306f\u3057\u306a\u3044\u30d5\u30a7\u30fc\u30ba\u3002',price_objection:'\u3059\u3067\u306b\u5546\u54c1\u8aac\u660e\u306f\u7d42\u308f\u3063\u3066\u3044\u308b\u3002\u4fa1\u683c\u3092\u805e\u3044\u3066\u300c\u9ad8\u3044\u300d\u3068\u53cd\u5fdc\u3057\u305f\u76f4\u5f8c\u304b\u3089\u4f1a\u8a71\u3092\u59cb\u3081\u3066\u304f\u3060\u3055\u3044\u3002',closing_3min:'\u5546\u8ac7\u306e\u7d42\u76e4\u3002\u9867\u5ba2\u306f\u8208\u5473\u306f\u3042\u308b\u304c\u6c7a\u65ad\u3092\u8ff7\u3063\u3066\u3044\u308b\u72b6\u614b\u3002\u3053\u3053\u304b\u30893\u5206\u3067\u30af\u30ed\u30fc\u30b8\u30f3\u30b0\u307e\u3067\u6301\u3063\u3066\u3044\u304f\u7df4\u7fd2\u3002'};
const SUB_NAMES={authority:'\u6a29\u5a01\u6027',loss_aversion:'\u640d\u5931\u56de\u907f',reframing:'\u30ea\u30d5\u30ec\u30fc\u30df\u30f3\u30b0',anchoring:'\u30a2\u30f3\u30ab\u30fc',closing:'\u30af\u30ed\u30fc\u30b8\u30f3\u30b0',hearing:'\u30d2\u30a2\u30ea\u30f3\u30b0',rapport:'\u30e9\u30dd\u30fc\u30eb',objection:'\u53cd\u8ad6\u51e6\u7406',tempo:'\u30c6\u30f3\u30dd',proposal:'\u63d0\u6848\u529b'};
const ALL_SUBS = Object.keys(SUB_NAMES);

// =========================================================
// STATE
// =========================================================
let ws=null,audioContext=null,processor=null,mediaStream=null,sessionActive=false;
let conversationLog=[],timerInterval=null,startTime=null,volumeAnimFrame=null,analyserNode=null;
let turnCount=0,playbackCtx=null,silenceTimer=null;
let mediaRecorder=null,recordedChunks=[];
let waveCtx=null,waveData=null;

// Transcript accumulation (LINE-style live display)
let aiTranscriptBuf='',aiMsgEl=null;
let userTranscriptBuf='',userMsgEl=null;

// Scheduled audio playback (low-latency)
let nextPlayTime=0, scheduledSources=[];

// =========================================================
// INIT
// =========================================================
document.getElementById('weakPoint').addEventListener('change',updateHint);
document.getElementById('persona').addEventListener('change',()=>{
  document.getElementById('customPersonaBox').style.display = document.getElementById('persona').value==='custom'?'block':'none';
});
updateHint();
initScoreBars();
loadApiKey();
loadHistory();
updateStreak();

function initScoreBars(){
  const el=document.getElementById('scorePreview');el.innerHTML='';
  ALL_SUBS.forEach(k=>{
    el.innerHTML+=`<div class="sb-item"><div class="n">${SUB_NAMES[k]}</div><div class="bg"><div class="fl" id="bar_${k}" style="width:50%"></div></div><div class="v" id="val_${k}">-</div></div>`;
  });
}

function updateHint(){document.getElementById('hintText').textContent=HINTS[document.getElementById('weakPoint').value]||''}
function loadApiKey(){const k=localStorage.getItem('rp_apikey');if(k){document.getElementById('apiKey').value=k;document.getElementById('saveKey').checked=true}}
function saveApiKey(){if(document.getElementById('saveKey').checked)localStorage.setItem('rp_apikey',document.getElementById('apiKey').value);else localStorage.removeItem('rp_apikey')}

// =========================================================
// STATUS
// =========================================================
function setStatus(s,t){document.getElementById('statusDot').className='status-dot '+(s||'');document.getElementById('statusText').textContent=t}
function updateTurnCount(){document.getElementById('turnCount').textContent='\u{1F504} '+turnCount+'\u5F80\u5FA9'}

// =========================================================
// MESSAGE HELPERS (LINE-style chat)
// =========================================================
function createMsgEl(role,text){
  const d=document.createElement('div');
  d.className='msg '+(role==='ai'?'ai':role==='system'?'system':'user');
  const t=new Date().toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  if(role==='system'){d.innerHTML=`<div class="msg-bb">${text}</div>`}
  else{d.innerHTML=`<div class="msg-av">${role==='ai'?'\u{1F464}':'\u{1F9D1}\u200D\u{1F4BC}'}</div><div><div class="msg-bb">${text.replace(/\n/g,'<br>')}</div><div class="msg-t">${role==='ai'?'\u9867\u5BA2(AI)':'\u55B6\u696D'} \xB7 ${t}</div></div>`}
  const m=document.getElementById('messages');m.appendChild(d);m.scrollTop=m.scrollHeight;
  return d;
}

function updateMsgEl(el,text){
  if(!el)return;
  const bb=el.querySelector('.msg-bb');
  if(bb)bb.innerHTML=text.replace(/\n/g,'<br>');
  const m=document.getElementById('messages');m.scrollTop=m.scrollHeight;
}

function addMsg(role,text){
  const d=createMsgEl(role,text);
  const t=new Date().toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  conversationLog.push({role:role==='ai'?'\u9867\u5BA2':role==='system'?'system':'\u55B6\u696D',text,time:t,ts:Date.now()});
  if(role==='user')turnCount++;
  updateTurnCount();
  return d;
}
function clearMsgs(){document.getElementById('messages').innerHTML='';conversationLog=[];turnCount=0;updateTurnCount()}

// =========================================================
// TIMER
// =========================================================
function startTimer(){startTime=Date.now();timerInterval=setInterval(()=>{const s=Math.floor((Date.now()-startTime)/1000);document.getElementById('sessionTimer').textContent='\u23F1 '+String(Math.floor(s/60)).padStart(2,'0')+':'+String(s%60).padStart(2,'0')},1000)}

// =========================================================
// WAVEFORM
// =========================================================
function initWave(){const c=document.getElementById('waveCanvas');waveCtx=c.getContext('2d');c.width=c.offsetWidth*2;c.height=72;waveData=new Uint8Array(128)}
function drawWave(){if(!sessionActive||!waveCtx)return;if(analyserNode){analyserNode.getByteTimeDomainData(waveData)}
const w=waveCtx.canvas.width,h=waveCtx.canvas.height;waveCtx.fillStyle='#1e2230';waveCtx.fillRect(0,0,w,h);
waveCtx.lineWidth=2;waveCtx.strokeStyle='#4f6ef7';waveCtx.beginPath();
const sl=w/waveData.length;let x=0;
for(let i=0;i<waveData.length;i++){const v=waveData[i]/128;const y=v*h/2;if(i===0)waveCtx.moveTo(x,y);else waveCtx.lineTo(x,y);x+=sl}
waveCtx.stroke();requestAnimationFrame(drawWave)}

// =========================================================
// SILENCE HINT
// =========================================================
function resetSilenceTimer(){
  clearTimeout(silenceTimer);
  silenceTimer=setTimeout(()=>{
    if(!sessionActive)return;
    const wp=document.getElementById('weakPoint').value;
    const hints={anchoring:'\u{1F4A1} \u300c\u305d\u308c\u306f\u6295\u8cc7\u3067\u3059\u300d\u3068\u8a00\u3044\u63db\u3048\u3066\u307f\u307e\u3057\u3087\u3046',authority:'\u{1F4A1} \u300c\u306a\u305c\u305d\u3046\u601d\u3044\u307e\u3059\u304b\uff1f\u300d\u3068\u8fd4\u3057\u3066\u307f\u307e\u3057\u3087\u3046',loss_aversion:'\u{1F4A1} \u300c3\u5e74\u5f8c\u306e\u81ea\u5206\u3092\u60f3\u50cf\u3057\u3066\u307f\u3066\u304f\u3060\u3055\u3044\u300d',reframing:'\u{1F4A1} \u300c\u30b9\u30af\u30fc\u30eb\u3067\u306f\u306a\u304f\u793e\u5185\u7814\u4fee\u3067\u3059\u300d\u3068\u5b9a\u7fa9\u3057\u76f4\u3057\u307e\u3057\u3087\u3046',closing:'\u{1F4A1} \u300c\u3067\u306f\u624b\u7d9a\u304d\u306b\u79fb\u308a\u307e\u3057\u3087\u3046\u300d\u3068\u8a00\u3044\u5207\u3063\u3066\u307f\u307e\u3057\u3087\u3046'};
    addMsg('system',hints[wp]||'\u{1F4A1} \u4f55\u304b\u8a71\u3057\u304b\u3051\u3066\u307f\u307e\u3057\u3087\u3046');
  },15000);
}

// =========================================================
// GEMINI LIVE API — startSession
// =========================================================
async function startSession(){
  const apiKey=document.getElementById('apiKey').value.trim();
  if(!apiKey){alert('API Key\u3092\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044');return}
  saveApiKey();
  clearMsgs();initWave();
  // Reset transcript state
  aiTranscriptBuf='';aiMsgEl=null;userTranscriptBuf='';userMsgEl=null;
  nextPlayTime=0;scheduledSources=[];

  document.getElementById('btnStart').disabled=true;
  document.getElementById('btnStop').disabled=false;
  document.getElementById('btnGrade').disabled=true;
  setStatus('thinking','\u63A5\u7D9A\u4E2D...');

  const persona=PERSONAS[document.getElementById('persona').value];
  const product=document.getElementById('product').value;
  const weakPoint=document.getElementById('weakPoint').value;
  const salesName=document.getElementById('salesName').value||'\u55B6\u696D\u62C5\u5F53';
  const diff=DIFFICULTY[document.getElementById('difficulty').value];
  const scn=SCENARIOS[document.getElementById('scenario').value];
  const isCustom = document.getElementById('persona').value==='custom';
  const customLog = isCustom ? document.getElementById('customTranscript').value.trim() : '';

  let systemPrompt;
  if(isCustom && customLog){
    systemPrompt=`\u3042\u306a\u305f\u306f\u65e5\u672c\u4eba\u306e\u9867\u5ba2\u5f79\u3067\u3059\u3002\u5fc5\u305a\u65e5\u672c\u8a9e\u3060\u3051\u3067\u8a71\u3057\u3066\u304f\u3060\u3055\u3044\u3002\u82f1\u8a9e\u306f\u7d76\u5bfe\u306b\u4f7f\u308f\u306a\u3044\u3067\u304f\u3060\u3055\u3044\u3002

\u4ee5\u4e0b\u306f\u5b9f\u969b\u306e\u5546\u8ac7\u3067\u5931\u6ce8\u3057\u305f\u9867\u5ba2\u306e\u4f1a\u8a71\u30ed\u30b0\u3067\u3059\u3002\u3053\u306e\u9867\u5ba2\u306e\u8a71\u3057\u65b9\u3001\u601d\u8003\u30d1\u30bf\u30fc\u30f3\u3001\u53cd\u8ad6\u306e\u4ed5\u65b9\u3001\u53e3\u7656\u3092\u30c8\u30ec\u30fc\u30b9\u3057\u3066\u3001\u540c\u3058\u30bf\u30a4\u30d7\u306e\u9867\u5ba2\u3068\u3057\u3066\u632f\u308b\u821e\u3063\u3066\u304f\u3060\u3055\u3044\u3002

\u3010\u5b9f\u5546\u8ac7\u30ed\u30b0\u3011
${customLog.substring(0,3000)}

\u3010\u30eb\u30fc\u30eb\u3011
- \u4e0a\u8a18\u30ed\u30b0\u306e\u9867\u5ba2\u306e\u8a71\u3057\u65b9\u30fb\u6027\u683c\u30fb\u53cd\u8ad6\u30d1\u30bf\u30fc\u30f3\u3092\u518d\u73fe\u3059\u308b
- \u5fc5\u305a\u65e5\u672c\u8a9e\u306e\u307f\u3002\u82f1\u8a9e\u7981\u6b62\u3002
- 1\u56de\u306e\u767a\u8a00\u306f\u77ed\u304f\uff081\u301c2\u6587\uff09
- ${diff}
- ${scn}
- \u30e1\u30bf\u7684\u306a\u8aac\u660e\u306f\u4e0d\u8981\u3002\u9867\u5ba2\u3068\u3057\u3066\u76f4\u63a5\u4f1a\u8a71\u3059\u308b\u3002

\u3053\u306e\u9867\u5ba2\u306b\u306a\u308a\u304d\u3063\u3066\u3001\u6700\u521d\u306e\u767a\u8a00\u3092\u3057\u3066\u304f\u3060\u3055\u3044\u3002`;
  } else {
    systemPrompt=`\u3042\u306a\u305f\u306f\u65e5\u672c\u4eba\u306e\u9867\u5ba2\u5f79\u3067\u3059\u3002\u5fc5\u305a\u65e5\u672c\u8a9e\u3060\u3051\u3067\u8a71\u3057\u3066\u304f\u3060\u3055\u3044\u3002\u82f1\u8a9e\u306f\u7d76\u5bfe\u306b\u4f7f\u308f\u306a\u3044\u3067\u304f\u3060\u3055\u3044\u3002

\u3042\u306a\u305f\u306f\u300c${persona.jp}\u300d\u3068\u3057\u3066\u3001${product}\u306e\u55b6\u696d\u62c5\u5f53\u300c${salesName}\u3055\u3093\u300d\u3068\u97f3\u58f0\u3067\u4f1a\u8a71\u3059\u308b\u9867\u5ba2\u3067\u3059\u3002

\u3010\u5f79\u67c4\u3011
- \u65e5\u672c\u4eba\u306e30\u4ee3\u4f1a\u793e\u54e1
- \u6700\u521d\u306e\u767a\u8a00: \u300c${persona.intro}\u300d
- ${diff}

\u3010\u30eb\u30fc\u30eb\u3011
- \u5fc5\u305a\u65e5\u672c\u8a9e\u306e\u307f\u3067\u8a71\u3059\u3002\u82f1\u8a9e\u7981\u6b62\u3002
- \u55b6\u696d\u306e\u5f31\u70b9\uff08${weakPoint}\uff09\u3092\u7a81\u304f\u53cd\u5fdc\u3092\u3059\u308b
- 1\u56de\u306e\u767a\u8a00\u306f\u77ed\u304f\uff081\u301c2\u6587\uff09
- \u300c\u3042\u30fc\u300d\u300c\u3046\u3093\u3046\u3093\u300d\u300c\u306a\u308b\u307b\u3069\u300d\u3068\u81ea\u7136\u306b\u76f8\u69cc
- ${scn}
- \u30e1\u30bf\u7684\u306a\u8aac\u660e\u306f\u4e0d\u8981\u3002\u9867\u5ba2\u3068\u3057\u3066\u76f4\u63a5\u4f1a\u8a71\u3059\u308b\u3002

\u6700\u521d\u306e\u30bb\u30ea\u30d5\u300c${persona.intro}\u300d\u3092\u65e5\u672c\u8a9e\u3067\u8a71\u3057\u59cb\u3081\u3066\u304f\u3060\u3055\u3044\u3002`;
  }

  const MODEL=document.getElementById('modelName').value;
  const wsUrl=`wss://generativelanguage.googleapis.com/ws/google.ai.generativelanguage.v1beta.GenerativeService.BidiGenerateContent?key=${apiKey}`;

  try{
    ws=new WebSocket(wsUrl);
    addMsg('system','\u{1F50C} \u63A5\u7D9A\u4E2D... (\u30E2\u30C7\u30EB: '+MODEL+')');
    const connectTimeout=setTimeout(()=>{
      if(!sessionActive){setStatus('','\u63A5\u7D9A\u30BF\u30A4\u30E0\u30A2\u30A6\u30C8\u3002\u5225\u306E\u30E2\u30C7\u30EB\u3092\u8A66\u3057\u3066\u304F\u3060\u3055\u3044');resetUI();if(ws)ws.close()}
    },10000);

    ws.onopen=()=>{
      // Setup with transcription + fast VAD
      const setupPayload={
        setup:{
          model:`models/${MODEL}`,
          generation_config:{
            response_modalities:['AUDIO'],
            speech_config:{
              voice_config:{prebuilt_voice_config:{voice_name:'Puck'}},
              language_code:'ja-JP'
            },
            output_audio_transcription:{},
            input_audio_transcription:{}
          },
          realtime_input_config:{
            automatic_activity_detection:{
              disabled:false,
              start_of_speech_sensitivity:'START_OF_SPEECH_SENSITIVITY_HIGH',
              end_of_speech_sensitivity:'END_OF_SPEECH_SENSITIVITY_HIGH',
              silence_duration_ms:300
            }
          },
          system_instruction:{parts:[{text:systemPrompt}]}
        }
      };
      console.log('Setup:',JSON.stringify(setupPayload).substring(0,500));
      ws.send(JSON.stringify(setupPayload));
    };

    ws.onmessage=async(e)=>{
      const raw=typeof e.data==='string'?e.data:await e.data.text();
      const data=JSON.parse(raw);

      // --- Setup complete ---
      if(data.setupComplete){
        clearTimeout(connectTimeout);
        setStatus('listening','\u30ED\u30FC\u30D7\u30EC\u958B\u59CB\uFF01\u9867\u5BA2\u304C\u8A71\u3057\u304B\u3051\u307E\u3059...');
        sessionActive=true;startTimer();startRecording();
        addMsg('system','\u2705 \u63A5\u7D9A\u6210\u529F ('+MODEL+')');
        ws.send(JSON.stringify({client_content:{turns:[{role:'user',parts:[{text:'\u4F1A\u8A71\u3092\u59CB\u3081\u3066\u304F\u3060\u3055\u3044'}]}],turn_complete:true}}));
        await startMicrophone();
        drawWave();resetSilenceTimer();
        return;
      }

      // --- Input transcript (user speech -> text) ---
      const inTxt = data.serverContent?.inputTranscript?.text
        || (typeof data.serverContent?.inputTranscript==='string' ? data.serverContent.inputTranscript : null);
      if(inTxt){
        // Finalize any previous user message first if this looks like a new utterance
        if(userMsgEl && userTranscriptBuf && !userTranscriptBuf.endsWith(inTxt)){
          conversationLog.push({role:'\u55B6\u696D',text:userTranscriptBuf,time:new Date().toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit',second:'2-digit'}),ts:Date.now()});
          turnCount++;updateTurnCount();
          userTranscriptBuf='';userMsgEl=null;
        }
        userTranscriptBuf+=inTxt;
        if(!userMsgEl){
          userMsgEl=createMsgEl('user',userTranscriptBuf);
          userMsgEl.classList.add('live');
        } else {
          updateMsgEl(userMsgEl,userTranscriptBuf);
        }
        resetSilenceTimer();
      }

      // --- Model audio chunks ---
      if(data.serverContent?.modelTurn?.parts){
        // Finalize pending user message when AI starts responding
        if(userTranscriptBuf && userMsgEl){
          userMsgEl.classList.remove('live');
          conversationLog.push({role:'\u55B6\u696D',text:userTranscriptBuf,time:new Date().toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit',second:'2-digit'}),ts:Date.now()});
          turnCount++;updateTurnCount();
          userTranscriptBuf='';userMsgEl=null;
        }
        let hasAudio=false;
        for(const p of data.serverContent.modelTurn.parts){
          if(p.inlineData?.mimeType?.startsWith('audio/')){playAudioChunk(p.inlineData.data);hasAudio=true;}
        }
        if(hasAudio)setStatus('speaking','AI\u9867\u5BA2\u304C\u8A71\u3057\u3066\u3044\u307E\u3059...');
      }

      // --- Output transcript (AI speech -> text) ---
      if(data.serverContent?.outputTranscript?.text){
        const txt=data.serverContent.outputTranscript.text;
        aiTranscriptBuf+=txt;
        if(!aiMsgEl){
          aiMsgEl=createMsgEl('ai',aiTranscriptBuf);
          aiMsgEl.classList.add('live');
        } else {
          updateMsgEl(aiMsgEl,aiTranscriptBuf);
        }
      }

      // --- Interruption (barge-in) ---
      if(data.serverContent?.interrupted){
        clearAudioQueue();
        setStatus('listening','\u5272\u308A\u8FBC\u307F\u691C\u77E5 \u2014 \u7D9A\u3051\u3066\u3069\u3046\u305E');
      }

      // --- Turn complete ---
      if(data.serverContent?.turnComplete){
        // Finalize AI transcript
        if(aiMsgEl) aiMsgEl.classList.remove('live');
        if(aiTranscriptBuf){
          conversationLog.push({role:'\u9867\u5BA2',text:aiTranscriptBuf,time:new Date().toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit',second:'2-digit'}),ts:Date.now()});
        } else {
          // No transcript — show audio-only marker
          createMsgEl('ai','\u{1F50A} (\u97F3\u58F0\u306E\u307F)');
          conversationLog.push({role:'\u9867\u5BA2',text:'(\u97F3\u58F0\u767A\u8A00)',time:new Date().toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit',second:'2-digit'}),ts:Date.now()});
        }
        aiTranscriptBuf='';aiMsgEl=null;
        setStatus('listening','\u3042\u306A\u305F\u306E\u756A\u3067\u3059');
        resetSilenceTimer();
      }

      // --- Error ---
      if(data.error){
        console.error('Gemini Error:',data.error);
        setStatus('','\u30A8\u30E9\u30FC: '+(data.error.message||JSON.stringify(data.error)));
        addMsg('system','\u274C '+JSON.stringify(data.error));
        resetUI();
      }
    };

    ws.onerror=(e)=>{console.error('WS Error',e);clearTimeout(connectTimeout);setStatus('','\u63A5\u7D9A\u30A8\u30E9\u30FC\u3002\u5225\u306E\u30E2\u30C7\u30EB\u3092\u9078\u3093\u3067\u518D\u8A66\u884C\u3057\u3066\u304F\u3060\u3055\u3044');addMsg('system','\u274C WebSocket\u63A5\u7D9A\u30A8\u30E9\u30FC\u3002\u30E2\u30C7\u30EB\u3092\u5909\u66F4\u3057\u3066\u307F\u3066\u304F\u3060\u3055\u3044');resetUI()};
    ws.onclose=(e)=>{clearTimeout(connectTimeout);if(sessionActive){setStatus('','\u30BB\u30C3\u30B7\u30E7\u30F3\u7D42\u4E86');sessionActive=false}else if(document.getElementById('btnStart').disabled){setStatus('','\u63A5\u7D9A\u5931\u6557 (code:'+e.code+'). \u30E2\u30C7\u30EB\u3092\u5909\u66F4\u3057\u3066\u518D\u8A66\u884C\u3057\u3066\u304F\u3060\u3055\u3044');addMsg('system','\u274C code:'+e.code+' \u2014 \u5225\u306E\u30E2\u30C7\u30EB\u3092\u8A66\u3059\u304B\u3001API Key\u3092\u78BA\u8A8D\u3057\u3066\u304F\u3060\u3055\u3044');resetUI()}};
  }catch(err){alert('\u63A5\u7D9A\u5931\u6557: '+err.message);resetUI()}
}

function resetUI(){document.getElementById('btnStart').disabled=false;document.getElementById('btnStop').disabled=true;document.getElementById('btnGrade').disabled=conversationLog.length<2}

// =========================================================
// MICROPHONE
// =========================================================
async function startMicrophone(){
  try{
    mediaStream=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:true,noiseSuppression:true,autoGainControl:true}});
    audioContext=new AudioContext({sampleRate:16000});
    await audioContext.audioWorklet.addModule('data:application/javascript,'+encodeURIComponent(WORKLET_CODE));
    const src=audioContext.createMediaStreamSource(mediaStream);
    analyserNode=audioContext.createAnalyser();analyserNode.fftSize=256;
    src.connect(analyserNode);
    processor=new AudioWorkletNode(audioContext,'pcm-processor');
    src.connect(processor);
    processor.port.onmessage=(e)=>{if(!ws||ws.readyState!==1||!sessionActive)return;ws.send(JSON.stringify({realtime_input:{media_chunks:[{mime_type:'audio/pcm;rate=16000',data:ab2b64(e.data)}]}}))}
    processor.connect(audioContext.destination);
    startVolMon();
  }catch(err){addMsg('system','\u26A0\uFE0F \u30DE\u30A4\u30AF\u30A2\u30AF\u30BB\u30B9\u306B\u5931\u6557: '+err.message)}
}
const WORKLET_CODE=`class PcmProcessor extends AudioWorkletProcessor{constructor(){super();this._b=new Int16Array(1024);this._p=0}process(i){const d=i[0]?.[0];if(!d)return true;for(let j=0;j<d.length;j++){this._b[this._p++]=Math.max(-32768,Math.min(32767,d[j]*32768));if(this._p>=this._b.length){this.port.postMessage(this._b.buffer.slice(0));this._p=0}}return true}}registerProcessor('pcm-processor',PcmProcessor);`;

function ab2b64(buf){const b=new Uint8Array(buf);let s='';for(let i=0;i<b.byteLength;i++)s+=String.fromCharCode(b[i]);return btoa(s)}
function startVolMon(){const vf=document.getElementById('volFill');const d=new Uint8Array(analyserNode.frequencyBinCount);(function tick(){if(!sessionActive)return;analyserNode.getByteFrequencyData(d);vf.style.width=Math.min(100,d.reduce((a,b)=>a+b,0)/d.length*2)+'%';volumeAnimFrame=requestAnimationFrame(tick)})()}

// =========================================================
// AUDIO PLAYBACK — immediate scheduling (zero-batch latency)
// =========================================================
function getPlayCtx(){
  if(!playbackCtx||playbackCtx.state==='closed'){
    playbackCtx=new AudioContext({sampleRate:24000});
  }
  return playbackCtx;
}

function playAudioChunk(b64){
  const raw=atob(b64);const bytes=new Uint8Array(raw.length);
  for(let i=0;i<raw.length;i++)bytes[i]=raw.charCodeAt(i);
  const pcm=new Int16Array(bytes.buffer);const f32=new Float32Array(pcm.length);
  for(let i=0;i<pcm.length;i++)f32[i]=pcm[i]/32768;

  const ctx=getPlayCtx();
  const buf=ctx.createBuffer(1,f32.length,24000);
  buf.getChannelData(0).set(f32);

  const s=ctx.createBufferSource();
  s.buffer=buf;
  s.connect(ctx.destination);

  const now=ctx.currentTime;
  const startAt=Math.max(nextPlayTime,now);
  s.start(startAt);
  nextPlayTime=startAt+buf.duration;
  scheduledSources.push(s);
  s.onended=()=>{
    const idx=scheduledSources.indexOf(s);
    if(idx>=0)scheduledSources.splice(idx,1);
  };
}

function clearAudioQueue(){
  for(const s of scheduledSources){try{s.stop()}catch(e){}}
  scheduledSources=[];
  nextPlayTime=0;
}

// =========================================================
// RECORDING (stub — MediaRecorder for future use)
// =========================================================
function startRecording(){
  try{
    const dest=new AudioContext();const osc=dest.createOscillator();
    const combined=dest.createMediaStreamDestination();
    mediaRecorder=new MediaRecorder(combined.stream,{mimeType:'audio/webm'});
    recordedChunks=[];
    mediaRecorder.ondataavailable=e=>{if(e.data.size>0)recordedChunks.push(e.data)};
    mediaRecorder.start(1000);
  }catch(e){console.warn('Recording not supported:',e)}
}
function stopRecording(){if(mediaRecorder&&mediaRecorder.state!=='inactive'){mediaRecorder.stop()}}

// =========================================================
// STOP SESSION
// =========================================================
function stopSession(){
  sessionActive=false;clearTimeout(silenceTimer);
  if(volumeAnimFrame)cancelAnimationFrame(volumeAnimFrame);
  if(processor){processor.disconnect();processor=null}
  if(audioContext){audioContext.close();audioContext=null}
  if(playbackCtx){clearAudioQueue();playbackCtx.close();playbackCtx=null}
  if(mediaStream){mediaStream.getTracks().forEach(t=>t.stop());mediaStream=null}
  if(ws){ws.close();ws=null}
  if(timerInterval){clearInterval(timerInterval);timerInterval=null}
  stopRecording();
  // Finalize any pending transcripts
  if(aiTranscriptBuf){
    conversationLog.push({role:'\u9867\u5BA2',text:aiTranscriptBuf,time:new Date().toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit',second:'2-digit'}),ts:Date.now()});
    if(aiMsgEl)aiMsgEl.classList.remove('live');
    aiTranscriptBuf='';aiMsgEl=null;
  }
  if(userTranscriptBuf){
    conversationLog.push({role:'\u55B6\u696D',text:userTranscriptBuf,time:new Date().toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit',second:'2-digit'}),ts:Date.now()});
    turnCount++;updateTurnCount();
    if(userMsgEl)userMsgEl.classList.remove('live');
    userTranscriptBuf='';userMsgEl=null;
  }
  document.getElementById('volFill').style.width='0%';
  document.getElementById('btnStart').disabled=false;
  document.getElementById('btnStop').disabled=true;
  document.getElementById('btnGrade').disabled=conversationLog.length<2;
  setStatus('',conversationLog.length>=2?'\u7D42\u4E86\u3002\u300C\u63A1\u70B9\u300D\u3092\u62BC\u3057\u3066\u304F\u3060\u3055\u3044':'\u7D42\u4E86');
}

// =========================================================
// GRADING
// =========================================================
async function gradeSession(){
  const apiKey=document.getElementById('apiKey').value.trim();
  if(!apiKey)return;
  document.getElementById('btnGrade').disabled=true;
  document.getElementById('btnGrade').textContent='\u23F3 \u63A1\u70B9\u4E2D...';
  const logText=conversationLog.filter(m=>m.role!=='system').map(m=>`\u3010${m.role}\u3011${m.text}`).join('\n');
  const wp=document.getElementById('weakPoint').value;

  const prompt=`\u3042\u306a\u305f\u306fISAI\u578b\u30af\u30ed\u30fc\u30b8\u30f3\u30b0\u5546\u8ac7\u306eAI\u30b3\u30fc\u30c1\u3067\u3059\u3002\u4ee5\u4e0b\u306e\u30ed\u30fc\u30d7\u30ec\u4f1a\u8a71\u3092\u53b3\u5bc6\u306b\u63a1\u70b9\u3057\u3066\u304f\u3060\u3055\u3044\u3002
\u540c\u3058\u4f1a\u8a71\u30ed\u30b0\u3092\u4f55\u5ea6\u63a1\u70b9\u3057\u3066\u3082\u540c\u3058\u70b9\u6570\u306b\u306a\u308b\u3088\u3046\u3001\u4ee5\u4e0b\u306e\u30eb\u30d6\u30ea\u30c3\u30af\u306b\u5f93\u3063\u3066\u304f\u3060\u3055\u3044\u3002

# \u30ed\u30fc\u30d7\u30ec\u4f1a\u8a71\u30ed\u30b0
${logText}

# \u63a1\u70b9\u30eb\u30d6\u30ea\u30c3\u30af\uff08\u540410\u70b9\u6e80\u70b9\u3001\u5408\u8a08100\u70b9\uff09
\u5404\u8ef8\u306e\u63a1\u70b9\u57fa\u6e96:
- 0-2\u70b9: \u8a72\u5f53\u3059\u308b\u884c\u52d5\u304c\u5168\u304f\u306a\u3044\u3002\u8a66\u307f\u3059\u3089\u898b\u3089\u308c\u306a\u3044\u3002
- 3-4\u70b9: \u8a66\u307f\u306f\u3042\u308b\u304c\u4e0d\u5341\u5206\u307e\u305f\u306f\u9006\u52b9\u679c\u3002\u9867\u5ba2\u306b\u97ff\u3044\u3066\u3044\u306a\u3044\u3002
- 5-6\u70b9: \u57fa\u672c\u306f\u3067\u304d\u3066\u3044\u308b\u304c\u6df1\u307f\u304c\u306a\u3044\u3002\u53f0\u672c\u901a\u308a\u306e\u57fa\u6e96\u70b9\u3002
- 7-8\u70b9: \u52b9\u679c\u7684\u306b\u5b9f\u884c\u3002\u9867\u5ba2\u306e\u53cd\u5fdc\u3092\u5f15\u304d\u51fa\u305b\u3066\u3044\u308b\u3002
- 9-10\u70b9: \u5353\u8d8a\u3002\u9867\u5ba2\u306e\u611f\u60c5\u304c\u660e\u78ba\u306b\u52d5\u3044\u305f\u8a3c\u62e0\u3042\u308a\u3002

## 10\u8ef8\u306e\u8a55\u4fa1\u57fa\u6e96
1. \u6a29\u5a01\u6027: \u300c\u9078\u3076\u5074\u300d\u306e\u30b9\u30bf\u30f3\u30b9\u7dad\u6301\u3002\u76f8\u624b\u304b\u3089\u306e\u656c\u610f\u3092\u5f97\u3066\u3044\u308b\u304b\u3002
2. \u640d\u5931\u56de\u907f: \u73fe\u72b6\u7dad\u6301\u306e\u30ea\u30b9\u30af\u3092\u5177\u4f53\u7684\u306b\u6307\u6458\u3002\u76f8\u624b\u304c\u7126\u308a\u3084\u5371\u6a5f\u611f\u3092\u611f\u3058\u305f\u304b\u3002
3. \u30ea\u30d5\u30ec\u30fc\u30df\u30f3\u30b0: \u300c\u30b9\u30af\u30fc\u30eb\u300d\u3092\u300c\u793e\u5185\u7814\u4fee\u300d\u7b49\u306b\u5b9a\u7fa9\u5909\u66f4\u3002\u9867\u5ba2\u304c\u65b0\u3057\u3044\u5b9a\u7fa9\u3092\u53d7\u5165\u308c\u305f\u304b\u3002
4. \u30a2\u30f3\u30ab\u30ea\u30f3\u30b0: \u8cbb\u7528\u3092\u300c\u899a\u609f\u306e\u30d5\u30a3\u30eb\u30bf\u30fc\u300d\u300c\u6295\u8cc7\u300d\u3068\u5b9a\u7fa9\u3057\u5b89\u304f\u611f\u3058\u3055\u305b\u305f\u304b\u3002
5. \u30af\u30ed\u30fc\u30b8\u30f3\u30b0: \u300c\u624b\u7d9a\u304d\u9032\u3081\u307e\u3059\u300d\u3068\u8a00\u3044\u5207\u308a\u3001\u76f8\u624b\u3092\u8a98\u5c0e\u3067\u304d\u305f\u304b\u3002
6. \u30d2\u30a2\u30ea\u30f3\u30b0: \u9867\u5ba2\u306e\u8ab2\u984c\u30fb\u30cb\u30fc\u30ba\u3092\u7684\u78ba\u306b\u5f15\u304d\u51fa\u305b\u305f\u304b\u3002\u6df1\u5800\u308a\u8cea\u554f\u304c\u3067\u304d\u305f\u304b\u3002
7. \u30e9\u30dd\u30fc\u30eb: \u4fe1\u983c\u95a2\u4fc2\u69cb\u7bc9\u3002\u5171\u611f\u30fb\u30aa\u30a6\u30e0\u8fd4\u3057\u30fb\u540d\u524d\u547c\u3073\u304c\u3042\u3063\u305f\u304b\u3002
8. \u53cd\u8ad6\u51e6\u7406: \u53cd\u8ad6\u3092\u53d7\u3051\u6b62\u3081\u3001\u6761\u4ef6\u4ed8\u304dYes\u306b\u6301\u3061\u8fbc\u3081\u305f\u304b\u3002
9. \u30c6\u30f3\u30dd: \u6c88\u9ed9\u306e\u6d3b\u7528\u3001\u77e2\u7d99\u304e\u65e9\u306b\u306a\u3089\u305a\u9593\u3092\u53d6\u308c\u305f\u304b\u3002
10. \u63d0\u6848\u529b: \u62bd\u8c61\u8ad6\u3067\u306a\u304f\u5177\u4f53\u7684\u306a\u6d3b\u7528\u30a4\u30e1\u30fc\u30b8\u3092\u63cf\u3051\u305f\u304b\u3002

# \u91cd\u70b9\u30c1\u30a7\u30c3\u30af \u5f31\u70b9: ${wp} \u2014 \u3053\u306e\u9805\u76ee\u306b\u7279\u306b\u53b3\u3057\u304f

# \u51fa\u529b(JSON)
{ "total":\u5408\u8a08\u70b9\u6570\u5024(100\u70b9\u6e80\u70b9), "sub":{"authority":\u6570\u5024,"loss_aversion":\u6570\u5024,"reframing":\u6570\u5024,"anchoring":\u6570\u5024,"closing":\u6570\u5024,"hearing":\u6570\u5024,"rapport":\u6570\u5024,"objection":\u6570\u5024,"tempo":\u6570\u5024,"proposal":\u6570\u5024}, "feedback":"\u8f9b\u53e3\u3060\u304c\u5efa\u8a2d\u7684\u306a\u7dcf\u8a55(200\u5b57)", "best_moment":"\u4e00\u756a\u826f\u304b\u3063\u305f\u77ac\u9593", "ideal":"\u5f31\u70b9\u30b7\u30fc\u30f3\u3067\u306e\u7406\u60f3\u30c8\u30fc\u30af\u4f8b(1-2\u6587)", "timeline":[{"time":"\u958b\u59cb\u304b\u3089\u306e\u79d2\u6570\u76ee\u5b89","event":"\u4f55\u304c\u8d77\u304d\u305f\u304b","evaluation":"\u826f\u3044/\u60aa\u3044/\u666e\u901a","comment":"\u4e00\u8a00"}] }`;

  try{
    const res=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`,{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({contents:[{role:'user',parts:[{text:prompt}]}],generationConfig:{responseMimeType:'application/json',temperature:0}})
    });
    const json=await res.json();
    let raw=json.candidates?.[0]?.content?.parts?.[0]?.text||'{}';
    raw=raw.replace(/```json/g,'').replace(/```/g,'').trim();
    const result=JSON.parse(raw);
    // Normalize sub scores
    if(result.sub){
      const norm={};
      Object.entries(result.sub).forEach(([k,v])=>{
        norm[k]=typeof v==='object'?v:{score:v,evidence:'',deduction:''};
      });
      result.sub=norm;
    }
    showResult(result);
    saveHistory(result);
    saveUsage(result);
  }catch(e){alert('\u63A1\u70B9\u30A8\u30E9\u30FC: '+e.message)}
  document.getElementById('btnGrade').disabled=false;
  document.getElementById('btnGrade').textContent='\u{1F4CA} \u63A1\u70B9';
}

// =========================================================
// RESULT DISPLAY
// =========================================================
function showResult(r){
  document.getElementById('resultScore').textContent=r.total+'\u70B9';
  const sub=Object.entries(r.sub||{}).map(([k,v])=>{
    const sc=typeof v==='object'?v.score:v;
    const ev=typeof v==='object'?v.evidence:'';
    const ded=typeof v==='object'?v.deduction:'';
    return `<div style="margin-bottom:10px">
      <div class="sb-item"><div class="n">${SUB_NAMES[k]||k}</div><div class="bg"><div class="fl" style="width:${(sc/10)*100}%;background:${sc<5?'var(--red)':sc<7?'var(--gold)':'var(--green)'}"></div></div><div class="v">${sc}</div>
      <button onclick="drillWeakPoint('${k}')" style="background:none;border:1px solid var(--accent);color:var(--accent);border-radius:12px;padding:1px 8px;font-size:10px;cursor:pointer;margin-left:4px" title="\u3053\u306e\u5f31\u70b9\u3067\u7df4\u7fd2">\u{1F3AF}</button></div>
      ${ev?`<div style="font-size:10px;color:var(--green);padding-left:80px;margin-top:2px">\u2705 ${ev}</div>`:''}
      ${ded?`<div style="font-size:10px;color:var(--red);padding-left:80px">\u274C ${ded}</div>`:''}
    </div>`;
  }).join('');
  document.getElementById('resultSubScores').innerHTML=sub;
  document.getElementById('resultComment').innerHTML=`<p>${r.feedback||''}</p>`+(r.best_moment?`<p style="margin-top:10px;color:var(--green)">\u2705 ${r.best_moment}</p>`:'');
  if(r.ideal){document.getElementById('idealSection').style.display='block';document.getElementById('idealResponse').textContent=r.ideal}
  if(r.timeline?.length){
    document.getElementById('timelineSection').style.display='block';
    document.getElementById('timelineContent').innerHTML=r.timeline.map(t=>`<div style="margin-bottom:8px;padding:8px;background:var(--surface2);border-radius:8px;font-size:12px"><span style="color:${t.evaluation==='\u826f\u3044'?'var(--green)':t.evaluation==='\u60aa\u3044'?'var(--red)':'var(--text2)'}">${t.evaluation==='\u826f\u3044'?'\u2705':t.evaluation==='\u60aa\u3044'?'\u274C':'\u2796'}</span> <b>${t.event}</b><br><span style="color:var(--text2)">${t.comment}</span></div>`).join('');
  }
  if(r.sub){
    const sorted=Object.entries(r.sub).map(([k,v])=>[k,typeof v==='object'?v.score:v]).sort((a,b)=>a[1]-b[1]);
    const worst3=sorted.slice(0,3);
    document.getElementById('drillSection').style.display='block';
    document.getElementById('drillButtons').innerHTML=worst3.map(([k,sc])=>
      `<button onclick="drillWeakPoint('${k}')" style="display:block;width:100%;margin-bottom:6px;background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);color:#fca5a5;border-radius:8px;padding:8px;font-size:12px;cursor:pointer;text-align:left">\u{1F3AF} ${SUB_NAMES[k]} (${sc}\u70B9) \u3067\u30D4\u30F3\u30DD\u30A4\u30F3\u30C8\u7DF4\u7FD2</button>`
    ).join('');
    document.getElementById('weakPoint').value=worst3[0][0];updateHint();
  }
  document.getElementById('overlay').classList.add('show');
  updateTitle(r.total);
}

function drillWeakPoint(key){
  closeResult();
  document.getElementById('weakPoint').value=key;updateHint();
  const map={anchoring:'price_objection',closing:'closing_3min',hearing:'opening',rapport:'opening'};
  if(map[key])document.getElementById('scenario').value=map[key];
  document.querySelector('.chat-area').scrollIntoView({behavior:'smooth'});
  const btn=document.getElementById('btnStart');
  btn.style.animation='pulse 0.5s 3';setTimeout(()=>btn.style.animation='',2000);
}

function closeResult(){
  document.getElementById('overlay').classList.remove('show');
  ['idealSection','timelineSection','drillSection'].forEach(id=>document.getElementById(id).style.display='none');
}

// =========================================================
// HISTORY
// =========================================================
function saveHistory(r){
  const h=JSON.parse(localStorage.getItem('rp_history')||'[]');
  const subScores={};
  if(r.sub) Object.entries(r.sub).forEach(([k,v])=>subScores[k]=typeof v==='object'?v.score:v);
  h.unshift({date:new Date().toLocaleDateString('ja-JP'),score:r.total,sub:subScores,wp:document.getElementById('weakPoint').value,name:document.getElementById('salesName').value||'?'});
  if(h.length>50)h.length=50;
  localStorage.setItem('rp_history',JSON.stringify(h));
  loadHistory();updateStreak();
}
function loadHistory(){
  const h=JSON.parse(localStorage.getItem('rp_history')||'[]');
  const el=document.getElementById('historyList');
  if(!h.length){el.innerHTML='<span style="font-size:11px;color:var(--text2)">\u307E\u3060\u5C65\u6B74\u306A\u3057</span>';return}
  el.innerHTML=h.slice(0,10).map(i=>`<div class="history-item"><span>${i.date} ${i.name}</span><span class="hs">${i.score}\u70B9</span></div>`).join('');
  if(h.length&&h[0].sub){
    Object.entries(h[0].sub).forEach(([k,v])=>{
      const bar=document.getElementById('bar_'+k);
      const val=document.getElementById('val_'+k);
      if(bar&&val){bar.style.width=(v/10*100)+'%';val.textContent=v;}
    });
  }
}

// =========================================================
// USAGE TRACKING + GAS POST
// =========================================================
function saveUsage(r){
  const usage=JSON.parse(localStorage.getItem('rp_usage')||'[]');
  const dur=startTime?Math.floor((Date.now()-startTime)/1000):0;
  const subScores={};
  if(r.sub) Object.entries(r.sub).forEach(([k,v])=>subScores[k]=typeof v==='object'?v.score:v);
  const entry={
    name:document.getElementById('salesName').value||'\u672A\u8A2D\u5B9A',
    date:new Date().toISOString(),
    month:new Date().toLocaleDateString('ja-JP',{year:'numeric',month:'2-digit'}),
    score:r.total, sub:subScores,
    duration:dur,
    scenario:document.getElementById('scenario').value,
    weakPoint:document.getElementById('weakPoint').value
  };
  usage.push(entry);
  localStorage.setItem('rp_usage',JSON.stringify(usage));
  // POST to GAS if configured
  postUsageToGAS(entry);
}

async function postUsageToGAS(data){
  const gasUrl=document.getElementById('gasUrl').value.trim();
  if(!gasUrl)return;
  try{
    await fetch(gasUrl,{
      method:'POST',
      headers:{'Content-Type':'text/plain'},
      body:JSON.stringify(data),
      mode:'no-cors'
    });
    console.log('Usage posted to GAS');
  }catch(e){console.warn('GAS POST failed:',e)}
}

function showUsageDashboard(){
  const usage=JSON.parse(localStorage.getItem('rp_usage')||'[]');
  const months=[...new Set(usage.map(u=>u.month))].sort().reverse();
  const sel=document.getElementById('usageMonth');
  const cur=new Date().toLocaleDateString('ja-JP',{year:'numeric',month:'2-digit'});
  if(!months.length)months.push(cur);
  sel.innerHTML=months.map(m=>`<option>${m}</option>`).join('');
  renderUsageDashboard();
  document.getElementById('usageOverlay').classList.add('show');
}

function renderUsageDashboard(){
  const usage=JSON.parse(localStorage.getItem('rp_usage')||'[]');
  const month=document.getElementById('usageMonth').value;
  const filtered=usage.filter(u=>u.month===month);
  const byName={};
  filtered.forEach(u=>{
    if(!byName[u.name])byName[u.name]={count:0,totalScore:0,totalDur:0,lastDate:''};
    byName[u.name].count++;
    byName[u.name].totalScore+=u.score||0;
    byName[u.name].totalDur+=u.duration||0;
    byName[u.name].lastDate=u.date?.split('T')[0]||'';
  });
  let html='<table style="width:100%;border-collapse:collapse;font-size:12px">';
  html+='<tr style="border-bottom:1px solid var(--border)"><th style="text-align:left;padding:6px">\u62C5\u5F53\u8005</th><th>\u56DE\u6570</th><th>\u5E73\u5747\u70B9</th><th>\u5408\u8A08\u6642\u9593</th><th>\u6700\u7D42</th></tr>';
  Object.entries(byName).sort((a,b)=>b[1].count-a[1].count).forEach(([name,d])=>{
    const avg=d.count?(d.totalScore/d.count).toFixed(1):'--';
    const mins=Math.floor(d.totalDur/60);
    html+=`<tr style="border-bottom:1px solid var(--border)"><td style="padding:6px;font-weight:600">${name}</td><td style="text-align:center">${d.count}\u56DE</td><td style="text-align:center;color:${avg>=70?'var(--green)':avg>=50?'var(--gold)':'var(--red)'}">${avg}</td><td style="text-align:center">${mins}\u5206</td><td style="text-align:center;font-size:10px">${d.lastDate}</td></tr>`;
  });
  if(!Object.keys(byName).length)html+='<tr><td colspan="5" style="text-align:center;padding:20px;color:var(--text2)">\u307E\u3060\u30C7\u30FC\u30BF\u306A\u3057</td></tr>';
  html+='</table>';
  document.getElementById('usageTable').innerHTML=html;
  // Render score trend chart
  renderScoreChart(filtered);
}

function exportUsageCSV(){
  const usage=JSON.parse(localStorage.getItem('rp_usage')||'[]');
  const month=document.getElementById('usageMonth').value;
  const filtered=usage.filter(u=>u.month===month);
  let csv='\u62C5\u5F53\u8005,\u65E5\u6642,\u30B9\u30B3\u30A2,\u6642\u9593(\u79D2),\u30B7\u30CA\u30EA\u30AA,\u5F31\u70B9\n';
  filtered.forEach(u=>csv+=`${u.name},${u.date},${u.score},${u.duration},${u.scenario},${u.weakPoint}\n`);
  const blob=new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`roleplay_usage_${month}.csv`;a.click();
}

// =========================================================
// SCORE TREND CHART (Chart.js)
// =========================================================
function renderScoreChart(data){
  const canvas=document.getElementById('scoreChart');
  if(!canvas)return;
  if(!data||!data.length){
    if(window._scoreChart){window._scoreChart.destroy();window._scoreChart=null}
    return;
  }
  // Group by person
  const byPerson={};
  data.forEach(u=>{
    if(!byPerson[u.name])byPerson[u.name]=[];
    byPerson[u.name].push({date:u.date?.split('T')[0]||'',score:u.score});
  });
  // All unique dates sorted
  const allDates=[...new Set(data.map(u=>u.date?.split('T')[0]||''))].sort();
  const colors=['#4f6ef7','#7c3aed','#22c55e','#f59e0b','#ef4444','#06b6d4','#ec4899','#8b5cf6'];
  const datasets=Object.entries(byPerson).map(([name,entries],i)=>{
    const dateMap={};
    entries.forEach(e=>{
      if(!dateMap[e.date])dateMap[e.date]=[];
      dateMap[e.date].push(e.score);
    });
    return{
      label:name,
      data:allDates.map(d=>{
        const scores=dateMap[d];
        if(!scores)return null;
        return Math.round(scores.reduce((a,b)=>a+b,0)/scores.length);
      }),
      borderColor:colors[i%colors.length],
      backgroundColor:colors[i%colors.length]+'33',
      tension:0.3,
      pointRadius:5,
      pointHoverRadius:7,
      spanGaps:true,
      fill:false
    };
  });
  if(window._scoreChart)window._scoreChart.destroy();
  window._scoreChart=new Chart(canvas,{
    type:'line',
    data:{labels:allDates,datasets},
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{labels:{color:'#e2e8f0',font:{size:11}}},
        title:{display:true,text:'\u30B9\u30B3\u30A2\u63A8\u79FB',color:'#e2e8f0',font:{size:13}}
      },
      scales:{
        x:{ticks:{color:'#94a3b8',font:{size:10},maxRotation:45},grid:{color:'#2a2f40'}},
        y:{min:0,max:100,ticks:{color:'#94a3b8',stepSize:20},grid:{color:'#2a2f40'}}
      }
    }
  });
}

// =========================================================
// GAS INTEGRATION (fetch loss data)
// =========================================================
async function fetchLossData(){
  const url=document.getElementById('gasUrl').value.trim();
  if(!url){alert('GAS Web App URL\u3092\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044');return}
  localStorage.setItem('rp_gasUrl',url);
  try{
    const res=await fetch(url);
    const data=await res.json();
    const sel=document.getElementById('lossSelect');
    sel.style.display='block';
    sel.innerHTML='<option value="">\u5931\u6CE8\u5546\u8AC7\u3092\u9078\u629E...</option>'+
      data.map((d,i)=>`<option value="${i}">${d.date} ${d.name} ${d.result} ${d.score}\u70B9 - ${d.bad_cause||''}</option>`).join('');
    sel.onchange=()=>{
      const idx=sel.value;if(idx==='')return;
      const d=data[Number(idx)];
      document.getElementById('persona').value='custom';
      document.getElementById('customPersonaBox').style.display='block';
      document.getElementById('customTranscript').value=`\u3010\u62C5\u5F53\u3011${d.name}\n\u3010\u7D50\u679C\u3011${d.result}\n\u3010\u30B9\u30B3\u30A2\u3011${d.score}\u70B9\n\u3010\u6700\u5927\u306E\u6E1B\u70B9\u8981\u56E0\u3011${d.bad_cause||''}\n\u3010\u7DCF\u8A55\u3011${d.summary||''}\n\u3010\u30B9\u30AD\u30EB\u5185\u8A33\u3011\u6A29\u5A01\u6027:${d.sub?.authority||'-'} \u640D\u5931\u56DE\u907F:${d.sub?.loss_aversion||'-'} RF:${d.sub?.reframing||'-'} \u30A2\u30F3\u30AB\u30FC:${d.sub?.anchoring||'-'} CL:${d.sub?.closing||'-'}`;
      if(d.sub){
        const worst=Object.entries(d.sub).sort((a,b)=>Number(a[1])-Number(b[1]))[0];
        if(worst&&document.getElementById('weakPoint').querySelector(`option[value="${worst[0]}"]`)){
          document.getElementById('weakPoint').value=worst[0];updateHint();
        }
      }
    };
  }catch(e){alert('GAS\u53D6\u5F97\u30A8\u30E9\u30FC: '+e.message)}
}
(function(){const u=localStorage.getItem('rp_gasUrl');if(u)document.getElementById('gasUrl').value=u}());

// =========================================================
// STREAK & TITLE
// =========================================================
function updateStreak(){
  const h=JSON.parse(localStorage.getItem('rp_history')||'[]');
  if(!h.length){document.getElementById('streakBadge').innerHTML='';return}
  const days=new Set(h.map(i=>i.date));
  let streak=0;let d=new Date();
  while(days.has(d.toLocaleDateString('ja-JP'))){streak++;d.setDate(d.getDate()-1)}
  document.getElementById('streakBadge').innerHTML=streak>=2?`<span class="streak-badge">\u{1F525} ${streak}\u65E5\u9023\u7D9A</span>`:'';
}

function updateTitle(score){
  const h=JSON.parse(localStorage.getItem('rp_history')||'[]');
  const recent3=h.slice(0,3).map(i=>i.score);
  let title='';
  if(recent3.length>=3&&recent3.every(s=>s>=80))title='\u{1F947} \u30B4\u30FC\u30EB\u30C9\u30AF\u30ED\u30FC\u30B6\u30FC';
  else if(score>=80)title='\u{1F948} \u30B7\u30EB\u30D0\u30FC\u30AF\u30ED\u30FC\u30B6\u30FC';
  else if(score>=65)title='\u{1F949} \u30D6\u30ED\u30F3\u30BA\u30AF\u30ED\u30FC\u30B6\u30FC';
  document.getElementById('titleBadge').innerHTML=title?`<span class="title-badge">${title}</span>`:'';
}
</script>
</body>
</html>